<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äºŒæ‰‹äº¤æ˜“ - æ¿¬ç‘’æˆ¿ç”¢ç”Ÿæ´»å¹³å°</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --grad: linear-gradient(135deg, #10b981, #059669);
}
.glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.06); border-radius: 1rem; }
.btn { background: var(--grad); color: #fff; padding: 0.6rem 1rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
.input { width: 100%; padding: .65rem .8rem; border: 1px solid #e5e7eb; border-radius: .75rem; }
.card { background: #fff; border: 1px solid #e5e7eb; border-radius: .75rem; padding: 1rem; }
/* å½ˆçª—æ¨£å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 1rem;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: slideUp 0.3s ease-out;
}
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #f3f4f6;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.modal-close:hover {
  background: #e5e7eb;
}
/* æ–°å¢æŒ‰éˆ• */
.add-button {
  position: fixed;
  bottom: 5rem;
  right: 1rem;
  background: var(--grad);
  color: white;
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  z-index: 100;
  transition: transform 0.2s;
}
.add-button:hover {
  transform: scale(1.1);
}
/* åœ–ç‰‡é è¦½å€åŸŸ */
.image-preview-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.image-preview-item {
  position: relative;
  aspect-ratio: 1;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 2px solid #e5e7eb;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.image-preview-item .remove-btn {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* åœ–ç‰‡è¼ªæ’­ */
.image-carousel {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 0.5rem;
  overflow: hidden;
  background: #f3f4f6;
}
.image-carousel img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}
.image-carousel img.active {
  display: block;
}
.carousel-nav {
  position: absolute;
  bottom: 0.5rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.25rem;
}
.carousel-dot {
  width: 0.5rem;
  height: 0.5rem;
  border-radius: 50%;
  background: rgba(255,255,255,0.5);
  cursor: pointer;
  transition: background 0.2s;
}
.carousel-dot.active {
  background: white;
}
.carousel-prev, .carousel-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}
.carousel-prev {
  left: 0.5rem;
}
.carousel-next {
  right: 0.5rem;
}
/* Toast é€šçŸ¥ */
.toast {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: #1f2937;
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  z-index: 2000;
  transform: translateX(400px);
  transition: transform 0.3s ease-out;
  max-width: 300px;
}
.toast.show {
  transform: translateX(0);
}
.toast.success {
  background: #10b981;
}
.toast.error {
  background: #ef4444;
}
.toast.warning {
  background: #f59e0b;
}
/* æœå°‹æ¡† */
.search-container {
  position: sticky;
  top: 0;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  padding: 1rem;
  margin: -1rem -1rem 1rem -1rem;
  border-bottom: 1px solid #e5e7eb;
  z-index: 10;
}
/* å‰©é¤˜å¤©æ•¸æ¨™ç±¤ */
.expires-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
}
.expires-badge.warning {
  background: #fef3c7;
  color: #92400e;
}
.expires-badge.danger {
  background: #fee2e2;
  color: #991b1b;
}
.expires-badge.success {
  background: #d1fae5;
  color: #065f46;
}
</style>
</head>
<body class="bg-gradient-to-b from-emerald-50 to-white">

<header class="text-center py-6 text-white relative" style="background: var(--grad)">
  <h1 class="text-2xl md:text-3xl font-extrabold">â™»ï¸ äºŒæ‰‹äº¤æ˜“</h1>
  <p class="opacity-90 text-sm mt-1">åˆŠç™»äºŒæ‰‹ç‰©å“ï¼Œé™„ä¸Šç…§ç‰‡ã€è¯çµ¡äººèˆ‡é›»è©±</p>
</header>

<main class="max-w-3xl mx-auto p-4 space-y-6 pb-20">
  <!-- æœå°‹æ¡† -->
  <div class="search-container">
    <input 
      type="text" 
      id="searchInput" 
      class="input" 
      placeholder="ğŸ” æœå°‹ç‰©å“åç¨±ã€è¯çµ¡äºº..."
      oninput="handleSearch()"
    >
  </div>
  
  <!-- åˆŠç™»åˆ—è¡¨ -->
  <section class="space-y-3" id="listContainer" aria-live="polite"></section>
</main>

<!-- æ–°å¢åˆŠç™»æŒ‰éˆ• -->
<button class="add-button" onclick="openModal()" aria-label="æ–°å¢åˆŠç™»" title="æ–°å¢åˆŠç™»">
  â•
</button>

<!-- åˆŠç™»è¡¨å–®å½ˆçª— -->
<div id="modalOverlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
  <div class="modal-content glass-card p-4 md:p-6" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()" aria-label="é—œé–‰">âœ•</button>
    <h2 class="text-lg font-bold mb-4">ğŸ“ æ–°å¢åˆŠç™»</h2>
    <form id="listingForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">ç‰©å“åç¨± <span class="text-red-500">*</span></label>
          <input id="itemTitle" type="text" class="input" placeholder="ä¾‹å¦‚ï¼šIKEA æ¡Œå­" maxlength="50" required>
          <p class="text-xs text-gray-500 mt-1">æœ€å¤š50å­—</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">è¯çµ¡äºº <span class="text-red-500">*</span></label>
          <input id="contactName" type="text" class="input" placeholder="æ‚¨çš„ç¨±å‘¼" maxlength="20" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">è¯çµ¡é›»è©± <span class="text-red-500">*</span></label>
          <input id="contactPhone" type="tel" class="input" placeholder="09xx-xxx-xxx" pattern="09\d{8}" required>
          <p class="text-xs text-gray-500 mt-1">æ ¼å¼ï¼š09xx-xxx-xxx</p>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">ç…§ç‰‡ä¸Šå‚³ï¼ˆæœ€å¤š5å¼µï¼‰</label>
        <input id="imageFile" type="file" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="input">
        <p class="text-xs text-gray-500 mt-1">æ”¯æ´ JPGã€PNGã€WebPï¼Œæ¯å¼µæœ€å¤§ 5MB</p>
        <div id="imagePreviewContainer" class="image-preview-container"></div>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-1">ç‰©å“æè¿°</label>
        <textarea id="itemDesc" class="input" rows="3" placeholder="ç‹€æ³ã€å°ºå¯¸ã€åƒ¹æ ¼ã€å–è²¨åœ°é»ç­‰" maxlength="500"></textarea>
        <p class="text-xs text-gray-500 mt-1">æœ€å¤š500å­—</p>
      </div>
      
      <div class="flex items-center gap-3">
        <button type="submit" class="btn">ç™¼å¸ƒ</button>
        <button type="button" onclick="closeModal()" class="px-3 py-2 rounded-lg border text-sm">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div id="toast" class="toast"></div>

<!-- ğŸ“ åº•éƒ¨å°èˆªï¼ˆèˆ‡ä¸»é ä¸€è‡´ï¼‰ -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 flex justify-around py-2 bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
  <button onclick="window.location.href='index.html'" class="flex flex-col items-center text-indigo-600 text-xs hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="å›åˆ°é¦–é ">
    <span>ğŸ </span><span>é¦–é </span>
  </button>
  <button onclick="openTool('investor.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æŠ•è³‡å°ˆå€">
    <span>ğŸ’°</span><span>æŠ•è³‡</span>
  </button>
  <button onclick="openTool('games.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="éŠæˆ²å¤§å»³">
    <span>ğŸ®</span><span>éŠæˆ²</span>
  </button>
  <button onclick="window.location.href='https://flyjung168.pages.dev/'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æˆ¿è¨Š">
    <span>ğŸ¹</span><span>æˆ¿è¨Š</span>
  </button>
  <button onclick="openTool('analytics.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æ•¸æ“šåˆ†æ">
    <span>ğŸ“Š</span><span>åˆ†æ</span>
  </button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Google Sheets API è¨­å®šï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰ =====
const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbyUPdvrgShpbwBI888Mw5JRNb8vEsBsPgw7VmLlGbTv1mdlD-blH0h-NZ6sSTpq0g1oqA/exec';
let useGoogleSheets = false;

if (GOOGLE_SHEETS_API_URL && GOOGLE_SHEETS_API_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
  useGoogleSheets = true;
  console.log('âœ… Google Sheets API å·²è¨­å®š');
}

// ===== Supabase è¨­å®šï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰ =====
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

let supabase = null;
let useSupabase = false;

try {
  if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    useSupabase = true;
    console.log('âœ… Supabase å·²åˆå§‹åŒ–');
  }
} catch (err) {
  console.error('âŒ Supabase åˆå§‹åŒ–å¤±æ•—:', err);
}

// ===== å…¨åŸŸè®Šæ•¸ =====
let allListings = []; // å„²å­˜æ‰€æœ‰åˆŠç™»ï¼ˆç”¨æ–¼æœå°‹ï¼‰
let selectedImages = []; // å„²å­˜é¸ä¸­çš„åœ–ç‰‡ï¼ˆbase64ï¼‰
let currentSearchQuery = '';

// ===== å·¥å…·å‡½å¼ =====
function openTool(url) {
  if (url.startsWith('http')) {
    window.open(url, '_blank', 'noopener,noreferrer');
  } else {
    window.location.href = url;
  }
}

// Toast é€šçŸ¥
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// é©—è­‰é›»è©±æ ¼å¼
function validatePhone(phone) {
  const cleaned = phone.replace(/[-\s]/g, '');
  return /^09\d{8}$/.test(cleaned);
}

// é©—è­‰åœ–ç‰‡å¤§å°ï¼ˆ5MBï¼‰
function validateImageSize(file) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  return file.size <= maxSize;
}

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
function getDaysRemaining(expiresAt) {
  if (!expiresAt) return null;
  const expires = new Date(expiresAt);
  const now = new Date();
  const diff = expires - now;
  const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
  return days;
}

// æ ¼å¼åŒ–å‰©é¤˜å¤©æ•¸é¡¯ç¤º
function formatDaysRemaining(days) {
  if (days === null || days === undefined) return '';
  if (days < 0) return { text: 'å·²éæœŸ', class: 'danger' };
  if (days <= 3) return { text: `å‰©é¤˜ ${days} å¤©`, class: 'danger' };
  if (days <= 7) return { text: `å‰©é¤˜ ${days} å¤©`, class: 'warning' };
  return { text: `å‰©é¤˜ ${days} å¤©`, class: 'success' };
}

// ===== åœ–ç‰‡é è¦½ç®¡ç† =====
function setupImagePreview() {
  const fileInput = document.getElementById('imageFile');
  const previewContainer = document.getElementById('imagePreviewContainer');
  
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    
    // æª¢æŸ¥æ•¸é‡é™åˆ¶
    if (files.length + selectedImages.length > 5) {
      showToast('æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µç…§ç‰‡', 'error');
      fileInput.value = '';
      return;
    }
    
    // è™•ç†æ¯å€‹æª”æ¡ˆ
    files.forEach(file => {
      // é©—è­‰æª”æ¡ˆå¤§å°
      if (!validateImageSize(file)) {
        showToast(`${file.name} æª”æ¡ˆéå¤§ï¼ˆä¸Šé™ 5MBï¼‰`, 'error');
        return;
      }
      
      // é©—è­‰æª”æ¡ˆæ ¼å¼
      if (!file.type.startsWith('image/')) {
        showToast(`${file.name} æ ¼å¼ä¸ç¬¦ï¼ˆåƒ…æ”¯æ´åœ–ç‰‡ï¼‰`, 'error');
        return;
      }
      
      // è®€å–ç‚º base64
      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        const imageData = {
          file: file,
          base64: base64,
          id: Date.now() + Math.random()
        };
        
        selectedImages.push(imageData);
        renderImagePreview();
      };
      reader.readAsDataURL(file);
    });
    
    // æ¸…ç©º inputï¼ˆå…è¨±é‡é¸åŒä¸€æª”æ¡ˆï¼‰
    fileInput.value = '';
  });
}

function renderImagePreview() {
  const container = document.getElementById('imagePreviewContainer');
  container.innerHTML = '';
  
  selectedImages.forEach((imgData, index) => {
    const item = document.createElement('div');
    item.className = 'image-preview-item';
    item.innerHTML = `
      <img src="${imgData.base64}" alt="é è¦½ ${index + 1}">
      <button type="button" class="remove-btn" onclick="removeImagePreview(${index})">Ã—</button>
    `;
    container.appendChild(item);
  });
  
  // é¡¯ç¤ºå‰©é¤˜å¯ä¸Šå‚³æ•¸é‡
  if (selectedImages.length > 0) {
    const remaining = 5 - selectedImages.length;
    const hint = document.createElement('div');
    hint.className = 'text-xs text-gray-500 mt-2';
    hint.textContent = `å·²é¸ ${selectedImages.length} å¼µï¼Œé‚„å¯ä¸Šå‚³ ${remaining} å¼µ`;
    container.appendChild(hint);
  }
}

function removeImagePreview(index) {
  selectedImages.splice(index, 1);
  renderImagePreview();
}

// ===== è³‡æ–™è®€å–èˆ‡å„²å­˜ =====
const STORAGE_KEY = 'secondHandListings_v1';
function readListingsLocal() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
}
function writeListingsLocal(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

async function readListings() {
  if (useGoogleSheets) {
    try {
      // æª¢æŸ¥æ˜¯å¦ç‚º file:// å”è­°ï¼ˆæœƒå°è‡´ CORS éŒ¯èª¤ï¼‰
      if (window.location.protocol === 'file:') {
        console.warn('âš ï¸ åµæ¸¬åˆ° file:// å”è­°ï¼Œå¯èƒ½æœƒæœ‰ CORS å•é¡Œã€‚å»ºè­°ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿã€‚');
        // é™ç´šåˆ° localStorage
        return readListingsLocal();
      }

      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'GET',
        mode: 'cors'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (result.ok && result.list) {
        return result.list;
      }
      throw new Error(result.error || 'è®€å–å¤±æ•—');
    } catch (err) {
      console.error('è®€å– Google Sheets å¤±æ•—:', err);
      
      // å¦‚æœæ˜¯ CORS éŒ¯èª¤ï¼Œé™ç´šåˆ° localStorage ä¸¦é¡¯ç¤ºæç¤º
      if (err.message && (err.message.includes('CORS') || err.message.includes('fetch'))) {
        console.warn('âš ï¸ è®€å–å¤±æ•—ï¼Œæ”¹ç”¨ localStorageã€‚è«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢ã€‚');
        return readListingsLocal();
      }
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) throw error;
      return (data || []).map(item => ({
        id: item.id,
        title: item.title,
        name: item.contact_name,
        phone: item.contact_phone,
        images: item.image_url ? [item.image_url] : [],
        imageUrl: item.image_url || '',
        desc: item.description,
        createdAt: new Date(item.created_at).getTime(),
        expiresAt: null
      }));
    } catch (err) {
      console.error('è®€å– Supabase å¤±æ•—:', err);
    }
  }
  
  return readListingsLocal();
}

async function addListing(listing, imageBase64List = []) {
  if (useGoogleSheets) {
    try {
      const payload = {
        title: listing.title,
        contact_name: listing.name,
        contact_phone: listing.phone,
        description: listing.desc || '',
        imageUrls: listing.imageUrls || [],
        imageBase64List: imageBase64List
      };

      // æª¢æŸ¥æ˜¯å¦ç‚º file:// å”è­°ï¼ˆæœƒå°è‡´ CORS éŒ¯èª¤ï¼‰
      if (window.location.protocol === 'file:') {
        throw new Error('CORS_ERROR: è«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢ï¼Œä¸è¦ç›´æ¥é–‹å•Ÿæª”æ¡ˆã€‚è©³è¦‹æ§åˆ¶å°èªªæ˜ã€‚');
      }

      // ä½¿ç”¨ Google Apps Script Web App çš„æ­£ç¢ºæ–¹å¼
      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        mode: 'cors', // æ˜ç¢ºæŒ‡å®š CORS æ¨¡å¼
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      if (result.ok) {
        return result;
      }
      throw new Error(result.error || 'æ–°å¢å¤±æ•—');
    } catch (err) {
      console.error('æ–°å¢åˆ° Google Sheets å¤±æ•—:', err);
      
      // å¦‚æœæ˜¯ CORS éŒ¯èª¤ï¼Œé¡¯ç¤ºå‹å–„æç¤º
      if (err.message && err.message.includes('CORS')) {
        console.error(`
âš ï¸ CORS éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆï¼š
1. ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤ HTMLï¼ˆä¸è¦ç›´æ¥ç”¨æª”æ¡ˆé–‹å•Ÿï¼‰
   
   æ–¹æ³• A - VS Codeï¼š
   - å®‰è£ "Live Server" æ“´å……åŠŸèƒ½
   - å³éµé»æ“Š second-hand.html â†’ "Open with Live Server"
   
   æ–¹æ³• B - Pythonï¼š
   - åœ¨å°ˆæ¡ˆè³‡æ–™å¤¾é–‹å•Ÿçµ‚ç«¯æ©Ÿ
   - åŸ·è¡Œï¼špython -m http.server 8000
   - ç€è¦½å™¨é–‹å•Ÿï¼šhttp://localhost:8000/second-hand.html
   
   æ–¹æ³• C - Node.jsï¼š
   - åŸ·è¡Œï¼šnpx http-server
   - ç€è¦½å™¨é–‹å•Ÿæç¤ºçš„ç¶²å€
        `);
        throw new Error('è«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢ï¼ˆä¸è¦ç›´æ¥ç”¨æª”æ¡ˆé–‹å•Ÿï¼‰');
      }
      
      throw err;
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .insert([{
          title: listing.title,
          contact_name: listing.name,
          contact_phone: listing.phone,
          image_url: listing.imageUrl || null,
          description: listing.desc || null
        }])
        .select();
      if (error) throw error;
      return data && data[0];
    } catch (err) {
      console.error('æ–°å¢åˆ° Supabase å¤±æ•—:', err);
    }
  }
  
  const list = readListingsLocal();
  list.unshift(listing);
  writeListingsLocal(list);
  return listing;
}

async function removeListingById(id) {
  if (useGoogleSheets) {
    try {
      // æª¢æŸ¥æ˜¯å¦ç‚º file:// å”è­°
      if (window.location.protocol === 'file:') {
        console.warn('âš ï¸ file:// å”è­°ç„¡æ³•ä½¿ç”¨é›²ç«¯åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿ');
        return false;
      }

      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'delete', id: id }),
        redirect: 'follow'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if (result.ok) return true;
    } catch (err) {
      console.error('å¾ Google Sheets åˆªé™¤å¤±æ•—:', err);
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { error } = await supabase.from('second_hand_listings').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) {
      console.error('å¾ Supabase åˆªé™¤å¤±æ•—:', err);
    }
  }
  
  return false;
}

// ===== åœ–ç‰‡è¼ªæ’­åŠŸèƒ½ =====
function initImageCarousel(containerId, images) {
  if (!images || images.length === 0) return;
  
  let currentIndex = 0;
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const imgElements = container.querySelectorAll('img');
  const dots = container.querySelectorAll('.carousel-dot');
  
  function showImage(index) {
    imgElements.forEach((img, i) => {
      img.classList.toggle('active', i === index);
    });
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
  }
  
  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
  }
  
  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
  }
  
  container.querySelector('.carousel-next')?.addEventListener('click', nextImage);
  container.querySelector('.carousel-prev')?.addEventListener('click', prevImage);
  
  dots.forEach((dot, i) => {
    dot.addEventListener('click', () => {
      currentIndex = i;
      showImage(currentIndex);
    });
  });
  
  showImage(0);
}

// ===== æ¸²æŸ“åˆŠç™»åˆ—è¡¨ =====
async function renderListings(filteredList = null) {
  const container = document.getElementById('listContainer');
  container.innerHTML = '<div class="text-center text-sm text-gray-500">è¼‰å…¥ä¸­...</div>';
  
  try {
    let list = filteredList || await readListings();
    allListings = list; // å„²å­˜ç”¨æ–¼æœå°‹
    
    // éæ¿¾éæœŸé …ç›®ï¼ˆå‰ç«¯éæ¿¾ï¼‰
    const now = Date.now();
    list = list.filter(item => {
      if (!item.expiresAt) return true;
      const expires = new Date(item.expiresAt).getTime();
      return expires > now;
    });
    
    if (list.length === 0) {
      container.innerHTML = '<div class="text-center text-sm text-gray-500">å°šç„¡åˆŠç™»ï¼Œå¿«ä¾†æˆç‚ºç¬¬ä¸€ä½ï¼</div>';
      return;
    }
    
    container.innerHTML = list.map((it, idx) => {
      const images = it.images || (it.imageUrl ? [it.imageUrl] : []);
      const daysRemaining = getDaysRemaining(it.expiresAt);
      const daysInfo = formatDaysRemaining(daysRemaining);
      const carouselId = `carousel-${it.id || idx}`;
      
      return `
        <div class="card">
          <div class="flex gap-3 items-start">
            ${images.length > 0 ? `
              <div class="w-32 h-32 flex-shrink-0">
                ${images.length === 1 ? `
                  <img src="${images[0]}" class="w-full h-full object-cover rounded" alt="${it.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Crect width=\\'100\\' height=\\'100\\' fill=\\'%23e5e7eb\\'/%3E%3Ctext x=\\'50\\' y=\\'50\\' text-anchor=\\'middle\\' fill=\\'%239ca3af\\'%3Eç„¡åœ–%3C/text%3E%3C/svg%3E'">
                ` : `
                  <div id="${carouselId}" class="image-carousel">
                    ${images.map((img, i) => `<img src="${img}" alt="${it.title} ${i+1}" class="${i === 0 ? 'active' : ''}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Crect width=\\'100\\' height=\\'100\\' fill=\\'%23e5e7eb\\'/%3E%3Ctext x=\\'50\\' y=\\'50\\' text-anchor=\\'middle\\' fill=\\'%239ca3af\\'%3Eç„¡åœ–%3C/text%3E%3C/svg%3E'">`).join('')}
                    ${images.length > 1 ? `
                      <button class="carousel-prev">â€¹</button>
                      <button class="carousel-next">â€º</button>
                      <div class="carousel-nav">
                        ${images.map((_, i) => `<div class="carousel-dot ${i === 0 ? 'active' : ''}"></div>`).join('')}
                      </div>
                    ` : ''}
                  </div>
                `}
              </div>
            ` : `
              <div class="w-32 h-32 bg-gray-100 rounded flex items-center justify-center text-gray-400 flex-shrink-0">
                ç„¡åœ–
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg">${escapeHtml(it.title)}</div>
              ${daysInfo ? `<span class="expires-badge ${daysInfo.class}">${daysInfo.text}</span>` : ''}
              <div class="text-sm text-gray-600 mt-1">${escapeHtml(it.desc || '')}</div>
              <div class="text-sm mt-2">
                ğŸ‘¤ ${escapeHtml(it.name)}ã€€ğŸ“ <a href="tel:${it.phone}" class="text-emerald-600">${escapeHtml(it.phone)}</a>
              </div>
            </div>
            <button class="text-xs text-red-600 hover:text-red-700 px-2 py-1" onclick="removeListing('${it.id || it.createdAt}')">åˆªé™¤</button>
          </div>
        </div>
      `;
    }).join('');
    
    // åˆå§‹åŒ–æ‰€æœ‰è¼ªæ’­
    list.forEach((it, idx) => {
      const images = it.images || (it.imageUrl ? [it.imageUrl] : []);
      if (images.length > 1) {
        const carouselId = `carousel-${it.id || idx}`;
        setTimeout(() => initImageCarousel(carouselId, images), 100);
      }
    });
    
  } catch (err) {
    console.error('æ¸²æŸ“åˆ—è¡¨å¤±æ•—:', err);
    container.innerHTML = '<div class="text-center text-sm text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function removeListing(idOrIndex) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åˆŠç™»å—ï¼Ÿ')) return;
  
  if (useGoogleSheets || (useSupabase && supabase) && typeof idOrIndex !== 'number') {
    const success = await removeListingById(idOrIndex);
    if (success) {
      showToast('å·²åˆªé™¤åˆŠç™»', 'success');
      await renderListings();
      return;
    }
  }
  
  const list = readListingsLocal();
  const index = typeof idOrIndex === 'number' 
    ? idOrIndex 
    : list.findIndex(item => (item.id && item.id.toString() === idOrIndex) || item.createdAt.toString() === idOrIndex);
  
  if (index >= 0) {
    list.splice(index, 1);
    writeListingsLocal(list);
    await renderListings();
    showToast('å·²åˆªé™¤åˆŠç™»', 'success');
  }
}

// ===== æœå°‹åŠŸèƒ½ =====
function handleSearch() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  currentSearchQuery = query;
  
  if (!query) {
    renderListings();
    return;
  }
  
  const filtered = allListings.filter(item => {
    return item.title.toLowerCase().includes(query) ||
           item.name.toLowerCase().includes(query) ||
           (item.desc && item.desc.toLowerCase().includes(query)) ||
           item.phone.includes(query);
  });
  
  renderListings(filtered);
}

// ===== å½ˆçª—æ§åˆ¶ =====
function openModal() {
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('listingForm').reset();
  selectedImages = [];
  renderImagePreview();
}

function closeModalOnOverlay(event) {
  if (event.target.id === 'modalOverlay') {
    closeModal();
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// ===== è¡¨å–®æäº¤ =====
document.getElementById('listingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('itemTitle').value.trim();
  const name = document.getElementById('contactName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim().replace(/[-\s]/g, '');
  const desc = document.getElementById('itemDesc').value.trim();
  
  // é©—è­‰
  if (!title || !name || !phone) {
    showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½', 'error');
    return;
  }
  
  if (title.length > 50) {
    showToast('ç‰©å“åç¨±éé•·ï¼ˆæœ€å¤š50å­—ï¼‰', 'error');
    return;
  }
  
  if (!validatePhone(phone)) {
    showToast('é›»è©±æ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚º 09xx-xxx-xxxï¼‰', 'error');
    return;
  }
  
  if (desc.length > 500) {
    showToast('æè¿°éé•·ï¼ˆæœ€å¤š500å­—ï¼‰', 'error');
    return;
  }
  
  if (selectedImages.length === 0) {
    showToast('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡', 'warning');
    return;
  }

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'ä¸Šå‚³ä¸­...';

  try {
    const imageBase64List = selectedImages.map(img => img.base64);
    
    const listing = {
      title,
      name,
      phone,
      desc: desc || null,
      createdAt: Date.now(),
      imageUrls: []
    };
    
    const result = await addListing(listing, imageBase64List);
    
    showToast('ç™¼å¸ƒæˆåŠŸï¼', 'success');
    e.target.reset();
    selectedImages = [];
    renderImagePreview();
    await renderListings();
    closeModal();
    
    submitBtn.textContent = 'âœ“ å·²ç™¼å¸ƒ';
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }, 1000);
  } catch (err) {
    console.error('æäº¤å¤±æ•—:', err);
    showToast('ç™¼å¸ƒå¤±æ•—ï¼š' + (err.message || 'è«‹ç¨å¾Œå†è©¦'), 'error');
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// ===== åˆå§‹åŒ– =====
setupImagePreview();
renderListings();
</script>

</body>
</html>
