<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>二手交易 - 楊梅人在地生活</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --grad: linear-gradient(135deg, #10b981, #059669);
}
.glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.06); border-radius: 1rem; }
.btn { background: var(--grad); color: #fff; padding: 0.6rem 1rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
.input { width: 100%; padding: .65rem .8rem; border: 1px solid #e5e7eb; border-radius: .75rem; }
.card { background: #fff; border: 1px solid #e5e7eb; border-radius: .75rem; padding: 0.75rem; }
/* 響應式卡片優化 - 更緊湊 */
@media (max-width: 768px) {
  .card {
    padding: 0.65rem;
  }
}
/* 彈窗樣式 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 0.75rem;
  max-width: 650px;
  width: 100%;
  max-height: 95vh;
  overflow-y: auto;
  position: relative;
  animation: slideUp 0.3s ease-out;
}
/* 緊湊表單樣式 - 手機優化 */
.modal-content form {
  font-size: 0.8125rem;
}
.modal-content .input {
  padding: 0.4rem 0.6rem;
  font-size: 0.875rem;
  min-height: 2.25rem;
  width: 100%;
  box-sizing: border-box;
}
.modal-content label {
  font-size: 0.75rem;
  margin-bottom: 0.125rem;
  font-weight: 500;
}
.modal-content .text-xs {
  font-size: 0.65rem;
  margin-top: 0.125rem;
}
.modal-content select.input {
  padding: 0.4rem 1.75rem 0.4rem 0.6rem; /* 右側留更多空間給箭頭 */
  min-width: 0; /* 允許在grid中縮小 */
  width: 100%;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* 售價區域的下拉選單特殊樣式 */
#priceType {
  overflow: visible;
  text-overflow: clip;
  padding-right: 1.75rem;
  white-space: nowrap;
}
.modal-content select.input option {
  white-space: normal;
  padding: 0.25rem 0.5rem;
}
/* 手機版更緊湊 */
@media (max-width: 768px) {
  .modal-content {
    max-height: 98vh;
    border-radius: 0.5rem;
  }
  .modal-content h2 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  .modal-content form {
    font-size: 0.8rem;
  }
  .modal-content .input {
    padding: 0.35rem 0.5rem;
    font-size: 0.875rem;
    min-height: 2rem;
  }
  .modal-content label {
    font-size: 0.7rem;
    margin-bottom: 0.125rem;
  }
}
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #f3f4f6;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.modal-close:hover {
  background: #e5e7eb;
}
/* 新增按鈕 */
.add-button {
  position: fixed;
  bottom: 5rem;
  right: 1rem;
  background: var(--grad);
  color: white;
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  z-index: 100;
  transition: transform 0.2s;
}
.add-button:hover {
  transform: scale(1.1);
}
/* 圖片預覽區域 */
.image-preview-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 0.3rem;
  margin-top: 0.5rem;
}
@media (max-width: 768px) {
  .image-preview-container {
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
    gap: 0.25rem;
  }
}
.image-preview-item {
  position: relative;
  aspect-ratio: 1;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 2px solid #e5e7eb;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.image-preview-item .remove-btn {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* 圖片輪播 */
.image-carousel {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 0.5rem;
  overflow: hidden;
  background: #f3f4f6;
}
.image-carousel img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}
.image-carousel img.active {
  display: block;
}
.carousel-nav {
  position: absolute;
  bottom: 0.5rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.25rem;
}
.carousel-dot {
  width: 0.5rem;
  height: 0.5rem;
  border-radius: 50%;
  background: rgba(255,255,255,0.5);
  cursor: pointer;
  transition: background 0.2s;
}
.carousel-dot.active {
  background: white;
}
.carousel-prev, .carousel-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}
.carousel-prev {
  left: 0.5rem;
}
.carousel-next {
  right: 0.5rem;
}
/* 圖片燈箱 */
.lightbox-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 2rem;
}
.lightbox-overlay.active {
  display: flex;
}
.lightbox-container {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.lightbox-image {
  max-width: 100%;
  max-height: 90vh;
  object-fit: contain;
  border-radius: 0.5rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.lightbox-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  transition: background 0.2s;
}
.lightbox-close:hover {
  background: rgba(255, 255, 255, 0.3);
}
.lightbox-prev, .lightbox-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  z-index: 10;
  transition: background 0.2s;
}
.lightbox-prev:hover, .lightbox-next:hover {
  background: rgba(255, 255, 255, 0.3);
}
.lightbox-prev {
  left: 1rem;
}
.lightbox-next {
  right: 1rem;
}
.lightbox-counter {
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 1.5rem;
  font-size: 0.875rem;
  z-index: 10;
  display: none;
}
/* 圖片可點擊樣式 */
.clickable-image {
  cursor: pointer;
  transition: opacity 0.2s;
}
.clickable-image:hover {
  opacity: 0.9;
}
/* Toast 通知 */
.toast {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: #1f2937;
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  z-index: 2000;
  transform: translateX(400px);
  transition: transform 0.3s ease-out;
  max-width: 300px;
}
.toast.show {
  transform: translateX(0);
}
.toast.success {
  background: #10b981;
}
.toast.error {
  background: #ef4444;
}
.toast.warning {
  background: #f59e0b;
}
/* 搜尋框 */
.search-container {
  position: sticky;
  top: 0;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  padding: 1rem;
  margin: -1rem -1rem 1rem -1rem;
  border-bottom: 1px solid #e5e7eb;
  z-index: 10;
}
/* 剩餘天數標籤 */
.expires-badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.7rem;
  font-weight: 600;
}
.expires-badge.warning {
  background: #fef3c7;
  color: #92400e;
}
.expires-badge.danger {
  background: #fee2e2;
  color: #991b1b;
}
.expires-badge.success {
  background: #d1fae5;
  color: #065f46;
}
/* 分頁器樣式 */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1.5rem;
}
.pagination-btn {
  min-width: 2.5rem;
  height: 2.5rem;
  padding: 0 0.75rem;
  border: 1px solid #e5e7eb;
  background: white;
  color: #374151;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.pagination-btn:hover:not(.disabled):not(.active) {
  background: #f3f4f6;
  border-color: #d1d5db;
}
.pagination-btn.active {
  background: var(--grad);
  color: white;
  border-color: transparent;
}
.pagination-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>
<body class="bg-white">

<header class="text-center py-6 text-white relative" style="background: var(--grad)">
  <h1 class="text-2xl md:text-3xl font-extrabold">♻️ 二手交易</h1>
  <p class="opacity-90 text-sm mt-1">刊登二手物品，附上照片、聯絡人與電話</p>
</header>

<main class="max-w-3xl mx-auto p-4 space-y-6 pb-20">
  <!-- 搜尋框和分類篩選 -->
  <div class="search-container">
    <div class="grid grid-cols-3 gap-2">
      <input 
        type="text" 
        id="searchInput" 
        class="input" 
        placeholder="🔍 搜尋..."
        oninput="handleSearch()"
      >
      <select id="categoryFilter" class="input py-2 text-xs" onchange="handleCategoryFilter()">
        <option value="">分類</option>
        <option value="furniture">傢俱</option>
        <option value="electronics">3C電子</option>
        <option value="clothing">服飾</option>
        <option value="books">書籍</option>
        <option value="home">居家</option>
        <option value="sports">運動</option>
        <option value="vehicles">交通</option>
        <option value="toys">玩具</option>
        <option value="cosmetics">美妝</option>
        <option value="food">食品</option>
        <option value="other">其他</option>
      </select>
      <button onclick="openHelpModal()" class="btn py-2 px-2 text-xs whitespace-nowrap">
        📖 說明
      </button>
    </div>
  </div>
  
  <!-- 刊登列表 -->
  <section class="space-y-3" id="listContainer" aria-live="polite"></section>
  
  <!-- 分頁器 -->
  <div id="paginationContainer" class="mt-6 flex justify-center items-center gap-2 flex-wrap"></div>
  
  <!-- 免責聲明（靠近底部導航列上方） -->
  <div class="mt-6 mb-20 p-2 bg-gray-50 border border-gray-200 rounded text-center">
    <p class="text-xs text-gray-500 leading-relaxed">
      <span class="text-gray-400">⚠️ 免責聲明：</span>本平台為免費開放使用，所有交易資訊均由用戶自行提供。本站僅提供資訊展示平台，不參與任何交易行為，不對交易結果承擔任何責任。使用本平台即表示您已閱讀並同意本免責聲明。
    </p>
  </div>
</main>

<!-- 圖片燈箱 -->
<div id="lightboxOverlay" class="lightbox-overlay" onclick="closeLightboxOnOverlay(event)">
  <div class="lightbox-container" onclick="event.stopPropagation()">
    <button class="lightbox-close" onclick="closeLightbox()" aria-label="關閉">×</button>
    <button class="lightbox-prev" onclick="lightboxPrev()" aria-label="上一張">‹</button>
    <button class="lightbox-next" onclick="lightboxNext()" aria-label="下一張">›</button>
    <img id="lightboxImage" class="lightbox-image" src="" alt="">
    <div class="lightbox-counter" id="lightboxCounter"></div>
  </div>
</div>

<!-- 新增刊登按鈕 -->
<button class="add-button" onclick="openModal()" aria-label="新增刊登" title="新增刊登">
  ➕
</button>

<!-- 刊登表單彈窗 -->
<div id="modalOverlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
  <div class="modal-content glass-card p-3 md:p-4" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()" aria-label="關閉">✕</button>
    <h2 class="text-base font-bold mb-2 md:mb-3">📝 新增刊登</h2>
    <form id="listingForm" class="space-y-2 md:space-y-2.5">
      <!-- 第一行：物品名稱和售價（手機垂直堆疊，桌面並排，售價區域更寬） -->
      <div class="grid grid-cols-1 md:grid-cols-[1.1fr_1.4fr] gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">物品名稱 <span class="text-red-500">*</span> <span class="text-xs text-gray-400 font-normal">(最多10字)</span></label>
          <input id="itemTitle" type="text" class="input w-full min-w-0" placeholder="例如：IKEA 桌子" maxlength="10" required>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">售價 <span class="text-red-500">*</span></label>
          <div class="flex items-center gap-1.5">
            <span class="text-sm font-semibold text-gray-600 flex-shrink-0">$</span>
            <input id="itemPrice" type="number" class="input min-w-0" placeholder="0" min="0" step="1" required style="flex: 1 1 0; min-width: 5rem;">
            <select id="priceType" class="input flex-shrink-0 py-1" style="width: 5rem; font-size: 0.875rem;">
              <option value="fixed">固定</option>
              <option value="negotiable">可議</option>
              <option value="free">免費</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 第二行：分類（必填） -->
      <div>
        <label class="block text-xs font-medium mb-0.5">分類 <span class="text-red-500">*</span></label>
        <select id="itemCategory" class="input py-1 w-full" required>
          <option value="">請選擇分類</option>
          <option value="furniture">傢俱</option>
          <option value="electronics">3C電子</option>
          <option value="clothing">服飾配件</option>
          <option value="books">書籍文具</option>
          <option value="home">居家用品</option>
          <option value="sports">運動休閒</option>
          <option value="vehicles">交通工具</option>
          <option value="toys">玩具模型</option>
          <option value="cosmetics">美妝保養</option>
          <option value="food">食品飲料</option>
          <option value="other">其他</option>
        </select>
      </div>
      
      <!-- 第三行：數量、狀態、交易方式（手機和桌面都3欄並排） -->
      <div class="grid grid-cols-3 gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">數量</label>
          <input id="itemQuantity" type="number" class="input w-full min-w-0" placeholder="1" min="1" step="1" value="1">
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">狀態</label>
          <select id="itemCondition" class="input py-1 w-full min-w-0">
            <option value="">請選擇</option>
            <option value="new">全新</option>
            <option value="like_new">近全新</option>
            <option value="good">良好</option>
            <option value="fair">普通</option>
            <option value="poor">有使用痕跡</option>
          </select>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">交易方式</label>
          <select id="tradeMethod" class="input py-1 w-full min-w-0">
            <option value="">請選擇</option>
            <option value="face_to_face">面交</option>
            <option value="shipping">郵寄</option>
            <option value="delivery">宅配</option>
            <option value="both">面交/郵寄</option>
          </select>
        </div>
        <div class="col-span-2 md:col-span-1 min-w-0">
          <label class="block text-xs font-medium mb-0.5">交易地點 <span class="text-xs text-gray-400 font-normal">(最多6字，可填「可以私談、私約」)</span></label>
          <input id="tradeLocation" type="text" class="input w-full min-w-0" placeholder="可填「可以私談、私約」" maxlength="6">
        </div>
      </div>

      <!-- 第三行：聯絡資訊（3欄並排） -->
      <div class="grid grid-cols-3 gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">聯絡人 <span class="text-red-500">*</span></label>
          <input id="contactName" type="text" class="input w-full min-w-0" placeholder="稱呼" maxlength="20" required>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">電話</label>
          <input id="contactPhone" type="tel" class="input w-full min-w-0" placeholder="09xx-xxx-xxx" pattern="09\d{8}">
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">LINE ID</label>
          <input id="contactLineId" type="text" class="input w-full min-w-0" placeholder="LINE ID" maxlength="30">
        </div>
      </div>
      
      <!-- 第四行：照片和描述（桌面並排，手機垂直堆疊） -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <label class="block text-xs font-medium mb-0.5">照片 <span class="text-xs text-gray-400 font-normal">(最多5張)</span></label>
          <input id="imageFile" type="file" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="input text-xs py-1">
          <div id="imagePreviewContainer" class="image-preview-container mt-1.5"></div>
        </div>
        <div>
          <label class="block text-xs font-medium mb-0.5">描述 <span class="text-xs text-gray-400 font-normal">(選填，最多20字)</span></label>
          <textarea id="itemDesc" class="input" rows="2" placeholder="狀況、尺寸等" maxlength="20"></textarea>
        </div>
      </div>
      
      <!-- 下架密碼 -->
      <div>
        <label class="block text-xs font-medium mb-0.5">下架密碼 <span class="text-red-500">*</span> <span class="text-xs text-gray-400 font-normal">(用於下架此刊登，必填)</span></label>
        <input id="deletePassword" type="password" class="input" placeholder="設定下架密碼（建議4-8字）" maxlength="20" required>
      </div>
      
      <!-- 按鈕 -->
      <div class="flex items-center gap-2 pt-1">
        <button type="submit" class="btn flex-1 py-1.5 text-sm min-w-0 whitespace-nowrap">發布</button>
        <button type="button" onclick="closeModal()" class="px-3 py-1.5 rounded-lg border text-xs flex-shrink-0 whitespace-nowrap">取消</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast 通知 -->
<div id="toast" class="toast"></div>

<!-- 下架密碼輸入彈窗 -->
<div id="deleteModalOverlay" class="modal-overlay" onclick="closeDeleteModalOnOverlay(event)">
  <div class="modal-content glass-card p-4" onclick="event.stopPropagation()" style="max-width: 400px;">
    <button class="modal-close" onclick="closeDeleteModal()" aria-label="關閉">✕</button>
    <h2 class="text-lg font-bold mb-3">🔒 輸入下架密碼</h2>
    <form id="deletePasswordForm" onsubmit="submitDeletePassword(event); return false;">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">下架密碼</label>
        <input id="deletePasswordInput" type="password" class="input" placeholder="請輸入下架密碼" required autofocus>
      </div>
      <div class="flex items-center gap-2">
        <button type="submit" class="btn flex-1 py-2">確認下架</button>
        <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg border text-sm">取消</button>
      </div>
    </form>
  </div>
</div>

<!-- 使用說明彈窗 -->
<div id="helpModalOverlay" class="modal-overlay" onclick="closeHelpModalOnOverlay(event)">
  <div class="modal-content glass-card p-4 md:p-6" onclick="event.stopPropagation()" style="max-width: 600px;">
    <button class="modal-close" onclick="closeHelpModal()" aria-label="關閉">✕</button>
    <h2 class="text-xl font-bold mb-4">📖 使用說明</h2>
    <div class="space-y-4 text-sm" style="max-height: 70vh; overflow-y: auto;">
      
      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">📝 如何刊登商品</h3>
        <ol class="list-decimal list-inside space-y-1.5 text-gray-700 ml-2">
          <li>點擊右下角 <span class="font-semibold">➕</span> 按鈕開啟刊登表單</li>
          <li>填寫必填項目：物品名稱、分類、售價、聯絡人、下架密碼</li>
          <li>填寫選填項目：數量、狀態、交易方式、交易地點、電話、LINE ID、描述</li>
          <li>上傳照片（最多5張，建議上傳清晰的照片）</li>
          <li>點擊「發布」按鈕完成刊登</li>
        </ol>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">🔍 如何搜尋商品</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>使用搜尋框可搜尋：物品名稱、聯絡人、描述、電話、LINE ID</li>
          <li>使用分類下拉選單可篩選特定類別的商品</li>
          <li>搜尋和分類可以同時使用</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">📸 查看商品照片</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>點擊商品卡片上的照片縮圖可以放大查看</li>
          <li>如果有多張照片，可使用左右箭頭或鍵盤方向鍵切換</li>
          <li>點擊背景或按 ESC 鍵可關閉照片燈箱</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">📄 分頁瀏覽</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>每頁顯示 10 個商品</li>
          <li>使用分頁按鈕（1, 2, 3...）或上下頁箭頭切換頁面</li>
          <li>分頁會保留目前的搜尋和分類篩選條件</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">🔒 如何下架商品</h3>
        <ol class="list-decimal list-inside space-y-1.5 text-gray-700 ml-2">
          <li>找到要下架的商品卡片</li>
          <li>點擊「下架」按鈕</li>
          <li>輸入刊登時設定的「下架密碼」</li>
          <li>點擊「確認下架」即可移除商品</li>
        </ol>
        <p class="text-xs text-gray-500 mt-2 ml-2">⚠️ 下架密碼無法找回，請妥善保管</p>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">⚠️ 重要提醒</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li><span class="font-semibold">每個電話號碼或 LINE ID 只能刊登一個活躍商品</span>（需先下架現有商品才能刊登新的）</li>
          <li>商品刊登後有效期為 14 天，過期會自動隱藏</li>
          <li>物品名稱最多 10 字、描述最多 20 字、交易地點最多 6 字</li>
          <li>照片會自動壓縮以加快上傳速度</li>
          <li>請確保填寫的聯絡資訊正確，以便買家聯繫</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">📞 聯絡賣家</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>點擊電話號碼可直接撥打電話</li>
          <li>複製 LINE ID 並在 LINE 中搜尋加好友</li>
          <li>如賣家有註明「可私談、私約」，請透過聯絡方式洽談</li>
        </ul>
      </div>

      <div class="pt-2 border-t border-gray-200">
        <p class="text-xs text-gray-500">💡 提示：使用手機瀏覽時，表單會自動調整為適合手機輸入的緊湊佈局</p>
      </div>

      <div class="pt-3 border-t-2 border-red-200 bg-red-50 rounded-lg p-3">
        <h3 class="font-bold text-sm mb-2 text-red-700">⚠️ 免責聲明</h3>
        <div class="text-xs text-red-600 space-y-1">
          <p>• 本平台為<strong>免費開放使用</strong>，所有交易資訊均由用戶自行提供。</p>
          <p>• 本站僅提供資訊展示平台，<strong>不參與任何交易行為</strong>，不對交易結果承擔任何責任。</p>
          <p>• 用戶需自行判斷交易資訊的真實性、合法性和安全性。</p>
          <p>• 本站不對任何因使用本平台而產生的直接或間接損失負責。</p>
          <p>• 如發生交易糾紛，請用戶自行協商解決，本站不介入任何交易糾紛。</p>
          <p>• 使用本平台即表示您已閱讀並同意本免責聲明。</p>
        </div>
      </div>

    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="closeHelpModal()" class="btn py-2 px-6">我知道了</button>
    </div>
  </div>
</div>

<!-- 📍 底部導航 -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 flex justify-around py-2 bottom-nav" role="navigation" aria-label="主要導航">
  <button onclick="scrollTo(0,0)" class="flex flex-col items-center text-indigo-600 text-xs hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="回到首頁">
    <span>🏠</span><span>首頁</span>
  </button>
  <button onclick="openTool('expense-tracker.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="記帳">
    <span>📝</span><span>記帳</span>
  </button>
  <button onclick="openTool('games.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="遊戲大廳">
    <span>🎮</span><span>遊戲</span>
  </button>
  <button onclick="window.location.href='https://flyjung168.pages.dev/'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="房訊">
    <span>🍹</span><span>房訊</span>
  </button>
  <button onclick="openTool('worship.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="拜拜專區">
    <span>🙏</span><span>拜拜</span>
  </button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Google Sheets API 設定（優先使用） =====
const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbzN2osjThkZMIwAcwKPSQrQjzAYpoOdlKqzi-OGY4O2naNKC_8gF0y4evdZ4LFIt4fxZw/exec';
let useGoogleSheets = false;

if (GOOGLE_SHEETS_API_URL && GOOGLE_SHEETS_API_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
  useGoogleSheets = true;
  console.log('✅ Google Sheets API 已設定');
}

// ===== Supabase 設定（備用方案） =====
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

let supabase = null;
let useSupabase = false;

try {
  if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    useSupabase = true;
    console.log('✅ Supabase 已初始化');
  }
} catch (err) {
  console.error('❌ Supabase 初始化失敗:', err);
}

// ===== 全域變數 =====
let allListings = []; // 儲存所有刊登（用於搜尋）
let selectedImages = []; // 儲存選中的圖片（base64）
let currentSearchQuery = '';
let currentCategoryFilter = ''; // 當前分類篩選
let currentPage = 1; // 當前頁碼
const ITEMS_PER_PAGE = 10; // 每頁顯示的刊登數量

// ===== 工具函式 =====
function openTool(url) {
  if (url.startsWith('http')) {
    window.open(url, '_blank', 'noopener,noreferrer');
  } else {
    window.location.href = url;
  }
}

// Toast 通知
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// 驗證電話格式
function validatePhone(phone) {
  const cleaned = phone.replace(/[-\s]/g, '');
  return /^09\d{8}$/.test(cleaned);
}

// 驗證圖片大小（5MB）
function validateImageSize(file) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  return file.size <= maxSize;
}

// ===== 圖片壓縮功能（加快上傳速度） =====
/**
 * 壓縮圖片以減少上傳大小
 * @param {File} file - 原始圖片檔案
 * @param {number} maxWidth - 最大寬度（預設 1920px）
 * @param {number} maxHeight - 最大高度（預設 1920px）
 * @param {number} quality - JPEG 品質（0-1，預設 0.85）
 * @returns {Promise<string>} 壓縮後的 base64 字串
 */
function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        try {
          // 計算縮放比例（保持寬高比）
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = width * ratio;
            height = height * ratio;
          }
          
          // 建立 canvas 進行壓縮
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // 繪製縮放後的圖片
          ctx.drawImage(img, 0, 0, width, height);
          
          // 轉換為 JPEG（通常比 PNG 小，除非是透明圖片）
          // 使用 JPEG 格式並設定品質
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          
          // 計算壓縮後的大小
          const originalSizeKB = (file.size / 1024).toFixed(2);
          const compressedSizeKB = ((compressedBase64.length * 3) / 4 / 1024).toFixed(2);
          const compressionRatio = ((1 - compressedBase64.length * 3 / 4 / file.size) * 100).toFixed(1);
          
          console.log(`📦 圖片壓縮: ${file.name}`);
          console.log(`   原始: ${originalSizeKB} KB → 壓縮後: ${compressedSizeKB} KB (減少 ${compressionRatio}%)`);
          
          resolve(compressedBase64);
        } catch (err) {
          console.error('壓縮失敗，使用原始圖片:', err);
          // 如果壓縮失敗，返回原始 base64
          resolve(e.target.result);
        }
      };
      img.onerror = () => {
        reject(new Error('圖片載入失敗'));
      };
      img.src = e.target.result;
    };
    reader.onerror = () => {
      reject(new Error('檔案讀取失敗'));
    };
    reader.readAsDataURL(file);
  });
}

// 計算剩餘天數
function getDaysRemaining(expiresAt) {
  if (!expiresAt) return null;
  const expires = new Date(expiresAt);
  const now = new Date();
  const diff = expires - now;
  const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
  return days;
}

// 格式化剩餘天數顯示
function formatDaysRemaining(days) {
  if (days === null || days === undefined) return null;
  if (days < 0) return { text: '已過期', class: 'danger' };
  if (days <= 3) return { text: `剩${days}天`, class: 'danger' };
  if (days <= 7) return { text: `剩${days}天`, class: 'warning' };
  return { text: `剩${days}天`, class: 'success' };
}

// ===== 圖片預覽管理 =====
function setupImagePreview() {
  const fileInput = document.getElementById('imageFile');
  const previewContainer = document.getElementById('imagePreviewContainer');
  
  fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    
    // 檢查數量限制
    if (files.length + selectedImages.length > 5) {
      showToast('最多只能上傳 5 張照片', 'error');
      fileInput.value = '';
      return;
    }
    
    // 顯示壓縮提示
    if (files.length > 0) {
      showToast('正在壓縮圖片以加快上傳速度...', 'info');
    }
    
    // 處理每個檔案（使用 async/await 確保順序處理）
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      // 驗證檔案大小（原始檔案）
      if (!validateImageSize(file)) {
        showToast(`${file.name} 檔案過大（上限 5MB）`, 'error');
        continue;
      }
      
      // 驗證檔案格式
      if (!file.type.startsWith('image/')) {
        showToast(`${file.name} 格式不符（僅支援圖片）`, 'error');
        continue;
      }
      
      try {
        // 自動壓縮圖片（1920px 最大尺寸，85% 品質）
        // 如果原始檔案已經很小（< 500KB），可以跳過壓縮
        const shouldCompress = file.size > 500 * 1024; // 超過 500KB 才壓縮
        
        let base64;
        if (shouldCompress) {
          base64 = await compressImage(file, 1920, 1920, 0.85);
        } else {
          // 小檔案直接讀取
          base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }
        
        const imageData = {
          file: file,
          base64: base64,
          id: Date.now() + Math.random() + i
        };
        
        selectedImages.push(imageData);
        renderImagePreview();
      } catch (err) {
        console.error(`處理圖片 ${file.name} 失敗:`, err);
        showToast(`${file.name} 處理失敗`, 'error');
      }
    }
    
    // 清空 input（允許重選同一檔案）
    fileInput.value = '';
    
    if (files.length > 0) {
      showToast(`已處理 ${files.length} 張圖片`, 'success');
    }
  });
}

function renderImagePreview() {
  const container = document.getElementById('imagePreviewContainer');
  container.innerHTML = '';
  
  selectedImages.forEach((imgData, index) => {
    const item = document.createElement('div');
    item.className = 'image-preview-item';
    item.innerHTML = `
      <img src="${imgData.base64}" alt="預覽 ${index + 1}">
      <button type="button" class="remove-btn" onclick="removeImagePreview(${index})">×</button>
    `;
    container.appendChild(item);
  });
  
  // 顯示剩餘可上傳數量
  if (selectedImages.length > 0) {
    const remaining = 5 - selectedImages.length;
    const hint = document.createElement('div');
    hint.className = 'text-xs text-gray-500 mt-2';
    hint.textContent = `已選 ${selectedImages.length} 張，還可上傳 ${remaining} 張`;
    container.appendChild(hint);
  }
}

function removeImagePreview(index) {
  selectedImages.splice(index, 1);
  renderImagePreview();
}

// ===== 資料讀取與儲存 =====
const STORAGE_KEY = 'secondHandListings_v1';
function readListingsLocal() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
}
function writeListingsLocal(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

async function readListings() {
  if (useGoogleSheets) {
    try {
      console.log('🔍 開始讀取 Google Sheets:', GOOGLE_SHEETS_API_URL);
      
      // GET 請求不需要 mode: 'cors'，因為 GET 請求通常不會觸發預檢
      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      console.log('📡 回應狀態:', response.status, response.statusText);
      console.log('📡 回應 headers:', [...response.headers.entries()]);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      console.log('📄 回應內容:', text.substring(0, 500));
      
      let result;
      try {
        result = JSON.parse(text);
        console.log('✅ JSON 解析成功:', result);
      } catch (e) {
        console.error('❌ 解析 JSON 失敗:', e);
        console.error('原始回應:', text);
        throw new Error('伺服器回應格式錯誤: ' + text.substring(0, 100));
      }
      
      if (result.ok && result.list !== undefined) {
        // 調試：檢查返回的數據格式
        console.log('📋 從 Google Sheets 讀取的數據:', result.list);
        
        // 確保每個項目都有正確的圖片格式
        const processedList = result.list.map(item => {
          // 確保 images 是陣列格式
          let images = item.images || [];
          // 如果沒有 images 但有 imageUrl，轉換成陣列
          if (images.length === 0 && item.imageUrl) {
            images = [item.imageUrl];
          }
          
          // 轉換 Google Drive 連結格式，確保可以正常顯示
          images = images.map(imgUrl => {
            if (!imgUrl || typeof imgUrl !== 'string' || imgUrl.trim() === '') return '';
            
            let url = imgUrl.trim();
            
            // 如果已經是 Google Drive 連結，提取檔案 ID 並轉換格式
            let fileId = null;
            
            // 格式 1: https://drive.google.com/uc?export=view&id=FILE_ID
            if (url.includes('drive.google.com/uc?export=view&id=')) {
              fileId = url.match(/id=([^&]+)/)?.[1];
            }
            // 格式 2: https://drive.google.com/file/d/FILE_ID/view
            else if (url.includes('drive.google.com/file/d/')) {
              fileId = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            }
            // 格式 3: https://drive.google.com/open?id=FILE_ID
            else if (url.includes('drive.google.com/open?id=')) {
              fileId = url.match(/id=([^&]+)/)?.[1];
            }
            // 格式 4: 直接包含檔案 ID (lh3格式)
            else if (url.includes('lh3.googleusercontent.com/d/')) {
              fileId = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            }
            
            // 如果有檔案 ID，使用多種格式嘗試（最可靠的是 thumbnail 格式）
            if (fileId && fileId.length >= 25) {
              // 優先使用 thumbnail 格式（最穩定）
              return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            
            // 其他格式的連結直接返回
            return url;
          }).filter(Boolean); // 過濾空值
          
          // 更新 item 的圖片欄位
          item.images = images;
          // 確保 imageUrl 存在（用於向下相容）
          if (!item.imageUrl && images.length > 0) {
            item.imageUrl = images[0];
          }
          
          // 統一欄位名稱（後端可能返回 priceType，前端使用 priceType）
          if (item.priceType === undefined && item.price_type) {
            item.priceType = item.price_type;
          }
          if (item.quantity === undefined || item.quantity === null) {
            item.quantity = 1;
          }
          if (item.tradeMethod === undefined && item.trade_method) {
            item.tradeMethod = item.trade_method;
          }
          if (item.tradeLocation === undefined && item.trade_location) {
            item.tradeLocation = item.trade_location;
          }
          // 分類欄位（確保分類欄位存在）
          if (!item.category) {
            item.category = '';
          }
          
          // 調試：檢查圖片 URL 是否重複
          const uniqueImages = [...new Set(images)];
          if (uniqueImages.length !== images.length) {
            console.warn(`⚠️ ${item.title} 有重複的圖片 URL:`);
            console.warn('  原始圖片:', images);
            console.warn('  去重後:', uniqueImages);
            // 去重，保留順序
            const seen = new Set();
            images = images.filter(url => {
              if (seen.has(url)) return false;
              seen.add(url);
              return true;
            });
          }
          
          console.log(`📸 ${item.title} 的圖片 (${images.length} 張):`, images);
          return item;
        });
        
        console.log('✅ 處理後的列表長度:', processedList.length);
        return processedList;
      }
      
      // 檢查是否有錯誤訊息
      if (!result.ok) {
        console.error('❌ API 返回錯誤:', result.error || '未知錯誤');
        throw new Error(result.error || '讀取失敗');
      }
      
      // 如果沒有 list 欄位
      if (result.list === undefined) {
        console.warn('⚠️ API 回應格式異常，沒有 list 欄位:', result);
        return [];
      }
      
      throw new Error('讀取失敗: ' + JSON.stringify(result));
    } catch (err) {
      console.error('❌ 讀取 Google Sheets 失敗:', err);
      console.error('錯誤詳情:', {
        message: err.message,
        stack: err.stack,
        name: err.name
      });
      
      // 如果是 CORS 錯誤或其他網路錯誤，降級到 localStorage 並顯示提示
      const isCorsError = err.message && (
        err.message.includes('CORS') || 
        err.message.includes('fetch') ||
        err.message.includes('Failed to fetch') ||
        err.message.includes('network') ||
        err.message.includes('ERR_') ||
        err.message.includes('NETWORK_ERROR')
      );
      
      if (isCorsError) {
        console.warn('⚠️ CORS 或網路錯誤：Google Apps Script 需要正確設定 CORS。改用 localStorage。');
        showToast('無法連接到伺服器，使用離線模式', 'warning');
        return readListingsLocal();
      }
      
      // 其他錯誤也降級，但顯示更詳細的錯誤訊息
      console.warn('⚠️ 讀取失敗，改用 localStorage');
      showToast(`讀取失敗: ${err.message || '未知錯誤'}`, 'error');
      return readListingsLocal();
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) throw error;
      return (data || []).map(item => ({
        id: item.id,
        title: item.title,
        name: item.contact_name,
        phone: item.contact_phone || '',
        lineId: item.line_id || '',
        images: item.image_url ? [item.image_url] : [],
        imageUrl: item.image_url || '',
        desc: item.description,
        createdAt: new Date(item.created_at).getTime(),
        expiresAt: null
      }));
    } catch (err) {
      console.error('讀取 Supabase 失敗:', err);
    }
  }
  
  return readListingsLocal();
}

async function addListing(listing, imageBase64List = []) {
  if (useGoogleSheets) {
    try {
      const payload = {
        title: listing.title,
        contact_name: listing.name,
        contact_phone: listing.phone,
        description: listing.desc || '',
        imageUrls: listing.imageUrls || [],
        imageBase64List: imageBase64List
      };

      // 使用 FormData（避免 CORS 預檢請求）
      const fd = new FormData();
      fd.append('title', listing.title);
      fd.append('contact_name', listing.name);
      fd.append('contact_phone', listing.phone || '');
      fd.append('line_id', listing.lineId || '');
      fd.append('description', listing.desc || '');
      fd.append('price', listing.price || 0);
      fd.append('price_type', listing.priceType || 'fixed');
      fd.append('quantity', listing.quantity || 1);
      fd.append('condition', listing.condition || '');
      fd.append('trade_method', listing.tradeMethod || '');
      fd.append('trade_location', listing.tradeLocation || '');
      fd.append('category', listing.category || '');
      fd.append('delete_password', listing.deletePassword || '');
      fd.append('imageBase64List', JSON.stringify(imageBase64List));
      fd.append('imageUrls', JSON.stringify(listing.imageUrls || []));

      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        body: fd,
        redirect: 'follow'
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      // 嘗試解析回應
      const text = await response.text();
      let result;
      try {
        result = JSON.parse(text);
      } catch (e) {
        // 如果回應不是 JSON，可能表示成功或需要重新導向
        console.warn('回應不是 JSON 格式:', text.substring(0, 100));
        // 檢查是否為重新導向後的頁面
        if (text.includes('Google') || response.redirected) {
          // 可能是重新導向到確認頁面，嘗試再次讀取
          console.log('檢測到重新導向，假設提交成功');
          return { ok: true };
        }
        throw new Error('伺服器回應格式錯誤');
      }
      
      if (result.ok) {
        return result;
      }
      throw new Error(result.error || '新增失敗');
    } catch (err) {
      console.error('新增到 Google Sheets 失敗:', err);
      
      // 如果是 CORS 錯誤，提供更詳細的錯誤訊息
      const isCorsError = err.message && (
        err.message.includes('CORS') || 
        err.message.includes('Failed to fetch') ||
        err.message.includes('network')
      );
      
      if (isCorsError) {
        const corsError = new Error('CORS 錯誤：請檢查 Google Apps Script 的部署設定（必須設定為「所有人可存取」並包含 doOptions 函數）');
        corsError.isCorsError = true;
        throw corsError;
      }
      
      throw err;
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .insert([{
          title: listing.title,
          contact_name: listing.name,
          contact_phone: listing.phone,
          image_url: listing.imageUrl || null,
          description: listing.desc || null
        }])
        .select();
      if (error) throw error;
      return data && data[0];
    } catch (err) {
      console.error('新增到 Supabase 失敗:', err);
    }
  }
  
  const list = readListingsLocal();
  list.unshift(listing);
  writeListingsLocal(list);
  return listing;
}

// 當前要下架的刊登 ID
let currentDeleteId = null;

// 顯示下架密碼輸入彈窗
function showDeleteModal(idOrIndex) {
  currentDeleteId = idOrIndex;
  const overlay = document.getElementById('deleteModalOverlay');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  document.getElementById('deletePasswordInput').value = '';
  setTimeout(() => {
    document.getElementById('deletePasswordInput').focus();
  }, 100);
}

// 關閉下架密碼輸入彈窗
function closeDeleteModal() {
  const overlay = document.getElementById('deleteModalOverlay');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
  currentDeleteId = null;
  document.getElementById('deletePasswordInput').value = '';
}

function closeDeleteModalOnOverlay(event) {
  if (event.target.id === 'deleteModalOverlay') {
    closeDeleteModal();
  }
}

// 提交下架密碼
async function submitDeletePassword(e) {
  e.preventDefault();
  const password = document.getElementById('deletePasswordInput').value.trim();
  
  if (!password) {
    showToast('請輸入下架密碼', 'error');
    return;
  }
  
  if (!currentDeleteId) {
    showToast('找不到要下架的刊登', 'error');
    return;
  }
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = '驗證中...';
  
  try {
    const success = await removeListingById(currentDeleteId, password);
    if (success) {
      showToast('已下架刊登', 'success');
      closeDeleteModal();
      // 如果當前頁沒有數據了，回到上一頁
      const container = document.getElementById('listContainer');
      const cards = container.querySelectorAll('.card');
      if (cards.length === 1 && currentPage > 1) {
        await renderListings(null, currentPage - 1);
      } else {
        await renderListings(null, currentPage);
      }
    } else {
      showToast('下架密碼錯誤', 'error');
      document.getElementById('deletePasswordInput').value = '';
      document.getElementById('deletePasswordInput').focus();
    }
  } catch (err) {
    console.error('下架失敗:', err);
    showToast('下架失敗：' + (err.message || '未知錯誤'), 'error');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
}

async function removeListingById(id, password = '') {
  if (useGoogleSheets) {
    try {
      // 調試：輸出密碼資訊
      console.log('🔒 下架請求:', {
        id: id,
        password: password,
        passwordLength: password.length,
        passwordType: typeof password
      });
      
      const fd = new FormData();
      fd.append('action', 'delete');
      fd.append('id', id);
      fd.append('password', password);
      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        body: fd,
        redirect: 'follow'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      let result;
      try {
        result = JSON.parse(text);
        // 調試：輸出回應結果
        console.log('🔒 下架回應:', result);
      } catch (e) {
        console.warn('回應不是 JSON 格式:', text.substring(0, 100));
        return false;
      }
      
      if (result.ok && result.deleted) {
        return true;
      }
      
      if (result.error && (result.error.includes('密碼') || result.error.includes('錯誤'))) {
        console.warn('❌ 下架密碼錯誤:', result.error);
        return false;
      }
      
      return false;
    } catch (err) {
      console.error('從 Google Sheets 下架失敗:', err);
      throw err;
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { error } = await supabase.from('second_hand_listings').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) {
      console.error('從 Supabase 刪除失敗:', err);
      throw err;
    }
  }
  
  return false;
}

// ===== 圖片輪播功能 =====
function initImageCarousel(containerId, images) {
  if (!images || images.length === 0) return;
  
  let currentIndex = 0;
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const imgElements = container.querySelectorAll('img');
  const dots = container.querySelectorAll('.carousel-dot');
  
  function showImage(index) {
    imgElements.forEach((img, i) => {
      img.classList.toggle('active', i === index);
    });
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
  }
  
  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
  }
  
  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
  }
  
  container.querySelector('.carousel-next')?.addEventListener('click', (e) => {
    e.stopPropagation(); // 阻止事件冒泡，避免觸發圖片點擊
    nextImage();
  });
  container.querySelector('.carousel-prev')?.addEventListener('click', (e) => {
    e.stopPropagation(); // 阻止事件冒泡，避免觸發圖片點擊
    prevImage();
  });
  
  dots.forEach((dot, i) => {
    dot.addEventListener('click', (e) => {
      e.stopPropagation(); // 阻止事件冒泡，避免觸發圖片點擊
      currentIndex = i;
      showImage(currentIndex);
    });
  });
  
  showImage(0);
}

// ===== 渲染刊登列表 =====
async function renderListings(filteredList = null, page = 1) {
  const container = document.getElementById('listContainer');
  if (!container) {
    console.error('❌ 找不到 listContainer 元素');
    return;
  }
  container.innerHTML = '<div class="text-center text-sm text-gray-500">載入中...</div>';
  
  try {
    console.log('🎨 開始渲染列表...');
    let list = filteredList || await readListings();
    console.log('📊 讀取到的列表:', list);
    
    // 如果沒有過濾列表，則更新 allListings（用於搜尋）
    if (!filteredList) {
      allListings = list;
    }
    
    // 過濾過期項目（前端過濾）
    const now = Date.now();
    list = list.filter(item => {
      if (!item.expiresAt) return true;
      const expires = new Date(item.expiresAt).getTime();
      return expires > now;
    });
    
    if (list.length === 0) {
      container.innerHTML = '<div class="text-center text-sm text-gray-500">尚無刊登，快來成為第一位！</div>';
      document.getElementById('paginationContainer').innerHTML = '';
      return;
    }
    
    // 計算分頁
    const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
    currentPage = Math.max(1, Math.min(page, totalPages)); // 確保頁碼在有效範圍內
    
    // 計算當前頁的數據範圍
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const pageList = list.slice(startIndex, endIndex);
    
    console.log(`📄 分頁資訊: 總共 ${list.length} 筆，每頁 ${ITEMS_PER_PAGE} 筆，共 ${totalPages} 頁，當前第 ${currentPage} 頁`);
    
    // 渲染當前頁的卡片
    container.innerHTML = pageList.map((it, idx) => {
      const images = it.images || (it.imageUrl ? [it.imageUrl] : []);
      const daysRemaining = getDaysRemaining(it.expiresAt);
      const daysInfo = formatDaysRemaining(daysRemaining);
      const carouselId = `carousel-${it.id || idx}`;
      
      // 限制描述為50字
      const descText = it.desc ? escapeHtml(it.desc).substring(0, 20) + (it.desc.length > 20 ? '...' : '') : '';
      
      return `
        <div class="card">
          <div class="flex gap-3 items-start">
            ${images.length > 0 ? `
              <div class="w-24 h-24 md:w-20 md:h-20 flex-shrink-0 relative">
                <img src="${images[0]}" class="w-full h-full object-cover rounded cursor-pointer hover:opacity-90 transition-opacity" alt="${it.title}" data-images='${JSON.stringify(images).replace(/"/g, '&quot;')}' data-index="0" onclick="handleImageClick(this)" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Crect width=\\'100\\' height=\\'100\\' fill=\\'%23e5e7eb\\'/%3E%3Ctext x=\\'50\\' y=\\'50\\' text-anchor=\\'middle\\' fill=\\'%239ca3af\\'%3E無圖%3C/text%3E%3C/svg%3E'">
                ${images.length > 1 ? `<div class="absolute top-0.5 right-0.5 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded-full font-bold">${images.length}</div>` : ''}
              </div>
            ` : `
              <div class="w-24 h-24 md:w-20 md:h-20 bg-gray-100 rounded flex items-center justify-center text-gray-400 flex-shrink-0 text-xs">
                無圖
              </div>
            `}
            <div class="flex-1 min-w-0">
              <!-- 第一行：標題和價格 -->
              <div class="flex items-start justify-between gap-2 mb-1">
                <div class="font-bold text-base md:text-lg flex-1 min-w-0">${escapeHtml(it.title)}</div>
                ${it.price !== undefined && it.price !== null && it.price !== '' && it.price !== 0 ? `
                  <div class="flex-shrink-0 text-right">
                    <div class="text-lg md:text-xl font-bold text-emerald-600">$${parseInt(it.price || 0).toLocaleString()}</div>
                    ${it.priceType ? `<div class="text-xs text-gray-500">${it.priceType === 'negotiable' ? '可議' : it.priceType === 'free' ? '免費' : ''}</div>` : ''}
                  </div>
                ` : it.priceType === 'free' ? `
                  <div class="flex-shrink-0 text-right">
                    <div class="text-lg md:text-xl font-bold text-emerald-600">免費</div>
                  </div>
                ` : ''}
              </div>
              
              <!-- 第二行：分類、剩餘天數、狀態、交易方式、地點 -->
              <div class="flex flex-wrap items-center gap-2 text-xs mb-1.5">
                ${it.category ? `<span class="px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-medium">🏷️ ${getCategoryText(it.category)}</span>` : ''}
                ${daysInfo ? `<span class="expires-badge ${daysInfo.class}">${daysInfo.text}</span>` : ''}
                ${it.quantity && it.quantity > 1 ? `<span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded">數量：${it.quantity}</span>` : ''}
                ${it.condition ? `<span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">${getConditionText(it.condition)}</span>` : ''}
                ${it.tradeMethod ? `<span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">${getTradeMethodText(it.tradeMethod)}</span>` : ''}
                ${it.tradeLocation ? `<span class="text-gray-500">📍 ${escapeHtml(it.tradeLocation)}</span>` : ''}
              </div>
              
              <!-- 第三行：描述（限50字） -->
              ${descText ? `<div class="text-sm text-gray-600 mb-1.5 line-clamp-1">${descText}</div>` : ''}
              
              <!-- 第四行：聯絡資訊 -->
              <div class="text-xs mt-1.5 flex flex-wrap items-center gap-1.5">
                <span class="text-gray-700">👤 ${escapeHtml(it.name)}</span>
                ${it.phone ? `<a href="tel:${escapeHtml(it.phone)}" class="text-emerald-600">📞 ${escapeHtml(it.phone)}</a>` : ''}
                ${it.lineId ? `<span class="text-emerald-600">💬 ${escapeHtml(it.lineId)}</span>` : ''}
              </div>
            </div>
            <button class="text-xs text-red-600 hover:text-red-700 px-2 py-1 flex-shrink-0" onclick="showDeleteModal('${it.id || it.createdAt}')">下架</button>
          </div>
        </div>
      `;
    }).join('');
    
    // 渲染分頁器
    renderPagination(totalPages, currentPage, list.length);
    
  } catch (err) {
    console.error('❌ 渲染列表失敗:', err);
    console.error('錯誤詳情:', {
      message: err.message,
      stack: err.stack,
      name: err.name
    });
    const errorMsg = err.message || '未知錯誤';
    container.innerHTML = `<div class="text-center text-sm text-red-500 p-4">
      <div>載入失敗</div>
      <div class="text-xs mt-2 text-gray-500">${errorMsg}</div>
      <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">重新載入</button>
    </div>`;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 取得物品狀態文字
function getConditionText(condition) {
  const conditions = {
    'new': '全新',
    'like_new': '近全新',
    'good': '良好',
    'fair': '普通',
    'poor': '有使用痕跡'
  };
  return conditions[condition] || condition;
}

// 取得交易方式文字
function getTradeMethodText(method) {
  const methods = {
    'face_to_face': '面交',
    'shipping': '郵寄',
    'delivery': '宅配',
    'both': '面交/郵寄'
  };
  return methods[method] || method;
}

// 取得分類文字
function getCategoryText(category) {
  const categories = {
    'furniture': '傢俱',
    'electronics': '3C電子',
    'clothing': '服飾配件',
    'books': '書籍文具',
    'home': '居家用品',
    'sports': '運動休閒',
    'vehicles': '交通工具',
    'toys': '玩具模型',
    'cosmetics': '美妝保養',
    'food': '食品飲料',
    'other': '其他'
  };
  return categories[category] || category || '未分類';
}


// ===== 分頁功能 =====
function renderPagination(totalPages, currentPage, totalItems) {
  const container = document.getElementById('paginationContainer');
  if (!container) return;
  
  // 如果只有一頁或沒有數據，不顯示分頁器
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let paginationHTML = '<div class="pagination">';
  
  // 上一頁按鈕
  paginationHTML += `<button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>`;
  
  // 頁碼按鈕
  const maxVisiblePages = 9; // 最多顯示 9 個頁碼按鈕
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  // 調整起始頁，確保顯示足夠的頁碼
  if (endPage - startPage < maxVisiblePages - 1) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  // 如果起始頁不是第一頁，顯示第一頁和省略號
  if (startPage > 1) {
    paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
    if (startPage > 2) {
      paginationHTML += `<span class="pagination-btn disabled">...</span>`;
    }
  }
  
  // 顯示頁碼範圍
  for (let i = startPage; i <= endPage; i++) {
    paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
  }
  
  // 如果結束頁不是最後一頁，顯示省略號和最後一頁
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      paginationHTML += `<span class="pagination-btn disabled">...</span>`;
    }
    paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
  }
  
  // 下一頁按鈕
  paginationHTML += `<button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>`;
  
  paginationHTML += '</div>';
  
  // 顯示總數資訊
  const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
  const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
  paginationHTML += `<div class="text-center text-sm text-gray-500 mt-2">顯示 ${startItem}-${endItem} / 共 ${totalItems} 筆</div>`;
  
  container.innerHTML = paginationHTML;
}

function goToPage(page) {
  if (page < 1) return;
  
  // 應用所有篩選條件
  let filtered = allListings;
  
  // 分類篩選
  if (currentCategoryFilter) {
    filtered = filtered.filter(item => item.category === currentCategoryFilter);
  }
  
  // 搜尋篩選
  if (currentSearchQuery) {
    filtered = filtered.filter(item => {
      return item.title.toLowerCase().includes(currentSearchQuery) ||
             item.name.toLowerCase().includes(currentSearchQuery) ||
             (item.desc && item.desc.toLowerCase().includes(currentSearchQuery)) ||
             (item.phone && item.phone.includes(currentSearchQuery)) ||
             (item.lineId && item.lineId.toLowerCase().includes(currentSearchQuery));
    });
  }
  
  renderListings(filtered, page);
  
  // 滾動到列表頂部
  document.getElementById('listContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== 分類篩選功能 =====
function handleCategoryFilter() {
  const category = document.getElementById('categoryFilter').value;
  currentCategoryFilter = category;
  currentPage = 1; // 重置到第一頁
  
  applyFilters();
}

// 應用搜尋和分類篩選
function applyFilters() {
  let filtered = allListings;
  
  // 應用分類篩選
  if (currentCategoryFilter) {
    filtered = filtered.filter(item => item.category === currentCategoryFilter);
  }
  
  // 應用搜尋篩選
  if (currentSearchQuery) {
    filtered = filtered.filter(item => {
      return item.title.toLowerCase().includes(currentSearchQuery) ||
             item.name.toLowerCase().includes(currentSearchQuery) ||
             (item.desc && item.desc.toLowerCase().includes(currentSearchQuery)) ||
             (item.phone && item.phone.includes(currentSearchQuery)) ||
             (item.lineId && item.lineId.toLowerCase().includes(currentSearchQuery));
    });
  }
  
  renderListings(filtered, 1);
}

// ===== 搜尋功能 =====
function handleSearch() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  currentSearchQuery = query;
  currentPage = 1; // 重置到第一頁
  
  applyFilters();
}

// ===== 彈窗控制 =====
function openModal() {
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('listingForm').reset();
  selectedImages = [];
  renderImagePreview();
}

function closeModalOnOverlay(event) {
  if (event.target.id === 'modalOverlay') {
    closeModal();
  }
}

// 使用說明彈窗控制
function openHelpModal() {
  document.getElementById('helpModalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeHelpModal() {
  document.getElementById('helpModalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

function closeHelpModalOnOverlay(event) {
  if (event.target.id === 'helpModalOverlay') {
    closeHelpModal();
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // 優先關閉使用說明彈窗，如果沒有打開則關閉刊登表單
    if (document.getElementById('helpModalOverlay').classList.contains('active')) {
      closeHelpModal();
    } else if (document.getElementById('modalOverlay').classList.contains('active')) {
      closeModal();
    } else if (document.getElementById('deleteModalOverlay').classList.contains('active')) {
      closeDeleteModal();
    }
  }
});

// ===== 表單提交 =====
document.getElementById('listingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('itemTitle').value.trim();
  const name = document.getElementById('contactName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim().replace(/[-\s]/g, '');
  const lineId = document.getElementById('contactLineId').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const price = document.getElementById('itemPrice').value.trim();
  const priceType = document.getElementById('priceType').value;
  const quantity = document.getElementById('itemQuantity').value.trim() || '1';
  const condition = document.getElementById('itemCondition').value;
  const tradeMethod = document.getElementById('tradeMethod').value;
  const tradeLocation = document.getElementById('tradeLocation').value.trim();
  const category = document.getElementById('itemCategory').value;
  const deletePassword = document.getElementById('deletePassword').value.trim();
  
  // 驗證分類（必填）
  if (!category || category === '') {
    showToast('請選擇分類', 'error');
    return;
  }
  
  // 驗證
  if (!title || !name) {
    showToast('請填寫必填欄位', 'error');
    return;
  }
  
  // 驗證下架密碼（必填）
  if (!deletePassword || deletePassword.trim() === '') {
    showToast('請設定下架密碼', 'error');
    return;
  }
  
  // 驗證售價
  if (!price || price <= 0) {
    if (priceType !== 'free') {
      showToast('請輸入售價', 'error');
      return;
    }
  }
  
  // 電話或 LINE ID 至少填寫一個
  if (!phone && !lineId) {
    showToast('請填寫電話或 LINE ID（至少填寫一個）', 'error');
    return;
  }
  
  if (title.length > 10) {
    showToast('物品名稱過長（最多10字）', 'error');
    return;
  }
  
  // 如果有填寫電話，則驗證格式
  if (phone && !validatePhone(phone)) {
    showToast('電話格式錯誤（應為 09xx-xxx-xxx）', 'error');
    return;
  }
  
  if (lineId && lineId.length > 30) {
    showToast('LINE ID 過長（最多30字）', 'error');
    return;
  }
  
  if (desc.length > 20) {
    showToast('描述過長（最多20字）', 'error');
    return;
  }
  
  if (tradeLocation.length > 6) {
    showToast('交易地點過長（最多6字）', 'error');
    return;
  }
  
  if (selectedImages.length === 0) {
    showToast('請至少上傳一張照片', 'warning');
    return;
  }

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  
  // 計算總圖片大小（用於顯示上傳進度）
  const totalImageSize = selectedImages.reduce((sum, img) => {
    return sum + (img.base64.length * 3 / 4); // base64 大小約為原始大小的 1.33 倍
  }, 0);
  const totalSizeMB = (totalImageSize / 1024 / 1024).toFixed(2);
  
  // 更新按鈕文字，顯示上傳大小
  submitBtn.textContent = `上傳中... (${totalSizeMB} MB)`;

  try {
    const imageBase64List = selectedImages.map(img => img.base64);
    
    const listing = {
      title,
      name,
      phone: phone || '',
      lineId: lineId || '',
      desc: desc || null,
      price: priceType === 'free' ? 0 : (price || 0),
      priceType: priceType || 'fixed',
      quantity: parseInt(quantity) || 1,
      condition: condition || null,
      tradeMethod: tradeMethod || null,
      tradeLocation: tradeLocation || null,
      category: category || '',
      deletePassword: deletePassword || '',
      createdAt: Date.now(),
      imageUrls: []
    };
    
    const result = await addListing(listing, imageBase64List);
    
    showToast('發布成功！', 'success');
    e.target.reset();
    selectedImages = [];
    renderImagePreview();
    await renderListings(null, 1); // 發布後回到第一頁
    closeModal();
    
    submitBtn.textContent = '✓ 已發布';
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }, 1000);
  } catch (err) {
    console.error('提交失敗:', err);
    
    // 提供更詳細的錯誤訊息
    let errorMsg = '發布失敗：';
    if (err.isCorsError) {
      errorMsg += 'CORS 設定錯誤。請檢查 Google Apps Script 部署設定。';
      console.error('💡 解決方案：\n1. 確保 Apps Script 部署為「所有人可存取」\n2. 在 Apps Script 中添加 doOptions() 函數\n3. 重新部署並更新 URL');
    } else if (err.message) {
      errorMsg += err.message;
    } else {
      errorMsg += '請稍後再試';
    }
    
    showToast(errorMsg, 'error');
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// ===== 圖片燈箱功能 =====
let lightboxImages = [];
let lightboxCurrentIndex = 0;

// 處理圖片點擊事件
function handleImageClick(imgElement) {
  const imagesStr = imgElement.getAttribute('data-images');
  const index = parseInt(imgElement.getAttribute('data-index') || '0');
  if (imagesStr) {
    try {
      const images = JSON.parse(imagesStr);
      openLightbox(images, index);
    } catch (e) {
      console.error('解析圖片數據失敗:', e);
    }
  }
}

function openLightbox(images, index = 0) {
  if (!images || images.length === 0) return;
  
  // 調試：輸出接收到的圖片陣列
  console.log('🖼️ 打開燈箱，圖片陣列:', images);
  console.log('🖼️ 圖片數量:', images.length);
  images.forEach((url, i) => {
    console.log(`  圖片 ${i + 1}:`, url);
  });
  
  // 過濾空值和重複值
  lightboxImages = [...new Set(images.filter(url => url && url.trim() !== ''))];
  lightboxCurrentIndex = Math.max(0, Math.min(index, lightboxImages.length - 1));
  
  console.log('🖼️ 處理後的圖片陣列:', lightboxImages);
  console.log('🖼️ 初始索引:', lightboxCurrentIndex);
  
  const overlay = document.getElementById('lightboxOverlay');
  const img = document.getElementById('lightboxImage');
  const counter = document.getElementById('lightboxCounter');
  const prevBtn = overlay.querySelector('.lightbox-prev');
  const nextBtn = overlay.querySelector('.lightbox-next');
  
  // 顯示當前圖片（添加時間戳避免快取）
  const initialSrc = lightboxImages[lightboxCurrentIndex];
  img.src = initialSrc + (initialSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
  img.alt = `圖片 ${lightboxCurrentIndex + 1}`;
  
  // 更新計數器
  if (lightboxImages.length > 1) {
    counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
    counter.style.display = 'block';
    prevBtn.style.display = 'flex';
    nextBtn.style.display = 'flex';
  } else {
    counter.style.display = 'none';
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  }
  
  // 顯示燈箱
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden'; // 防止背景滾動
  
  // 鍵盤事件監聽
  document.addEventListener('keydown', handleLightboxKeyboard);
}

function closeLightbox() {
  const overlay = document.getElementById('lightboxOverlay');
  overlay.classList.remove('active');
  document.body.style.overflow = ''; // 恢復滾動
  document.removeEventListener('keydown', handleLightboxKeyboard);
}

function closeLightboxOnOverlay(event) {
  // 如果點擊的是背景（而不是圖片本身），則關閉
  if (event.target.id === 'lightboxOverlay') {
    closeLightbox();
  }
}

function lightboxPrev() {
  if (lightboxImages.length <= 1) return;
  lightboxCurrentIndex = (lightboxCurrentIndex - 1 + lightboxImages.length) % lightboxImages.length;
  updateLightboxImage();
}

function lightboxNext() {
  if (lightboxImages.length <= 1) return;
  lightboxCurrentIndex = (lightboxCurrentIndex + 1) % lightboxImages.length;
  updateLightboxImage();
}

function updateLightboxImage() {
  const img = document.getElementById('lightboxImage');
  const counter = document.getElementById('lightboxCounter');
  
  // 確保索引有效
  if (lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxImages.length) {
    console.error('圖片索引無效:', lightboxCurrentIndex, '圖片總數:', lightboxImages.length);
    return;
  }
  
  const newSrc = lightboxImages[lightboxCurrentIndex];
  
  // 調試：輸出當前圖片資訊
  console.log(`🖼️ 切換圖片: 索引 ${lightboxCurrentIndex + 1}/${lightboxImages.length}`, newSrc);
  
  // 如果是相同的 URL，強制重新載入（避免快取問題）
  if (img.src === newSrc) {
    // 先清除 src，然後重新設置，強制瀏覽器重新載入
    img.src = '';
    // 使用 setTimeout 確保清除完成後再設置新 URL
    setTimeout(() => {
      img.src = newSrc + (newSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
    }, 10);
  } else {
    // 添加時間戳避免快取
    img.src = newSrc + (newSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
  }
  
  img.alt = `圖片 ${lightboxCurrentIndex + 1}`;
  
  if (lightboxImages.length > 1) {
    counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
  }
}

function handleLightboxKeyboard(event) {
  if (!document.getElementById('lightboxOverlay').classList.contains('active')) return;
  
  switch(event.key) {
    case 'Escape':
      closeLightbox();
      break;
    case 'ArrowLeft':
      lightboxPrev();
      break;
    case 'ArrowRight':
      lightboxNext();
      break;
  }
}

// ===== 初始化 =====
setupImagePreview();
renderListings(null, 1);
</script>

</body>
</html>
