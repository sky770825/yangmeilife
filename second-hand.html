<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äºŒæ‰‹äº¤æ˜“ - æ¥Šæ¢…äººåœ¨åœ°ç”Ÿæ´»</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --grad: linear-gradient(135deg, #10b981, #059669);
}
.glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.06); border-radius: 1rem; }
.btn { background: var(--grad); color: #fff; padding: 0.6rem 1rem; border-radius: 0.75rem; font-weight: 700; cursor: pointer; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
.input { width: 100%; padding: .65rem .8rem; border: 1px solid #e5e7eb; border-radius: .75rem; }
.card { background: #fff; border: 1px solid #e5e7eb; border-radius: .75rem; padding: 0.75rem; }
/* éŸ¿æ‡‰å¼å¡ç‰‡å„ªåŒ– - æ›´ç·Šæ¹Š */
@media (max-width: 768px) {
  .card {
    padding: 0.65rem;
  }
}
/* å½ˆçª—æ¨£å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 0.75rem;
  max-width: 650px;
  width: 100%;
  max-height: 95vh;
  overflow-y: auto;
  position: relative;
  animation: slideUp 0.3s ease-out;
}
/* ç·Šæ¹Šè¡¨å–®æ¨£å¼ - æ‰‹æ©Ÿå„ªåŒ– */
.modal-content form {
  font-size: 0.8125rem;
}
.modal-content .input {
  padding: 0.4rem 0.6rem;
  font-size: 0.875rem;
  min-height: 2.25rem;
  width: 100%;
  box-sizing: border-box;
}
.modal-content label {
  font-size: 0.75rem;
  margin-bottom: 0.125rem;
  font-weight: 500;
}
.modal-content .text-xs {
  font-size: 0.65rem;
  margin-top: 0.125rem;
}
.modal-content select.input {
  padding: 0.4rem 1.75rem 0.4rem 0.6rem; /* å³å´ç•™æ›´å¤šç©ºé–“çµ¦ç®­é ­ */
  min-width: 0; /* å…è¨±åœ¨gridä¸­ç¸®å° */
  width: 100%;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* å”®åƒ¹å€åŸŸçš„ä¸‹æ‹‰é¸å–®ç‰¹æ®Šæ¨£å¼ */
#priceType {
  overflow: visible;
  text-overflow: clip;
  padding-right: 1.75rem;
  white-space: nowrap;
}
.modal-content select.input option {
  white-space: normal;
  padding: 0.25rem 0.5rem;
}
/* æ‰‹æ©Ÿç‰ˆæ›´ç·Šæ¹Š */
@media (max-width: 768px) {
  .modal-content {
    max-height: 98vh;
    border-radius: 0.5rem;
  }
  .modal-content h2 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  .modal-content form {
    font-size: 0.8rem;
  }
  .modal-content .input {
    padding: 0.35rem 0.5rem;
    font-size: 0.875rem;
    min-height: 2rem;
  }
  .modal-content label {
    font-size: 0.7rem;
    margin-bottom: 0.125rem;
  }
}
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #f3f4f6;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.modal-close:hover {
  background: #e5e7eb;
}
/* æ–°å¢æŒ‰éˆ• */
.add-button {
  position: fixed;
  bottom: 5rem;
  right: 1rem;
  background: var(--grad);
  color: white;
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  z-index: 100;
  transition: transform 0.2s;
}
.add-button:hover {
  transform: scale(1.1);
}
/* åœ–ç‰‡é è¦½å€åŸŸ */
.image-preview-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 0.3rem;
  margin-top: 0.5rem;
}
@media (max-width: 768px) {
  .image-preview-container {
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
    gap: 0.25rem;
  }
}
.image-preview-item {
  position: relative;
  aspect-ratio: 1;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 2px solid #e5e7eb;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.image-preview-item .remove-btn {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* åœ–ç‰‡è¼ªæ’­ */
.image-carousel {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 0.5rem;
  overflow: hidden;
  background: #f3f4f6;
}
.image-carousel img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}
.image-carousel img.active {
  display: block;
}
.carousel-nav {
  position: absolute;
  bottom: 0.5rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.25rem;
}
.carousel-dot {
  width: 0.5rem;
  height: 0.5rem;
  border-radius: 50%;
  background: rgba(255,255,255,0.5);
  cursor: pointer;
  transition: background 0.2s;
}
.carousel-dot.active {
  background: white;
}
.carousel-prev, .carousel-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}
.carousel-prev {
  left: 0.5rem;
}
.carousel-next {
  right: 0.5rem;
}
/* åœ–ç‰‡ç‡ˆç®± */
.lightbox-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 2rem;
}
.lightbox-overlay.active {
  display: flex;
}
.lightbox-container {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.lightbox-image {
  max-width: 100%;
  max-height: 90vh;
  object-fit: contain;
  border-radius: 0.5rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.lightbox-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  transition: background 0.2s;
}
.lightbox-close:hover {
  background: rgba(255, 255, 255, 0.3);
}
.lightbox-prev, .lightbox-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  z-index: 10;
  transition: background 0.2s;
}
.lightbox-prev:hover, .lightbox-next:hover {
  background: rgba(255, 255, 255, 0.3);
}
.lightbox-prev {
  left: 1rem;
}
.lightbox-next {
  right: 1rem;
}
.lightbox-counter {
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 1.5rem;
  font-size: 0.875rem;
  z-index: 10;
  display: none;
}
/* åœ–ç‰‡å¯é»æ“Šæ¨£å¼ */
.clickable-image {
  cursor: pointer;
  transition: opacity 0.2s;
}
.clickable-image:hover {
  opacity: 0.9;
}
/* Toast é€šçŸ¥ */
.toast {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: #1f2937;
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  z-index: 2000;
  transform: translateX(400px);
  transition: transform 0.3s ease-out;
  max-width: 300px;
}
.toast.show {
  transform: translateX(0);
}
.toast.success {
  background: #10b981;
}
.toast.error {
  background: #ef4444;
}
.toast.warning {
  background: #f59e0b;
}
/* æœå°‹æ¡† */
.search-container {
  position: sticky;
  top: 0;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  padding: 1rem;
  margin: -1rem -1rem 1rem -1rem;
  border-bottom: 1px solid #e5e7eb;
  z-index: 10;
}
/* å‰©é¤˜å¤©æ•¸æ¨™ç±¤ */
.expires-badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.7rem;
  font-weight: 600;
}
.expires-badge.warning {
  background: #fef3c7;
  color: #92400e;
}
.expires-badge.danger {
  background: #fee2e2;
  color: #991b1b;
}
.expires-badge.success {
  background: #d1fae5;
  color: #065f46;
}
/* åˆ†é å™¨æ¨£å¼ */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1.5rem;
}
.pagination-btn {
  min-width: 2.5rem;
  height: 2.5rem;
  padding: 0 0.75rem;
  border: 1px solid #e5e7eb;
  background: white;
  color: #374151;
  border-radius: 0.5rem;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.pagination-btn:hover:not(.disabled):not(.active) {
  background: #f3f4f6;
  border-color: #d1d5db;
}
.pagination-btn.active {
  background: var(--grad);
  color: white;
  border-color: transparent;
}
.pagination-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>
<body class="bg-white">

<header class="text-center py-6 text-white relative" style="background: var(--grad)">
  <h1 class="text-2xl md:text-3xl font-extrabold">â™»ï¸ äºŒæ‰‹äº¤æ˜“</h1>
  <p class="opacity-90 text-sm mt-1">åˆŠç™»äºŒæ‰‹ç‰©å“ï¼Œé™„ä¸Šç…§ç‰‡ã€è¯çµ¡äººèˆ‡é›»è©±</p>
</header>

<main class="max-w-3xl mx-auto p-4 space-y-6 pb-20">
  <!-- æœå°‹æ¡†å’Œåˆ†é¡ç¯©é¸ -->
  <div class="search-container">
    <div class="grid grid-cols-3 gap-2">
      <input 
        type="text" 
        id="searchInput" 
        class="input" 
        placeholder="ğŸ” æœå°‹..."
        oninput="handleSearch()"
      >
      <select id="categoryFilter" class="input py-2 text-xs" onchange="handleCategoryFilter()">
        <option value="">åˆ†é¡</option>
        <option value="furniture">å‚¢ä¿±</option>
        <option value="electronics">3Cé›»å­</option>
        <option value="clothing">æœé£¾</option>
        <option value="books">æ›¸ç±</option>
        <option value="home">å±…å®¶</option>
        <option value="sports">é‹å‹•</option>
        <option value="vehicles">äº¤é€š</option>
        <option value="toys">ç©å…·</option>
        <option value="cosmetics">ç¾å¦</option>
        <option value="food">é£Ÿå“</option>
        <option value="other">å…¶ä»–</option>
      </select>
      <button onclick="openHelpModal()" class="btn py-2 px-2 text-xs whitespace-nowrap">
        ğŸ“– èªªæ˜
      </button>
    </div>
  </div>
  
  <!-- åˆŠç™»åˆ—è¡¨ -->
  <section class="space-y-3" id="listContainer" aria-live="polite"></section>
  
  <!-- åˆ†é å™¨ -->
  <div id="paginationContainer" class="mt-6 flex justify-center items-center gap-2 flex-wrap"></div>
  
  <!-- å…è²¬è²æ˜ï¼ˆé è¿‘åº•éƒ¨å°èˆªåˆ—ä¸Šæ–¹ï¼‰ -->
  <div class="mt-6 mb-20 p-2 bg-gray-50 border border-gray-200 rounded text-center">
    <p class="text-xs text-gray-500 leading-relaxed">
      <span class="text-gray-400">âš ï¸ å…è²¬è²æ˜ï¼š</span>æœ¬å¹³å°ç‚ºå…è²»é–‹æ”¾ä½¿ç”¨ï¼Œæ‰€æœ‰äº¤æ˜“è³‡è¨Šå‡ç”±ç”¨æˆ¶è‡ªè¡Œæä¾›ã€‚æœ¬ç«™åƒ…æä¾›è³‡è¨Šå±•ç¤ºå¹³å°ï¼Œä¸åƒèˆ‡ä»»ä½•äº¤æ˜“è¡Œç‚ºï¼Œä¸å°äº¤æ˜“çµæœæ‰¿æ“”ä»»ä½•è²¬ä»»ã€‚ä½¿ç”¨æœ¬å¹³å°å³è¡¨ç¤ºæ‚¨å·²é–±è®€ä¸¦åŒæ„æœ¬å…è²¬è²æ˜ã€‚
    </p>
  </div>
</main>

<!-- åœ–ç‰‡ç‡ˆç®± -->
<div id="lightboxOverlay" class="lightbox-overlay" onclick="closeLightboxOnOverlay(event)">
  <div class="lightbox-container" onclick="event.stopPropagation()">
    <button class="lightbox-close" onclick="closeLightbox()" aria-label="é—œé–‰">Ã—</button>
    <button class="lightbox-prev" onclick="lightboxPrev()" aria-label="ä¸Šä¸€å¼µ">â€¹</button>
    <button class="lightbox-next" onclick="lightboxNext()" aria-label="ä¸‹ä¸€å¼µ">â€º</button>
    <img id="lightboxImage" class="lightbox-image" src="" alt="">
    <div class="lightbox-counter" id="lightboxCounter"></div>
  </div>
</div>

<!-- æ–°å¢åˆŠç™»æŒ‰éˆ• -->
<button class="add-button" onclick="openModal()" aria-label="æ–°å¢åˆŠç™»" title="æ–°å¢åˆŠç™»">
  â•
</button>

<!-- åˆŠç™»è¡¨å–®å½ˆçª— -->
<div id="modalOverlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
  <div class="modal-content glass-card p-3 md:p-4" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()" aria-label="é—œé–‰">âœ•</button>
    <h2 class="text-base font-bold mb-2 md:mb-3">ğŸ“ æ–°å¢åˆŠç™»</h2>
    <form id="listingForm" class="space-y-2 md:space-y-2.5">
      <!-- ç¬¬ä¸€è¡Œï¼šç‰©å“åç¨±å’Œå”®åƒ¹ï¼ˆæ‰‹æ©Ÿå‚ç›´å †ç–Šï¼Œæ¡Œé¢ä¸¦æ’ï¼Œå”®åƒ¹å€åŸŸæ›´å¯¬ï¼‰ -->
      <div class="grid grid-cols-1 md:grid-cols-[1.1fr_1.4fr] gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">ç‰©å“åç¨± <span class="text-red-500">*</span> <span class="text-xs text-gray-400 font-normal">(æœ€å¤š10å­—)</span></label>
          <input id="itemTitle" type="text" class="input w-full min-w-0" placeholder="ä¾‹å¦‚ï¼šIKEA æ¡Œå­" maxlength="10" required>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">å”®åƒ¹ <span class="text-red-500">*</span></label>
          <div class="flex items-center gap-1.5">
            <span class="text-sm font-semibold text-gray-600 flex-shrink-0">$</span>
            <input id="itemPrice" type="number" class="input min-w-0" placeholder="0" min="0" step="1" required style="flex: 1 1 0; min-width: 5rem;">
            <select id="priceType" class="input flex-shrink-0 py-1" style="width: 5rem; font-size: 0.875rem;">
              <option value="fixed">å›ºå®š</option>
              <option value="negotiable">å¯è­°</option>
              <option value="free">å…è²»</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒè¡Œï¼šåˆ†é¡ï¼ˆå¿…å¡«ï¼‰ -->
      <div>
        <label class="block text-xs font-medium mb-0.5">åˆ†é¡ <span class="text-red-500">*</span></label>
        <select id="itemCategory" class="input py-1 w-full" required>
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          <option value="furniture">å‚¢ä¿±</option>
          <option value="electronics">3Cé›»å­</option>
          <option value="clothing">æœé£¾é…ä»¶</option>
          <option value="books">æ›¸ç±æ–‡å…·</option>
          <option value="home">å±…å®¶ç”¨å“</option>
          <option value="sports">é‹å‹•ä¼‘é–’</option>
          <option value="vehicles">äº¤é€šå·¥å…·</option>
          <option value="toys">ç©å…·æ¨¡å‹</option>
          <option value="cosmetics">ç¾å¦ä¿é¤Š</option>
          <option value="food">é£Ÿå“é£²æ–™</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      
      <!-- ç¬¬ä¸‰è¡Œï¼šæ•¸é‡ã€ç‹€æ…‹ã€äº¤æ˜“æ–¹å¼ï¼ˆæ‰‹æ©Ÿå’Œæ¡Œé¢éƒ½3æ¬„ä¸¦æ’ï¼‰ -->
      <div class="grid grid-cols-3 gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">æ•¸é‡</label>
          <input id="itemQuantity" type="number" class="input w-full min-w-0" placeholder="1" min="1" step="1" value="1">
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">ç‹€æ…‹</label>
          <select id="itemCondition" class="input py-1 w-full min-w-0">
            <option value="">è«‹é¸æ“‡</option>
            <option value="new">å…¨æ–°</option>
            <option value="like_new">è¿‘å…¨æ–°</option>
            <option value="good">è‰¯å¥½</option>
            <option value="fair">æ™®é€š</option>
            <option value="poor">æœ‰ä½¿ç”¨ç—•è·¡</option>
          </select>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">äº¤æ˜“æ–¹å¼</label>
          <select id="tradeMethod" class="input py-1 w-full min-w-0">
            <option value="">è«‹é¸æ“‡</option>
            <option value="face_to_face">é¢äº¤</option>
            <option value="shipping">éƒµå¯„</option>
            <option value="delivery">å®…é…</option>
            <option value="both">é¢äº¤/éƒµå¯„</option>
          </select>
        </div>
        <div class="col-span-2 md:col-span-1 min-w-0">
          <label class="block text-xs font-medium mb-0.5">äº¤æ˜“åœ°é» <span class="text-xs text-gray-400 font-normal">(æœ€å¤š6å­—ï¼Œå¯å¡«ã€Œå¯ä»¥ç§è«‡ã€ç§ç´„ã€)</span></label>
          <input id="tradeLocation" type="text" class="input w-full min-w-0" placeholder="å¯å¡«ã€Œå¯ä»¥ç§è«‡ã€ç§ç´„ã€" maxlength="6">
        </div>
      </div>

      <!-- ç¬¬ä¸‰è¡Œï¼šè¯çµ¡è³‡è¨Šï¼ˆ3æ¬„ä¸¦æ’ï¼‰ -->
      <div class="grid grid-cols-3 gap-2">
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">è¯çµ¡äºº <span class="text-red-500">*</span></label>
          <input id="contactName" type="text" class="input w-full min-w-0" placeholder="ç¨±å‘¼" maxlength="20" required>
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">é›»è©±</label>
          <input id="contactPhone" type="tel" class="input w-full min-w-0" placeholder="09xx-xxx-xxx" pattern="09\d{8}">
        </div>
        <div class="min-w-0">
          <label class="block text-xs font-medium mb-0.5">LINE ID</label>
          <input id="contactLineId" type="text" class="input w-full min-w-0" placeholder="LINE ID" maxlength="30">
        </div>
      </div>
      
      <!-- ç¬¬å››è¡Œï¼šç…§ç‰‡å’Œæè¿°ï¼ˆæ¡Œé¢ä¸¦æ’ï¼Œæ‰‹æ©Ÿå‚ç›´å †ç–Šï¼‰ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <label class="block text-xs font-medium mb-0.5">ç…§ç‰‡ <span class="text-xs text-gray-400 font-normal">(æœ€å¤š5å¼µ)</span></label>
          <input id="imageFile" type="file" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="input text-xs py-1">
          <div id="imagePreviewContainer" class="image-preview-container mt-1.5"></div>
        </div>
        <div>
          <label class="block text-xs font-medium mb-0.5">æè¿° <span class="text-xs text-gray-400 font-normal">(é¸å¡«ï¼Œæœ€å¤š20å­—)</span></label>
          <textarea id="itemDesc" class="input" rows="2" placeholder="ç‹€æ³ã€å°ºå¯¸ç­‰" maxlength="20"></textarea>
        </div>
      </div>
      
      <!-- ä¸‹æ¶å¯†ç¢¼ -->
      <div>
        <label class="block text-xs font-medium mb-0.5">ä¸‹æ¶å¯†ç¢¼ <span class="text-red-500">*</span> <span class="text-xs text-gray-400 font-normal">(ç”¨æ–¼ä¸‹æ¶æ­¤åˆŠç™»ï¼Œå¿…å¡«)</span></label>
        <input id="deletePassword" type="password" class="input" placeholder="è¨­å®šä¸‹æ¶å¯†ç¢¼ï¼ˆå»ºè­°4-8å­—ï¼‰" maxlength="20" required>
      </div>
      
      <!-- æŒ‰éˆ• -->
      <div class="flex items-center gap-2 pt-1">
        <button type="submit" class="btn flex-1 py-1.5 text-sm min-w-0 whitespace-nowrap">ç™¼å¸ƒ</button>
        <button type="button" onclick="closeModal()" class="px-3 py-1.5 rounded-lg border text-xs flex-shrink-0 whitespace-nowrap">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div id="toast" class="toast"></div>

<!-- ä¸‹æ¶å¯†ç¢¼è¼¸å…¥å½ˆçª— -->
<div id="deleteModalOverlay" class="modal-overlay" onclick="closeDeleteModalOnOverlay(event)">
  <div class="modal-content glass-card p-4" onclick="event.stopPropagation()" style="max-width: 400px;">
    <button class="modal-close" onclick="closeDeleteModal()" aria-label="é—œé–‰">âœ•</button>
    <h2 class="text-lg font-bold mb-3">ğŸ”’ è¼¸å…¥ä¸‹æ¶å¯†ç¢¼</h2>
    <form id="deletePasswordForm" onsubmit="submitDeletePassword(event); return false;">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">ä¸‹æ¶å¯†ç¢¼</label>
        <input id="deletePasswordInput" type="password" class="input" placeholder="è«‹è¼¸å…¥ä¸‹æ¶å¯†ç¢¼" required autofocus>
      </div>
      <div class="flex items-center gap-2">
        <button type="submit" class="btn flex-1 py-2">ç¢ºèªä¸‹æ¶</button>
        <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg border text-sm">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- ä½¿ç”¨èªªæ˜å½ˆçª— -->
<div id="helpModalOverlay" class="modal-overlay" onclick="closeHelpModalOnOverlay(event)">
  <div class="modal-content glass-card p-4 md:p-6" onclick="event.stopPropagation()" style="max-width: 600px;">
    <button class="modal-close" onclick="closeHelpModal()" aria-label="é—œé–‰">âœ•</button>
    <h2 class="text-xl font-bold mb-4">ğŸ“– ä½¿ç”¨èªªæ˜</h2>
    <div class="space-y-4 text-sm" style="max-height: 70vh; overflow-y: auto;">
      
      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ“ å¦‚ä½•åˆŠç™»å•†å“</h3>
        <ol class="list-decimal list-inside space-y-1.5 text-gray-700 ml-2">
          <li>é»æ“Šå³ä¸‹è§’ <span class="font-semibold">â•</span> æŒ‰éˆ•é–‹å•ŸåˆŠç™»è¡¨å–®</li>
          <li>å¡«å¯«å¿…å¡«é …ç›®ï¼šç‰©å“åç¨±ã€åˆ†é¡ã€å”®åƒ¹ã€è¯çµ¡äººã€ä¸‹æ¶å¯†ç¢¼</li>
          <li>å¡«å¯«é¸å¡«é …ç›®ï¼šæ•¸é‡ã€ç‹€æ…‹ã€äº¤æ˜“æ–¹å¼ã€äº¤æ˜“åœ°é»ã€é›»è©±ã€LINE IDã€æè¿°</li>
          <li>ä¸Šå‚³ç…§ç‰‡ï¼ˆæœ€å¤š5å¼µï¼Œå»ºè­°ä¸Šå‚³æ¸…æ™°çš„ç…§ç‰‡ï¼‰</li>
          <li>é»æ“Šã€Œç™¼å¸ƒã€æŒ‰éˆ•å®ŒæˆåˆŠç™»</li>
        </ol>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ” å¦‚ä½•æœå°‹å•†å“</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>ä½¿ç”¨æœå°‹æ¡†å¯æœå°‹ï¼šç‰©å“åç¨±ã€è¯çµ¡äººã€æè¿°ã€é›»è©±ã€LINE ID</li>
          <li>ä½¿ç”¨åˆ†é¡ä¸‹æ‹‰é¸å–®å¯ç¯©é¸ç‰¹å®šé¡åˆ¥çš„å•†å“</li>
          <li>æœå°‹å’Œåˆ†é¡å¯ä»¥åŒæ™‚ä½¿ç”¨</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ“¸ æŸ¥çœ‹å•†å“ç…§ç‰‡</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>é»æ“Šå•†å“å¡ç‰‡ä¸Šçš„ç…§ç‰‡ç¸®åœ–å¯ä»¥æ”¾å¤§æŸ¥çœ‹</li>
          <li>å¦‚æœæœ‰å¤šå¼µç…§ç‰‡ï¼Œå¯ä½¿ç”¨å·¦å³ç®­é ­æˆ–éµç›¤æ–¹å‘éµåˆ‡æ›</li>
          <li>é»æ“ŠèƒŒæ™¯æˆ–æŒ‰ ESC éµå¯é—œé–‰ç…§ç‰‡ç‡ˆç®±</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ“„ åˆ†é ç€è¦½</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>æ¯é é¡¯ç¤º 10 å€‹å•†å“</li>
          <li>ä½¿ç”¨åˆ†é æŒ‰éˆ•ï¼ˆ1, 2, 3...ï¼‰æˆ–ä¸Šä¸‹é ç®­é ­åˆ‡æ›é é¢</li>
          <li>åˆ†é æœƒä¿ç•™ç›®å‰çš„æœå°‹å’Œåˆ†é¡ç¯©é¸æ¢ä»¶</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ”’ å¦‚ä½•ä¸‹æ¶å•†å“</h3>
        <ol class="list-decimal list-inside space-y-1.5 text-gray-700 ml-2">
          <li>æ‰¾åˆ°è¦ä¸‹æ¶çš„å•†å“å¡ç‰‡</li>
          <li>é»æ“Šã€Œä¸‹æ¶ã€æŒ‰éˆ•</li>
          <li>è¼¸å…¥åˆŠç™»æ™‚è¨­å®šçš„ã€Œä¸‹æ¶å¯†ç¢¼ã€</li>
          <li>é»æ“Šã€Œç¢ºèªä¸‹æ¶ã€å³å¯ç§»é™¤å•†å“</li>
        </ol>
        <p class="text-xs text-gray-500 mt-2 ml-2">âš ï¸ ä¸‹æ¶å¯†ç¢¼ç„¡æ³•æ‰¾å›ï¼Œè«‹å¦¥å–„ä¿ç®¡</p>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">âš ï¸ é‡è¦æé†’</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li><span class="font-semibold">æ¯å€‹é›»è©±è™Ÿç¢¼æˆ– LINE ID åªèƒ½åˆŠç™»ä¸€å€‹æ´»èºå•†å“</span>ï¼ˆéœ€å…ˆä¸‹æ¶ç¾æœ‰å•†å“æ‰èƒ½åˆŠç™»æ–°çš„ï¼‰</li>
          <li>å•†å“åˆŠç™»å¾Œæœ‰æ•ˆæœŸç‚º 14 å¤©ï¼ŒéæœŸæœƒè‡ªå‹•éš±è—</li>
          <li>ç‰©å“åç¨±æœ€å¤š 10 å­—ã€æè¿°æœ€å¤š 20 å­—ã€äº¤æ˜“åœ°é»æœ€å¤š 6 å­—</li>
          <li>ç…§ç‰‡æœƒè‡ªå‹•å£“ç¸®ä»¥åŠ å¿«ä¸Šå‚³é€Ÿåº¦</li>
          <li>è«‹ç¢ºä¿å¡«å¯«çš„è¯çµ¡è³‡è¨Šæ­£ç¢ºï¼Œä»¥ä¾¿è²·å®¶è¯ç¹«</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-base mb-2 text-emerald-600">ğŸ“ è¯çµ¡è³£å®¶</h3>
        <ul class="list-disc list-inside space-y-1.5 text-gray-700 ml-2">
          <li>é»æ“Šé›»è©±è™Ÿç¢¼å¯ç›´æ¥æ’¥æ‰“é›»è©±</li>
          <li>è¤‡è£½ LINE ID ä¸¦åœ¨ LINE ä¸­æœå°‹åŠ å¥½å‹</li>
          <li>å¦‚è³£å®¶æœ‰è¨»æ˜ã€Œå¯ç§è«‡ã€ç§ç´„ã€ï¼Œè«‹é€éè¯çµ¡æ–¹å¼æ´½è«‡</li>
        </ul>
      </div>

      <div class="pt-2 border-t border-gray-200">
        <p class="text-xs text-gray-500">ğŸ’¡ æç¤ºï¼šä½¿ç”¨æ‰‹æ©Ÿç€è¦½æ™‚ï¼Œè¡¨å–®æœƒè‡ªå‹•èª¿æ•´ç‚ºé©åˆæ‰‹æ©Ÿè¼¸å…¥çš„ç·Šæ¹Šä½ˆå±€</p>
      </div>

      <div class="pt-3 border-t-2 border-red-200 bg-red-50 rounded-lg p-3">
        <h3 class="font-bold text-sm mb-2 text-red-700">âš ï¸ å…è²¬è²æ˜</h3>
        <div class="text-xs text-red-600 space-y-1">
          <p>â€¢ æœ¬å¹³å°ç‚º<strong>å…è²»é–‹æ”¾ä½¿ç”¨</strong>ï¼Œæ‰€æœ‰äº¤æ˜“è³‡è¨Šå‡ç”±ç”¨æˆ¶è‡ªè¡Œæä¾›ã€‚</p>
          <p>â€¢ æœ¬ç«™åƒ…æä¾›è³‡è¨Šå±•ç¤ºå¹³å°ï¼Œ<strong>ä¸åƒèˆ‡ä»»ä½•äº¤æ˜“è¡Œç‚º</strong>ï¼Œä¸å°äº¤æ˜“çµæœæ‰¿æ“”ä»»ä½•è²¬ä»»ã€‚</p>
          <p>â€¢ ç”¨æˆ¶éœ€è‡ªè¡Œåˆ¤æ–·äº¤æ˜“è³‡è¨Šçš„çœŸå¯¦æ€§ã€åˆæ³•æ€§å’Œå®‰å…¨æ€§ã€‚</p>
          <p>â€¢ æœ¬ç«™ä¸å°ä»»ä½•å› ä½¿ç”¨æœ¬å¹³å°è€Œç”¢ç”Ÿçš„ç›´æ¥æˆ–é–“æ¥æå¤±è² è²¬ã€‚</p>
          <p>â€¢ å¦‚ç™¼ç”Ÿäº¤æ˜“ç³¾ç´›ï¼Œè«‹ç”¨æˆ¶è‡ªè¡Œå”å•†è§£æ±ºï¼Œæœ¬ç«™ä¸ä»‹å…¥ä»»ä½•äº¤æ˜“ç³¾ç´›ã€‚</p>
          <p>â€¢ ä½¿ç”¨æœ¬å¹³å°å³è¡¨ç¤ºæ‚¨å·²é–±è®€ä¸¦åŒæ„æœ¬å…è²¬è²æ˜ã€‚</p>
        </div>
      </div>

    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="closeHelpModal()" class="btn py-2 px-6">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>
</div>

<!-- ğŸ“ åº•éƒ¨å°èˆª -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 flex justify-around py-2 bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
  <button onclick="scrollTo(0,0)" class="flex flex-col items-center text-indigo-600 text-xs hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="å›åˆ°é¦–é ">
    <span>ğŸ </span><span>é¦–é </span>
  </button>
  <button onclick="openTool('expense-tracker.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="è¨˜å¸³">
    <span>ğŸ“</span><span>è¨˜å¸³</span>
  </button>
  <button onclick="openTool('games.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="éŠæˆ²å¤§å»³">
    <span>ğŸ®</span><span>éŠæˆ²</span>
  </button>
  <button onclick="window.location.href='https://flyjung168.pages.dev/'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æˆ¿è¨Š">
    <span>ğŸ¹</span><span>æˆ¿è¨Š</span>
  </button>
  <button onclick="openTool('worship.html')" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æ‹œæ‹œå°ˆå€">
    <span>ğŸ™</span><span>æ‹œæ‹œ</span>
  </button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Google Sheets API è¨­å®šï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰ =====
const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbzN2osjThkZMIwAcwKPSQrQjzAYpoOdlKqzi-OGY4O2naNKC_8gF0y4evdZ4LFIt4fxZw/exec';
let useGoogleSheets = false;

if (GOOGLE_SHEETS_API_URL && GOOGLE_SHEETS_API_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
  useGoogleSheets = true;
  console.log('âœ… Google Sheets API å·²è¨­å®š');
}

// ===== Supabase è¨­å®šï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰ =====
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

let supabase = null;
let useSupabase = false;

try {
  if (SUPABASE_URL && SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    useSupabase = true;
    console.log('âœ… Supabase å·²åˆå§‹åŒ–');
  }
} catch (err) {
  console.error('âŒ Supabase åˆå§‹åŒ–å¤±æ•—:', err);
}

// ===== å…¨åŸŸè®Šæ•¸ =====
let allListings = []; // å„²å­˜æ‰€æœ‰åˆŠç™»ï¼ˆç”¨æ–¼æœå°‹ï¼‰
let selectedImages = []; // å„²å­˜é¸ä¸­çš„åœ–ç‰‡ï¼ˆbase64ï¼‰
let currentSearchQuery = '';
let currentCategoryFilter = ''; // ç•¶å‰åˆ†é¡ç¯©é¸
let currentPage = 1; // ç•¶å‰é ç¢¼
const ITEMS_PER_PAGE = 10; // æ¯é é¡¯ç¤ºçš„åˆŠç™»æ•¸é‡

// ===== å·¥å…·å‡½å¼ =====
function openTool(url) {
  if (url.startsWith('http')) {
    window.open(url, '_blank', 'noopener,noreferrer');
  } else {
    window.location.href = url;
  }
}

// Toast é€šçŸ¥
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// é©—è­‰é›»è©±æ ¼å¼
function validatePhone(phone) {
  const cleaned = phone.replace(/[-\s]/g, '');
  return /^09\d{8}$/.test(cleaned);
}

// é©—è­‰åœ–ç‰‡å¤§å°ï¼ˆ5MBï¼‰
function validateImageSize(file) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  return file.size <= maxSize;
}

// ===== åœ–ç‰‡å£“ç¸®åŠŸèƒ½ï¼ˆåŠ å¿«ä¸Šå‚³é€Ÿåº¦ï¼‰ =====
/**
 * å£“ç¸®åœ–ç‰‡ä»¥æ¸›å°‘ä¸Šå‚³å¤§å°
 * @param {File} file - åŸå§‹åœ–ç‰‡æª”æ¡ˆ
 * @param {number} maxWidth - æœ€å¤§å¯¬åº¦ï¼ˆé è¨­ 1920pxï¼‰
 * @param {number} maxHeight - æœ€å¤§é«˜åº¦ï¼ˆé è¨­ 1920pxï¼‰
 * @param {number} quality - JPEG å“è³ªï¼ˆ0-1ï¼Œé è¨­ 0.85ï¼‰
 * @returns {Promise<string>} å£“ç¸®å¾Œçš„ base64 å­—ä¸²
 */
function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        try {
          // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå¯¬é«˜æ¯”ï¼‰
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = width * ratio;
            height = height * ratio;
          }
          
          // å»ºç«‹ canvas é€²è¡Œå£“ç¸®
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // ç¹ªè£½ç¸®æ”¾å¾Œçš„åœ–ç‰‡
          ctx.drawImage(img, 0, 0, width, height);
          
          // è½‰æ›ç‚º JPEGï¼ˆé€šå¸¸æ¯” PNG å°ï¼Œé™¤éæ˜¯é€æ˜åœ–ç‰‡ï¼‰
          // ä½¿ç”¨ JPEG æ ¼å¼ä¸¦è¨­å®šå“è³ª
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          
          // è¨ˆç®—å£“ç¸®å¾Œçš„å¤§å°
          const originalSizeKB = (file.size / 1024).toFixed(2);
          const compressedSizeKB = ((compressedBase64.length * 3) / 4 / 1024).toFixed(2);
          const compressionRatio = ((1 - compressedBase64.length * 3 / 4 / file.size) * 100).toFixed(1);
          
          console.log(`ğŸ“¦ åœ–ç‰‡å£“ç¸®: ${file.name}`);
          console.log(`   åŸå§‹: ${originalSizeKB} KB â†’ å£“ç¸®å¾Œ: ${compressedSizeKB} KB (æ¸›å°‘ ${compressionRatio}%)`);
          
          resolve(compressedBase64);
        } catch (err) {
          console.error('å£“ç¸®å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹åœ–ç‰‡:', err);
          // å¦‚æœå£“ç¸®å¤±æ•—ï¼Œè¿”å›åŸå§‹ base64
          resolve(e.target.result);
        }
      };
      img.onerror = () => {
        reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
      };
      img.src = e.target.result;
    };
    reader.onerror = () => {
      reject(new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
    };
    reader.readAsDataURL(file);
  });
}

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
function getDaysRemaining(expiresAt) {
  if (!expiresAt) return null;
  const expires = new Date(expiresAt);
  const now = new Date();
  const diff = expires - now;
  const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
  return days;
}

// æ ¼å¼åŒ–å‰©é¤˜å¤©æ•¸é¡¯ç¤º
function formatDaysRemaining(days) {
  if (days === null || days === undefined) return null;
  if (days < 0) return { text: 'å·²éæœŸ', class: 'danger' };
  if (days <= 3) return { text: `å‰©${days}å¤©`, class: 'danger' };
  if (days <= 7) return { text: `å‰©${days}å¤©`, class: 'warning' };
  return { text: `å‰©${days}å¤©`, class: 'success' };
}

// ===== åœ–ç‰‡é è¦½ç®¡ç† =====
function setupImagePreview() {
  const fileInput = document.getElementById('imageFile');
  const previewContainer = document.getElementById('imagePreviewContainer');
  
  fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    
    // æª¢æŸ¥æ•¸é‡é™åˆ¶
    if (files.length + selectedImages.length > 5) {
      showToast('æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µç…§ç‰‡', 'error');
      fileInput.value = '';
      return;
    }
    
    // é¡¯ç¤ºå£“ç¸®æç¤º
    if (files.length > 0) {
      showToast('æ­£åœ¨å£“ç¸®åœ–ç‰‡ä»¥åŠ å¿«ä¸Šå‚³é€Ÿåº¦...', 'info');
    }
    
    // è™•ç†æ¯å€‹æª”æ¡ˆï¼ˆä½¿ç”¨ async/await ç¢ºä¿é †åºè™•ç†ï¼‰
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      // é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆåŸå§‹æª”æ¡ˆï¼‰
      if (!validateImageSize(file)) {
        showToast(`${file.name} æª”æ¡ˆéå¤§ï¼ˆä¸Šé™ 5MBï¼‰`, 'error');
        continue;
      }
      
      // é©—è­‰æª”æ¡ˆæ ¼å¼
      if (!file.type.startsWith('image/')) {
        showToast(`${file.name} æ ¼å¼ä¸ç¬¦ï¼ˆåƒ…æ”¯æ´åœ–ç‰‡ï¼‰`, 'error');
        continue;
      }
      
      try {
        // è‡ªå‹•å£“ç¸®åœ–ç‰‡ï¼ˆ1920px æœ€å¤§å°ºå¯¸ï¼Œ85% å“è³ªï¼‰
        // å¦‚æœåŸå§‹æª”æ¡ˆå·²ç¶“å¾ˆå°ï¼ˆ< 500KBï¼‰ï¼Œå¯ä»¥è·³éå£“ç¸®
        const shouldCompress = file.size > 500 * 1024; // è¶…é 500KB æ‰å£“ç¸®
        
        let base64;
        if (shouldCompress) {
          base64 = await compressImage(file, 1920, 1920, 0.85);
        } else {
          // å°æª”æ¡ˆç›´æ¥è®€å–
          base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }
        
        const imageData = {
          file: file,
          base64: base64,
          id: Date.now() + Math.random() + i
        };
        
        selectedImages.push(imageData);
        renderImagePreview();
      } catch (err) {
        console.error(`è™•ç†åœ–ç‰‡ ${file.name} å¤±æ•—:`, err);
        showToast(`${file.name} è™•ç†å¤±æ•—`, 'error');
      }
    }
    
    // æ¸…ç©º inputï¼ˆå…è¨±é‡é¸åŒä¸€æª”æ¡ˆï¼‰
    fileInput.value = '';
    
    if (files.length > 0) {
      showToast(`å·²è™•ç† ${files.length} å¼µåœ–ç‰‡`, 'success');
    }
  });
}

function renderImagePreview() {
  const container = document.getElementById('imagePreviewContainer');
  container.innerHTML = '';
  
  selectedImages.forEach((imgData, index) => {
    const item = document.createElement('div');
    item.className = 'image-preview-item';
    item.innerHTML = `
      <img src="${imgData.base64}" alt="é è¦½ ${index + 1}">
      <button type="button" class="remove-btn" onclick="removeImagePreview(${index})">Ã—</button>
    `;
    container.appendChild(item);
  });
  
  // é¡¯ç¤ºå‰©é¤˜å¯ä¸Šå‚³æ•¸é‡
  if (selectedImages.length > 0) {
    const remaining = 5 - selectedImages.length;
    const hint = document.createElement('div');
    hint.className = 'text-xs text-gray-500 mt-2';
    hint.textContent = `å·²é¸ ${selectedImages.length} å¼µï¼Œé‚„å¯ä¸Šå‚³ ${remaining} å¼µ`;
    container.appendChild(hint);
  }
}

function removeImagePreview(index) {
  selectedImages.splice(index, 1);
  renderImagePreview();
}

// ===== è³‡æ–™è®€å–èˆ‡å„²å­˜ =====
const STORAGE_KEY = 'secondHandListings_v1';
function readListingsLocal() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
}
function writeListingsLocal(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

async function readListings() {
  if (useGoogleSheets) {
    try {
      console.log('ğŸ” é–‹å§‹è®€å– Google Sheets:', GOOGLE_SHEETS_API_URL);
      
      // GET è«‹æ±‚ä¸éœ€è¦ mode: 'cors'ï¼Œå› ç‚º GET è«‹æ±‚é€šå¸¸ä¸æœƒè§¸ç™¼é æª¢
      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      console.log('ğŸ“¡ å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);
      console.log('ğŸ“¡ å›æ‡‰ headers:', [...response.headers.entries()]);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      console.log('ğŸ“„ å›æ‡‰å…§å®¹:', text.substring(0, 500));
      
      let result;
      try {
        result = JSON.parse(text);
        console.log('âœ… JSON è§£ææˆåŠŸ:', result);
      } catch (e) {
        console.error('âŒ è§£æ JSON å¤±æ•—:', e);
        console.error('åŸå§‹å›æ‡‰:', text);
        throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + text.substring(0, 100));
      }
      
      if (result.ok && result.list !== undefined) {
        // èª¿è©¦ï¼šæª¢æŸ¥è¿”å›çš„æ•¸æ“šæ ¼å¼
        console.log('ğŸ“‹ å¾ Google Sheets è®€å–çš„æ•¸æ“š:', result.list);
        
        // ç¢ºä¿æ¯å€‹é …ç›®éƒ½æœ‰æ­£ç¢ºçš„åœ–ç‰‡æ ¼å¼
        const processedList = result.list.map(item => {
          // ç¢ºä¿ images æ˜¯é™£åˆ—æ ¼å¼
          let images = item.images || [];
          // å¦‚æœæ²’æœ‰ images ä½†æœ‰ imageUrlï¼Œè½‰æ›æˆé™£åˆ—
          if (images.length === 0 && item.imageUrl) {
            images = [item.imageUrl];
          }
          
          // è½‰æ› Google Drive é€£çµæ ¼å¼ï¼Œç¢ºä¿å¯ä»¥æ­£å¸¸é¡¯ç¤º
          images = images.map(imgUrl => {
            if (!imgUrl || typeof imgUrl !== 'string' || imgUrl.trim() === '') return '';
            
            let url = imgUrl.trim();
            
            // å¦‚æœå·²ç¶“æ˜¯ Google Drive é€£çµï¼Œæå–æª”æ¡ˆ ID ä¸¦è½‰æ›æ ¼å¼
            let fileId = null;
            
            // æ ¼å¼ 1: https://drive.google.com/uc?export=view&id=FILE_ID
            if (url.includes('drive.google.com/uc?export=view&id=')) {
              fileId = url.match(/id=([^&]+)/)?.[1];
            }
            // æ ¼å¼ 2: https://drive.google.com/file/d/FILE_ID/view
            else if (url.includes('drive.google.com/file/d/')) {
              fileId = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            }
            // æ ¼å¼ 3: https://drive.google.com/open?id=FILE_ID
            else if (url.includes('drive.google.com/open?id=')) {
              fileId = url.match(/id=([^&]+)/)?.[1];
            }
            // æ ¼å¼ 4: ç›´æ¥åŒ…å«æª”æ¡ˆ ID (lh3æ ¼å¼)
            else if (url.includes('lh3.googleusercontent.com/d/')) {
              fileId = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            }
            
            // å¦‚æœæœ‰æª”æ¡ˆ IDï¼Œä½¿ç”¨å¤šç¨®æ ¼å¼å˜—è©¦ï¼ˆæœ€å¯é çš„æ˜¯ thumbnail æ ¼å¼ï¼‰
            if (fileId && fileId.length >= 25) {
              // å„ªå…ˆä½¿ç”¨ thumbnail æ ¼å¼ï¼ˆæœ€ç©©å®šï¼‰
              return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            
            // å…¶ä»–æ ¼å¼çš„é€£çµç›´æ¥è¿”å›
            return url;
          }).filter(Boolean); // éæ¿¾ç©ºå€¼
          
          // æ›´æ–° item çš„åœ–ç‰‡æ¬„ä½
          item.images = images;
          // ç¢ºä¿ imageUrl å­˜åœ¨ï¼ˆç”¨æ–¼å‘ä¸‹ç›¸å®¹ï¼‰
          if (!item.imageUrl && images.length > 0) {
            item.imageUrl = images[0];
          }
          
          // çµ±ä¸€æ¬„ä½åç¨±ï¼ˆå¾Œç«¯å¯èƒ½è¿”å› priceTypeï¼Œå‰ç«¯ä½¿ç”¨ priceTypeï¼‰
          if (item.priceType === undefined && item.price_type) {
            item.priceType = item.price_type;
          }
          if (item.quantity === undefined || item.quantity === null) {
            item.quantity = 1;
          }
          if (item.tradeMethod === undefined && item.trade_method) {
            item.tradeMethod = item.trade_method;
          }
          if (item.tradeLocation === undefined && item.trade_location) {
            item.tradeLocation = item.trade_location;
          }
          // åˆ†é¡æ¬„ä½ï¼ˆç¢ºä¿åˆ†é¡æ¬„ä½å­˜åœ¨ï¼‰
          if (!item.category) {
            item.category = '';
          }
          
          // èª¿è©¦ï¼šæª¢æŸ¥åœ–ç‰‡ URL æ˜¯å¦é‡è¤‡
          const uniqueImages = [...new Set(images)];
          if (uniqueImages.length !== images.length) {
            console.warn(`âš ï¸ ${item.title} æœ‰é‡è¤‡çš„åœ–ç‰‡ URL:`);
            console.warn('  åŸå§‹åœ–ç‰‡:', images);
            console.warn('  å»é‡å¾Œ:', uniqueImages);
            // å»é‡ï¼Œä¿ç•™é †åº
            const seen = new Set();
            images = images.filter(url => {
              if (seen.has(url)) return false;
              seen.add(url);
              return true;
            });
          }
          
          console.log(`ğŸ“¸ ${item.title} çš„åœ–ç‰‡ (${images.length} å¼µ):`, images);
          return item;
        });
        
        console.log('âœ… è™•ç†å¾Œçš„åˆ—è¡¨é•·åº¦:', processedList.length);
        return processedList;
      }
      
      // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
      if (!result.ok) {
        console.error('âŒ API è¿”å›éŒ¯èª¤:', result.error || 'æœªçŸ¥éŒ¯èª¤');
        throw new Error(result.error || 'è®€å–å¤±æ•—');
      }
      
      // å¦‚æœæ²’æœ‰ list æ¬„ä½
      if (result.list === undefined) {
        console.warn('âš ï¸ API å›æ‡‰æ ¼å¼ç•°å¸¸ï¼Œæ²’æœ‰ list æ¬„ä½:', result);
        return [];
      }
      
      throw new Error('è®€å–å¤±æ•—: ' + JSON.stringify(result));
    } catch (err) {
      console.error('âŒ è®€å– Google Sheets å¤±æ•—:', err);
      console.error('éŒ¯èª¤è©³æƒ…:', {
        message: err.message,
        stack: err.stack,
        name: err.name
      });
      
      // å¦‚æœæ˜¯ CORS éŒ¯èª¤æˆ–å…¶ä»–ç¶²è·¯éŒ¯èª¤ï¼Œé™ç´šåˆ° localStorage ä¸¦é¡¯ç¤ºæç¤º
      const isCorsError = err.message && (
        err.message.includes('CORS') || 
        err.message.includes('fetch') ||
        err.message.includes('Failed to fetch') ||
        err.message.includes('network') ||
        err.message.includes('ERR_') ||
        err.message.includes('NETWORK_ERROR')
      );
      
      if (isCorsError) {
        console.warn('âš ï¸ CORS æˆ–ç¶²è·¯éŒ¯èª¤ï¼šGoogle Apps Script éœ€è¦æ­£ç¢ºè¨­å®š CORSã€‚æ”¹ç”¨ localStorageã€‚');
        showToast('ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼', 'warning');
        return readListingsLocal();
      }
      
      // å…¶ä»–éŒ¯èª¤ä¹Ÿé™ç´šï¼Œä½†é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
      console.warn('âš ï¸ è®€å–å¤±æ•—ï¼Œæ”¹ç”¨ localStorage');
      showToast(`è®€å–å¤±æ•—: ${err.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      return readListingsLocal();
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) throw error;
      return (data || []).map(item => ({
        id: item.id,
        title: item.title,
        name: item.contact_name,
        phone: item.contact_phone || '',
        lineId: item.line_id || '',
        images: item.image_url ? [item.image_url] : [],
        imageUrl: item.image_url || '',
        desc: item.description,
        createdAt: new Date(item.created_at).getTime(),
        expiresAt: null
      }));
    } catch (err) {
      console.error('è®€å– Supabase å¤±æ•—:', err);
    }
  }
  
  return readListingsLocal();
}

async function addListing(listing, imageBase64List = []) {
  if (useGoogleSheets) {
    try {
      const payload = {
        title: listing.title,
        contact_name: listing.name,
        contact_phone: listing.phone,
        description: listing.desc || '',
        imageUrls: listing.imageUrls || [],
        imageBase64List: imageBase64List
      };

      // ä½¿ç”¨ FormDataï¼ˆé¿å… CORS é æª¢è«‹æ±‚ï¼‰
      const fd = new FormData();
      fd.append('title', listing.title);
      fd.append('contact_name', listing.name);
      fd.append('contact_phone', listing.phone || '');
      fd.append('line_id', listing.lineId || '');
      fd.append('description', listing.desc || '');
      fd.append('price', listing.price || 0);
      fd.append('price_type', listing.priceType || 'fixed');
      fd.append('quantity', listing.quantity || 1);
      fd.append('condition', listing.condition || '');
      fd.append('trade_method', listing.tradeMethod || '');
      fd.append('trade_location', listing.tradeLocation || '');
      fd.append('category', listing.category || '');
      fd.append('delete_password', listing.deletePassword || '');
      fd.append('imageBase64List', JSON.stringify(imageBase64List));
      fd.append('imageUrls', JSON.stringify(listing.imageUrls || []));

      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        body: fd,
        redirect: 'follow'
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      // å˜—è©¦è§£æå›æ‡‰
      const text = await response.text();
      let result;
      try {
        result = JSON.parse(text);
      } catch (e) {
        // å¦‚æœå›æ‡‰ä¸æ˜¯ JSONï¼Œå¯èƒ½è¡¨ç¤ºæˆåŠŸæˆ–éœ€è¦é‡æ–°å°å‘
        console.warn('å›æ‡‰ä¸æ˜¯ JSON æ ¼å¼:', text.substring(0, 100));
        // æª¢æŸ¥æ˜¯å¦ç‚ºé‡æ–°å°å‘å¾Œçš„é é¢
        if (text.includes('Google') || response.redirected) {
          // å¯èƒ½æ˜¯é‡æ–°å°å‘åˆ°ç¢ºèªé é¢ï¼Œå˜—è©¦å†æ¬¡è®€å–
          console.log('æª¢æ¸¬åˆ°é‡æ–°å°å‘ï¼Œå‡è¨­æäº¤æˆåŠŸ');
          return { ok: true };
        }
        throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
      }
      
      if (result.ok) {
        return result;
      }
      throw new Error(result.error || 'æ–°å¢å¤±æ•—');
    } catch (err) {
      console.error('æ–°å¢åˆ° Google Sheets å¤±æ•—:', err);
      
      // å¦‚æœæ˜¯ CORS éŒ¯èª¤ï¼Œæä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
      const isCorsError = err.message && (
        err.message.includes('CORS') || 
        err.message.includes('Failed to fetch') ||
        err.message.includes('network')
      );
      
      if (isCorsError) {
        const corsError = new Error('CORS éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Google Apps Script çš„éƒ¨ç½²è¨­å®šï¼ˆå¿…é ˆè¨­å®šç‚ºã€Œæ‰€æœ‰äººå¯å­˜å–ã€ä¸¦åŒ…å« doOptions å‡½æ•¸ï¼‰');
        corsError.isCorsError = true;
        throw corsError;
      }
      
      throw err;
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { data, error } = await supabase
        .from('second_hand_listings')
        .insert([{
          title: listing.title,
          contact_name: listing.name,
          contact_phone: listing.phone,
          image_url: listing.imageUrl || null,
          description: listing.desc || null
        }])
        .select();
      if (error) throw error;
      return data && data[0];
    } catch (err) {
      console.error('æ–°å¢åˆ° Supabase å¤±æ•—:', err);
    }
  }
  
  const list = readListingsLocal();
  list.unshift(listing);
  writeListingsLocal(list);
  return listing;
}

// ç•¶å‰è¦ä¸‹æ¶çš„åˆŠç™» ID
let currentDeleteId = null;

// é¡¯ç¤ºä¸‹æ¶å¯†ç¢¼è¼¸å…¥å½ˆçª—
function showDeleteModal(idOrIndex) {
  currentDeleteId = idOrIndex;
  const overlay = document.getElementById('deleteModalOverlay');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  document.getElementById('deletePasswordInput').value = '';
  setTimeout(() => {
    document.getElementById('deletePasswordInput').focus();
  }, 100);
}

// é—œé–‰ä¸‹æ¶å¯†ç¢¼è¼¸å…¥å½ˆçª—
function closeDeleteModal() {
  const overlay = document.getElementById('deleteModalOverlay');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
  currentDeleteId = null;
  document.getElementById('deletePasswordInput').value = '';
}

function closeDeleteModalOnOverlay(event) {
  if (event.target.id === 'deleteModalOverlay') {
    closeDeleteModal();
  }
}

// æäº¤ä¸‹æ¶å¯†ç¢¼
async function submitDeletePassword(e) {
  e.preventDefault();
  const password = document.getElementById('deletePasswordInput').value.trim();
  
  if (!password) {
    showToast('è«‹è¼¸å…¥ä¸‹æ¶å¯†ç¢¼', 'error');
    return;
  }
  
  if (!currentDeleteId) {
    showToast('æ‰¾ä¸åˆ°è¦ä¸‹æ¶çš„åˆŠç™»', 'error');
    return;
  }
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'é©—è­‰ä¸­...';
  
  try {
    const success = await removeListingById(currentDeleteId, password);
    if (success) {
      showToast('å·²ä¸‹æ¶åˆŠç™»', 'success');
      closeDeleteModal();
      // å¦‚æœç•¶å‰é æ²’æœ‰æ•¸æ“šäº†ï¼Œå›åˆ°ä¸Šä¸€é 
      const container = document.getElementById('listContainer');
      const cards = container.querySelectorAll('.card');
      if (cards.length === 1 && currentPage > 1) {
        await renderListings(null, currentPage - 1);
      } else {
        await renderListings(null, currentPage);
      }
    } else {
      showToast('ä¸‹æ¶å¯†ç¢¼éŒ¯èª¤', 'error');
      document.getElementById('deletePasswordInput').value = '';
      document.getElementById('deletePasswordInput').focus();
    }
  } catch (err) {
    console.error('ä¸‹æ¶å¤±æ•—:', err);
    showToast('ä¸‹æ¶å¤±æ•—ï¼š' + (err.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
}

async function removeListingById(id, password = '') {
  if (useGoogleSheets) {
    try {
      // èª¿è©¦ï¼šè¼¸å‡ºå¯†ç¢¼è³‡è¨Š
      console.log('ğŸ”’ ä¸‹æ¶è«‹æ±‚:', {
        id: id,
        password: password,
        passwordLength: password.length,
        passwordType: typeof password
      });
      
      const fd = new FormData();
      fd.append('action', 'delete');
      fd.append('id', id);
      fd.append('password', password);
      const response = await fetch(GOOGLE_SHEETS_API_URL, {
        method: 'POST',
        body: fd,
        redirect: 'follow'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      let result;
      try {
        result = JSON.parse(text);
        // èª¿è©¦ï¼šè¼¸å‡ºå›æ‡‰çµæœ
        console.log('ğŸ”’ ä¸‹æ¶å›æ‡‰:', result);
      } catch (e) {
        console.warn('å›æ‡‰ä¸æ˜¯ JSON æ ¼å¼:', text.substring(0, 100));
        return false;
      }
      
      if (result.ok && result.deleted) {
        return true;
      }
      
      if (result.error && (result.error.includes('å¯†ç¢¼') || result.error.includes('éŒ¯èª¤'))) {
        console.warn('âŒ ä¸‹æ¶å¯†ç¢¼éŒ¯èª¤:', result.error);
        return false;
      }
      
      return false;
    } catch (err) {
      console.error('å¾ Google Sheets ä¸‹æ¶å¤±æ•—:', err);
      throw err;
    }
  }
  
  if (useSupabase && supabase) {
    try {
      const { error } = await supabase.from('second_hand_listings').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) {
      console.error('å¾ Supabase åˆªé™¤å¤±æ•—:', err);
      throw err;
    }
  }
  
  return false;
}

// ===== åœ–ç‰‡è¼ªæ’­åŠŸèƒ½ =====
function initImageCarousel(containerId, images) {
  if (!images || images.length === 0) return;
  
  let currentIndex = 0;
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const imgElements = container.querySelectorAll('img');
  const dots = container.querySelectorAll('.carousel-dot');
  
  function showImage(index) {
    imgElements.forEach((img, i) => {
      img.classList.toggle('active', i === index);
    });
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
  }
  
  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    showImage(currentIndex);
  }
  
  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showImage(currentIndex);
  }
  
  container.querySelector('.carousel-next')?.addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼åœ–ç‰‡é»æ“Š
    nextImage();
  });
  container.querySelector('.carousel-prev')?.addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼åœ–ç‰‡é»æ“Š
    prevImage();
  });
  
  dots.forEach((dot, i) => {
    dot.addEventListener('click', (e) => {
      e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼åœ–ç‰‡é»æ“Š
      currentIndex = i;
      showImage(currentIndex);
    });
  });
  
  showImage(0);
}

// ===== æ¸²æŸ“åˆŠç™»åˆ—è¡¨ =====
async function renderListings(filteredList = null, page = 1) {
  const container = document.getElementById('listContainer');
  if (!container) {
    console.error('âŒ æ‰¾ä¸åˆ° listContainer å…ƒç´ ');
    return;
  }
  container.innerHTML = '<div class="text-center text-sm text-gray-500">è¼‰å…¥ä¸­...</div>';
  
  try {
    console.log('ğŸ¨ é–‹å§‹æ¸²æŸ“åˆ—è¡¨...');
    let list = filteredList || await readListings();
    console.log('ğŸ“Š è®€å–åˆ°çš„åˆ—è¡¨:', list);
    
    // å¦‚æœæ²’æœ‰éæ¿¾åˆ—è¡¨ï¼Œå‰‡æ›´æ–° allListingsï¼ˆç”¨æ–¼æœå°‹ï¼‰
    if (!filteredList) {
      allListings = list;
    }
    
    // éæ¿¾éæœŸé …ç›®ï¼ˆå‰ç«¯éæ¿¾ï¼‰
    const now = Date.now();
    list = list.filter(item => {
      if (!item.expiresAt) return true;
      const expires = new Date(item.expiresAt).getTime();
      return expires > now;
    });
    
    if (list.length === 0) {
      container.innerHTML = '<div class="text-center text-sm text-gray-500">å°šç„¡åˆŠç™»ï¼Œå¿«ä¾†æˆç‚ºç¬¬ä¸€ä½ï¼</div>';
      document.getElementById('paginationContainer').innerHTML = '';
      return;
    }
    
    // è¨ˆç®—åˆ†é 
    const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
    currentPage = Math.max(1, Math.min(page, totalPages)); // ç¢ºä¿é ç¢¼åœ¨æœ‰æ•ˆç¯„åœå…§
    
    // è¨ˆç®—ç•¶å‰é çš„æ•¸æ“šç¯„åœ
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const pageList = list.slice(startIndex, endIndex);
    
    console.log(`ğŸ“„ åˆ†é è³‡è¨Š: ç¸½å…± ${list.length} ç­†ï¼Œæ¯é  ${ITEMS_PER_PAGE} ç­†ï¼Œå…± ${totalPages} é ï¼Œç•¶å‰ç¬¬ ${currentPage} é `);
    
    // æ¸²æŸ“ç•¶å‰é çš„å¡ç‰‡
    container.innerHTML = pageList.map((it, idx) => {
      const images = it.images || (it.imageUrl ? [it.imageUrl] : []);
      const daysRemaining = getDaysRemaining(it.expiresAt);
      const daysInfo = formatDaysRemaining(daysRemaining);
      const carouselId = `carousel-${it.id || idx}`;
      
      // é™åˆ¶æè¿°ç‚º50å­—
      const descText = it.desc ? escapeHtml(it.desc).substring(0, 20) + (it.desc.length > 20 ? '...' : '') : '';
      
      return `
        <div class="card">
          <div class="flex gap-3 items-start">
            ${images.length > 0 ? `
              <div class="w-24 h-24 md:w-20 md:h-20 flex-shrink-0 relative">
                <img src="${images[0]}" class="w-full h-full object-cover rounded cursor-pointer hover:opacity-90 transition-opacity" alt="${it.title}" data-images='${JSON.stringify(images).replace(/"/g, '&quot;')}' data-index="0" onclick="handleImageClick(this)" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Crect width=\\'100\\' height=\\'100\\' fill=\\'%23e5e7eb\\'/%3E%3Ctext x=\\'50\\' y=\\'50\\' text-anchor=\\'middle\\' fill=\\'%239ca3af\\'%3Eç„¡åœ–%3C/text%3E%3C/svg%3E'">
                ${images.length > 1 ? `<div class="absolute top-0.5 right-0.5 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded-full font-bold">${images.length}</div>` : ''}
              </div>
            ` : `
              <div class="w-24 h-24 md:w-20 md:h-20 bg-gray-100 rounded flex items-center justify-center text-gray-400 flex-shrink-0 text-xs">
                ç„¡åœ–
              </div>
            `}
            <div class="flex-1 min-w-0">
              <!-- ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œå’Œåƒ¹æ ¼ -->
              <div class="flex items-start justify-between gap-2 mb-1">
                <div class="font-bold text-base md:text-lg flex-1 min-w-0">${escapeHtml(it.title)}</div>
                ${it.price !== undefined && it.price !== null && it.price !== '' && it.price !== 0 ? `
                  <div class="flex-shrink-0 text-right">
                    <div class="text-lg md:text-xl font-bold text-emerald-600">$${parseInt(it.price || 0).toLocaleString()}</div>
                    ${it.priceType ? `<div class="text-xs text-gray-500">${it.priceType === 'negotiable' ? 'å¯è­°' : it.priceType === 'free' ? 'å…è²»' : ''}</div>` : ''}
                  </div>
                ` : it.priceType === 'free' ? `
                  <div class="flex-shrink-0 text-right">
                    <div class="text-lg md:text-xl font-bold text-emerald-600">å…è²»</div>
                  </div>
                ` : ''}
              </div>
              
              <!-- ç¬¬äºŒè¡Œï¼šåˆ†é¡ã€å‰©é¤˜å¤©æ•¸ã€ç‹€æ…‹ã€äº¤æ˜“æ–¹å¼ã€åœ°é» -->
              <div class="flex flex-wrap items-center gap-2 text-xs mb-1.5">
                ${it.category ? `<span class="px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-medium">ğŸ·ï¸ ${getCategoryText(it.category)}</span>` : ''}
                ${daysInfo ? `<span class="expires-badge ${daysInfo.class}">${daysInfo.text}</span>` : ''}
                ${it.quantity && it.quantity > 1 ? `<span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded">æ•¸é‡ï¼š${it.quantity}</span>` : ''}
                ${it.condition ? `<span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">${getConditionText(it.condition)}</span>` : ''}
                ${it.tradeMethod ? `<span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">${getTradeMethodText(it.tradeMethod)}</span>` : ''}
                ${it.tradeLocation ? `<span class="text-gray-500">ğŸ“ ${escapeHtml(it.tradeLocation)}</span>` : ''}
              </div>
              
              <!-- ç¬¬ä¸‰è¡Œï¼šæè¿°ï¼ˆé™50å­—ï¼‰ -->
              ${descText ? `<div class="text-sm text-gray-600 mb-1.5 line-clamp-1">${descText}</div>` : ''}
              
              <!-- ç¬¬å››è¡Œï¼šè¯çµ¡è³‡è¨Š -->
              <div class="text-xs mt-1.5 flex flex-wrap items-center gap-1.5">
                <span class="text-gray-700">ğŸ‘¤ ${escapeHtml(it.name)}</span>
                ${it.phone ? `<a href="tel:${escapeHtml(it.phone)}" class="text-emerald-600">ğŸ“ ${escapeHtml(it.phone)}</a>` : ''}
                ${it.lineId ? `<span class="text-emerald-600">ğŸ’¬ ${escapeHtml(it.lineId)}</span>` : ''}
              </div>
            </div>
            <button class="text-xs text-red-600 hover:text-red-700 px-2 py-1 flex-shrink-0" onclick="showDeleteModal('${it.id || it.createdAt}')">ä¸‹æ¶</button>
          </div>
        </div>
      `;
    }).join('');
    
    // æ¸²æŸ“åˆ†é å™¨
    renderPagination(totalPages, currentPage, list.length);
    
  } catch (err) {
    console.error('âŒ æ¸²æŸ“åˆ—è¡¨å¤±æ•—:', err);
    console.error('éŒ¯èª¤è©³æƒ…:', {
      message: err.message,
      stack: err.stack,
      name: err.name
    });
    const errorMsg = err.message || 'æœªçŸ¥éŒ¯èª¤';
    container.innerHTML = `<div class="text-center text-sm text-red-500 p-4">
      <div>è¼‰å…¥å¤±æ•—</div>
      <div class="text-xs mt-2 text-gray-500">${errorMsg}</div>
      <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">é‡æ–°è¼‰å…¥</button>
    </div>`;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// å–å¾—ç‰©å“ç‹€æ…‹æ–‡å­—
function getConditionText(condition) {
  const conditions = {
    'new': 'å…¨æ–°',
    'like_new': 'è¿‘å…¨æ–°',
    'good': 'è‰¯å¥½',
    'fair': 'æ™®é€š',
    'poor': 'æœ‰ä½¿ç”¨ç—•è·¡'
  };
  return conditions[condition] || condition;
}

// å–å¾—äº¤æ˜“æ–¹å¼æ–‡å­—
function getTradeMethodText(method) {
  const methods = {
    'face_to_face': 'é¢äº¤',
    'shipping': 'éƒµå¯„',
    'delivery': 'å®…é…',
    'both': 'é¢äº¤/éƒµå¯„'
  };
  return methods[method] || method;
}

// å–å¾—åˆ†é¡æ–‡å­—
function getCategoryText(category) {
  const categories = {
    'furniture': 'å‚¢ä¿±',
    'electronics': '3Cé›»å­',
    'clothing': 'æœé£¾é…ä»¶',
    'books': 'æ›¸ç±æ–‡å…·',
    'home': 'å±…å®¶ç”¨å“',
    'sports': 'é‹å‹•ä¼‘é–’',
    'vehicles': 'äº¤é€šå·¥å…·',
    'toys': 'ç©å…·æ¨¡å‹',
    'cosmetics': 'ç¾å¦ä¿é¤Š',
    'food': 'é£Ÿå“é£²æ–™',
    'other': 'å…¶ä»–'
  };
  return categories[category] || category || 'æœªåˆ†é¡';
}


// ===== åˆ†é åŠŸèƒ½ =====
function renderPagination(totalPages, currentPage, totalItems) {
  const container = document.getElementById('paginationContainer');
  if (!container) return;
  
  // å¦‚æœåªæœ‰ä¸€é æˆ–æ²’æœ‰æ•¸æ“šï¼Œä¸é¡¯ç¤ºåˆ†é å™¨
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let paginationHTML = '<div class="pagination">';
  
  // ä¸Šä¸€é æŒ‰éˆ•
  paginationHTML += `<button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>â€¹</button>`;
  
  // é ç¢¼æŒ‰éˆ•
  const maxVisiblePages = 9; // æœ€å¤šé¡¯ç¤º 9 å€‹é ç¢¼æŒ‰éˆ•
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  // èª¿æ•´èµ·å§‹é ï¼Œç¢ºä¿é¡¯ç¤ºè¶³å¤ çš„é ç¢¼
  if (endPage - startPage < maxVisiblePages - 1) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  // å¦‚æœèµ·å§‹é ä¸æ˜¯ç¬¬ä¸€é ï¼Œé¡¯ç¤ºç¬¬ä¸€é å’Œçœç•¥è™Ÿ
  if (startPage > 1) {
    paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
    if (startPage > 2) {
      paginationHTML += `<span class="pagination-btn disabled">...</span>`;
    }
  }
  
  // é¡¯ç¤ºé ç¢¼ç¯„åœ
  for (let i = startPage; i <= endPage; i++) {
    paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
  }
  
  // å¦‚æœçµæŸé ä¸æ˜¯æœ€å¾Œä¸€é ï¼Œé¡¯ç¤ºçœç•¥è™Ÿå’Œæœ€å¾Œä¸€é 
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      paginationHTML += `<span class="pagination-btn disabled">...</span>`;
    }
    paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
  }
  
  // ä¸‹ä¸€é æŒ‰éˆ•
  paginationHTML += `<button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>â€º</button>`;
  
  paginationHTML += '</div>';
  
  // é¡¯ç¤ºç¸½æ•¸è³‡è¨Š
  const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
  const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
  paginationHTML += `<div class="text-center text-sm text-gray-500 mt-2">é¡¯ç¤º ${startItem}-${endItem} / å…± ${totalItems} ç­†</div>`;
  
  container.innerHTML = paginationHTML;
}

function goToPage(page) {
  if (page < 1) return;
  
  // æ‡‰ç”¨æ‰€æœ‰ç¯©é¸æ¢ä»¶
  let filtered = allListings;
  
  // åˆ†é¡ç¯©é¸
  if (currentCategoryFilter) {
    filtered = filtered.filter(item => item.category === currentCategoryFilter);
  }
  
  // æœå°‹ç¯©é¸
  if (currentSearchQuery) {
    filtered = filtered.filter(item => {
      return item.title.toLowerCase().includes(currentSearchQuery) ||
             item.name.toLowerCase().includes(currentSearchQuery) ||
             (item.desc && item.desc.toLowerCase().includes(currentSearchQuery)) ||
             (item.phone && item.phone.includes(currentSearchQuery)) ||
             (item.lineId && item.lineId.toLowerCase().includes(currentSearchQuery));
    });
  }
  
  renderListings(filtered, page);
  
  // æ»¾å‹•åˆ°åˆ—è¡¨é ‚éƒ¨
  document.getElementById('listContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== åˆ†é¡ç¯©é¸åŠŸèƒ½ =====
function handleCategoryFilter() {
  const category = document.getElementById('categoryFilter').value;
  currentCategoryFilter = category;
  currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
  
  applyFilters();
}

// æ‡‰ç”¨æœå°‹å’Œåˆ†é¡ç¯©é¸
function applyFilters() {
  let filtered = allListings;
  
  // æ‡‰ç”¨åˆ†é¡ç¯©é¸
  if (currentCategoryFilter) {
    filtered = filtered.filter(item => item.category === currentCategoryFilter);
  }
  
  // æ‡‰ç”¨æœå°‹ç¯©é¸
  if (currentSearchQuery) {
    filtered = filtered.filter(item => {
      return item.title.toLowerCase().includes(currentSearchQuery) ||
             item.name.toLowerCase().includes(currentSearchQuery) ||
             (item.desc && item.desc.toLowerCase().includes(currentSearchQuery)) ||
             (item.phone && item.phone.includes(currentSearchQuery)) ||
             (item.lineId && item.lineId.toLowerCase().includes(currentSearchQuery));
    });
  }
  
  renderListings(filtered, 1);
}

// ===== æœå°‹åŠŸèƒ½ =====
function handleSearch() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  currentSearchQuery = query;
  currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
  
  applyFilters();
}

// ===== å½ˆçª—æ§åˆ¶ =====
function openModal() {
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('listingForm').reset();
  selectedImages = [];
  renderImagePreview();
}

function closeModalOnOverlay(event) {
  if (event.target.id === 'modalOverlay') {
    closeModal();
  }
}

// ä½¿ç”¨èªªæ˜å½ˆçª—æ§åˆ¶
function openHelpModal() {
  document.getElementById('helpModalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeHelpModal() {
  document.getElementById('helpModalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

function closeHelpModalOnOverlay(event) {
  if (event.target.id === 'helpModalOverlay') {
    closeHelpModal();
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    // å„ªå…ˆé—œé–‰ä½¿ç”¨èªªæ˜å½ˆçª—ï¼Œå¦‚æœæ²’æœ‰æ‰“é–‹å‰‡é—œé–‰åˆŠç™»è¡¨å–®
    if (document.getElementById('helpModalOverlay').classList.contains('active')) {
      closeHelpModal();
    } else if (document.getElementById('modalOverlay').classList.contains('active')) {
      closeModal();
    } else if (document.getElementById('deleteModalOverlay').classList.contains('active')) {
      closeDeleteModal();
    }
  }
});

// ===== è¡¨å–®æäº¤ =====
document.getElementById('listingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('itemTitle').value.trim();
  const name = document.getElementById('contactName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim().replace(/[-\s]/g, '');
  const lineId = document.getElementById('contactLineId').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const price = document.getElementById('itemPrice').value.trim();
  const priceType = document.getElementById('priceType').value;
  const quantity = document.getElementById('itemQuantity').value.trim() || '1';
  const condition = document.getElementById('itemCondition').value;
  const tradeMethod = document.getElementById('tradeMethod').value;
  const tradeLocation = document.getElementById('tradeLocation').value.trim();
  const category = document.getElementById('itemCategory').value;
  const deletePassword = document.getElementById('deletePassword').value.trim();
  
  // é©—è­‰åˆ†é¡ï¼ˆå¿…å¡«ï¼‰
  if (!category || category === '') {
    showToast('è«‹é¸æ“‡åˆ†é¡', 'error');
    return;
  }
  
  // é©—è­‰
  if (!title || !name) {
    showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½', 'error');
    return;
  }
  
  // é©—è­‰ä¸‹æ¶å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰
  if (!deletePassword || deletePassword.trim() === '') {
    showToast('è«‹è¨­å®šä¸‹æ¶å¯†ç¢¼', 'error');
    return;
  }
  
  // é©—è­‰å”®åƒ¹
  if (!price || price <= 0) {
    if (priceType !== 'free') {
      showToast('è«‹è¼¸å…¥å”®åƒ¹', 'error');
      return;
    }
  }
  
  // é›»è©±æˆ– LINE ID è‡³å°‘å¡«å¯«ä¸€å€‹
  if (!phone && !lineId) {
    showToast('è«‹å¡«å¯«é›»è©±æˆ– LINE IDï¼ˆè‡³å°‘å¡«å¯«ä¸€å€‹ï¼‰', 'error');
    return;
  }
  
  if (title.length > 10) {
    showToast('ç‰©å“åç¨±éé•·ï¼ˆæœ€å¤š10å­—ï¼‰', 'error');
    return;
  }
  
  // å¦‚æœæœ‰å¡«å¯«é›»è©±ï¼Œå‰‡é©—è­‰æ ¼å¼
  if (phone && !validatePhone(phone)) {
    showToast('é›»è©±æ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚º 09xx-xxx-xxxï¼‰', 'error');
    return;
  }
  
  if (lineId && lineId.length > 30) {
    showToast('LINE ID éé•·ï¼ˆæœ€å¤š30å­—ï¼‰', 'error');
    return;
  }
  
  if (desc.length > 20) {
    showToast('æè¿°éé•·ï¼ˆæœ€å¤š20å­—ï¼‰', 'error');
    return;
  }
  
  if (tradeLocation.length > 6) {
    showToast('äº¤æ˜“åœ°é»éé•·ï¼ˆæœ€å¤š6å­—ï¼‰', 'error');
    return;
  }
  
  if (selectedImages.length === 0) {
    showToast('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡', 'warning');
    return;
  }

  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  
  // è¨ˆç®—ç¸½åœ–ç‰‡å¤§å°ï¼ˆç”¨æ–¼é¡¯ç¤ºä¸Šå‚³é€²åº¦ï¼‰
  const totalImageSize = selectedImages.reduce((sum, img) => {
    return sum + (img.base64.length * 3 / 4); // base64 å¤§å°ç´„ç‚ºåŸå§‹å¤§å°çš„ 1.33 å€
  }, 0);
  const totalSizeMB = (totalImageSize / 1024 / 1024).toFixed(2);
  
  // æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼Œé¡¯ç¤ºä¸Šå‚³å¤§å°
  submitBtn.textContent = `ä¸Šå‚³ä¸­... (${totalSizeMB} MB)`;

  try {
    const imageBase64List = selectedImages.map(img => img.base64);
    
    const listing = {
      title,
      name,
      phone: phone || '',
      lineId: lineId || '',
      desc: desc || null,
      price: priceType === 'free' ? 0 : (price || 0),
      priceType: priceType || 'fixed',
      quantity: parseInt(quantity) || 1,
      condition: condition || null,
      tradeMethod: tradeMethod || null,
      tradeLocation: tradeLocation || null,
      category: category || '',
      deletePassword: deletePassword || '',
      createdAt: Date.now(),
      imageUrls: []
    };
    
    const result = await addListing(listing, imageBase64List);
    
    showToast('ç™¼å¸ƒæˆåŠŸï¼', 'success');
    e.target.reset();
    selectedImages = [];
    renderImagePreview();
    await renderListings(null, 1); // ç™¼å¸ƒå¾Œå›åˆ°ç¬¬ä¸€é 
    closeModal();
    
    submitBtn.textContent = 'âœ“ å·²ç™¼å¸ƒ';
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }, 1000);
  } catch (err) {
    console.error('æäº¤å¤±æ•—:', err);
    
    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
    let errorMsg = 'ç™¼å¸ƒå¤±æ•—ï¼š';
    if (err.isCorsError) {
      errorMsg += 'CORS è¨­å®šéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ Google Apps Script éƒ¨ç½²è¨­å®šã€‚';
      console.error('ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š\n1. ç¢ºä¿ Apps Script éƒ¨ç½²ç‚ºã€Œæ‰€æœ‰äººå¯å­˜å–ã€\n2. åœ¨ Apps Script ä¸­æ·»åŠ  doOptions() å‡½æ•¸\n3. é‡æ–°éƒ¨ç½²ä¸¦æ›´æ–° URL');
    } else if (err.message) {
      errorMsg += err.message;
    } else {
      errorMsg += 'è«‹ç¨å¾Œå†è©¦';
    }
    
    showToast(errorMsg, 'error');
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// ===== åœ–ç‰‡ç‡ˆç®±åŠŸèƒ½ =====
let lightboxImages = [];
let lightboxCurrentIndex = 0;

// è™•ç†åœ–ç‰‡é»æ“Šäº‹ä»¶
function handleImageClick(imgElement) {
  const imagesStr = imgElement.getAttribute('data-images');
  const index = parseInt(imgElement.getAttribute('data-index') || '0');
  if (imagesStr) {
    try {
      const images = JSON.parse(imagesStr);
      openLightbox(images, index);
    } catch (e) {
      console.error('è§£æåœ–ç‰‡æ•¸æ“šå¤±æ•—:', e);
    }
  }
}

function openLightbox(images, index = 0) {
  if (!images || images.length === 0) return;
  
  // èª¿è©¦ï¼šè¼¸å‡ºæ¥æ”¶åˆ°çš„åœ–ç‰‡é™£åˆ—
  console.log('ğŸ–¼ï¸ æ‰“é–‹ç‡ˆç®±ï¼Œåœ–ç‰‡é™£åˆ—:', images);
  console.log('ğŸ–¼ï¸ åœ–ç‰‡æ•¸é‡:', images.length);
  images.forEach((url, i) => {
    console.log(`  åœ–ç‰‡ ${i + 1}:`, url);
  });
  
  // éæ¿¾ç©ºå€¼å’Œé‡è¤‡å€¼
  lightboxImages = [...new Set(images.filter(url => url && url.trim() !== ''))];
  lightboxCurrentIndex = Math.max(0, Math.min(index, lightboxImages.length - 1));
  
  console.log('ğŸ–¼ï¸ è™•ç†å¾Œçš„åœ–ç‰‡é™£åˆ—:', lightboxImages);
  console.log('ğŸ–¼ï¸ åˆå§‹ç´¢å¼•:', lightboxCurrentIndex);
  
  const overlay = document.getElementById('lightboxOverlay');
  const img = document.getElementById('lightboxImage');
  const counter = document.getElementById('lightboxCounter');
  const prevBtn = overlay.querySelector('.lightbox-prev');
  const nextBtn = overlay.querySelector('.lightbox-next');
  
  // é¡¯ç¤ºç•¶å‰åœ–ç‰‡ï¼ˆæ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–ï¼‰
  const initialSrc = lightboxImages[lightboxCurrentIndex];
  img.src = initialSrc + (initialSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
  img.alt = `åœ–ç‰‡ ${lightboxCurrentIndex + 1}`;
  
  // æ›´æ–°è¨ˆæ•¸å™¨
  if (lightboxImages.length > 1) {
    counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
    counter.style.display = 'block';
    prevBtn.style.display = 'flex';
    nextBtn.style.display = 'flex';
  } else {
    counter.style.display = 'none';
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  }
  
  // é¡¯ç¤ºç‡ˆç®±
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
  
  // éµç›¤äº‹ä»¶ç›£è½
  document.addEventListener('keydown', handleLightboxKeyboard);
}

function closeLightbox() {
  const overlay = document.getElementById('lightboxOverlay');
  overlay.classList.remove('active');
  document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
  document.removeEventListener('keydown', handleLightboxKeyboard);
}

function closeLightboxOnOverlay(event) {
  // å¦‚æœé»æ“Šçš„æ˜¯èƒŒæ™¯ï¼ˆè€Œä¸æ˜¯åœ–ç‰‡æœ¬èº«ï¼‰ï¼Œå‰‡é—œé–‰
  if (event.target.id === 'lightboxOverlay') {
    closeLightbox();
  }
}

function lightboxPrev() {
  if (lightboxImages.length <= 1) return;
  lightboxCurrentIndex = (lightboxCurrentIndex - 1 + lightboxImages.length) % lightboxImages.length;
  updateLightboxImage();
}

function lightboxNext() {
  if (lightboxImages.length <= 1) return;
  lightboxCurrentIndex = (lightboxCurrentIndex + 1) % lightboxImages.length;
  updateLightboxImage();
}

function updateLightboxImage() {
  const img = document.getElementById('lightboxImage');
  const counter = document.getElementById('lightboxCounter');
  
  // ç¢ºä¿ç´¢å¼•æœ‰æ•ˆ
  if (lightboxCurrentIndex < 0 || lightboxCurrentIndex >= lightboxImages.length) {
    console.error('åœ–ç‰‡ç´¢å¼•ç„¡æ•ˆ:', lightboxCurrentIndex, 'åœ–ç‰‡ç¸½æ•¸:', lightboxImages.length);
    return;
  }
  
  const newSrc = lightboxImages[lightboxCurrentIndex];
  
  // èª¿è©¦ï¼šè¼¸å‡ºç•¶å‰åœ–ç‰‡è³‡è¨Š
  console.log(`ğŸ–¼ï¸ åˆ‡æ›åœ–ç‰‡: ç´¢å¼• ${lightboxCurrentIndex + 1}/${lightboxImages.length}`, newSrc);
  
  // å¦‚æœæ˜¯ç›¸åŒçš„ URLï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥ï¼ˆé¿å…å¿«å–å•é¡Œï¼‰
  if (img.src === newSrc) {
    // å…ˆæ¸…é™¤ srcï¼Œç„¶å¾Œé‡æ–°è¨­ç½®ï¼Œå¼·åˆ¶ç€è¦½å™¨é‡æ–°è¼‰å…¥
    img.src = '';
    // ä½¿ç”¨ setTimeout ç¢ºä¿æ¸…é™¤å®Œæˆå¾Œå†è¨­ç½®æ–° URL
    setTimeout(() => {
      img.src = newSrc + (newSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
    }, 10);
  } else {
    // æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
    img.src = newSrc + (newSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
  }
  
  img.alt = `åœ–ç‰‡ ${lightboxCurrentIndex + 1}`;
  
  if (lightboxImages.length > 1) {
    counter.textContent = `${lightboxCurrentIndex + 1} / ${lightboxImages.length}`;
  }
}

function handleLightboxKeyboard(event) {
  if (!document.getElementById('lightboxOverlay').classList.contains('active')) return;
  
  switch(event.key) {
    case 'Escape':
      closeLightbox();
      break;
    case 'ArrowLeft':
      lightboxPrev();
      break;
    case 'ArrowRight':
      lightboxNext();
      break;
  }
}

// ===== åˆå§‹åŒ– =====
setupImagePreview();
renderListings(null, 1);
</script>

</body>
</html>
