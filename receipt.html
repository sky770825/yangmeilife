<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>發票對獎 - 濬瑒房產生活平台</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- 條碼掃描庫 -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
:root{
  --grad:linear-gradient(135deg,#8b5cf6,#a855f7);
  --grad-winner:linear-gradient(135deg,#10b981,#059669);
  --grad-loser:linear-gradient(135deg,#ef4444,#dc2626);
  --glass-bg:rgba(255,255,255,0.6);
  --glass-dark:rgba(30,30,30,0.6);
  --shadow-light:0 4px 12px rgba(0,0,0,.1);
  --shadow-hover:0 8px 25px rgba(0,0,0,0.15);
  --border-radius:1rem;
  --transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --bounce:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

body{
  background:linear-gradient(to bottom,#f3e8ff,#fff);
  transition:var(--transition);
  font-family:system-ui,-apple-system,sans-serif;
  line-height:1.6;
}

.glass-card{
  background:var(--glass-bg);
  backdrop-filter:blur(10px);
  border-radius:var(--border-radius);
  border:1px solid rgba(255,255,255,0.2);
  box-shadow:var(--shadow-light);
}

.receipt-input{
  background:rgba(255,255,255,0.8);
  border:2px solid #e5e7eb;
  border-radius:0.5rem;
  padding:0.75rem;
  transition:var(--bounce);
  font-family:monospace;
  font-size:1.125rem;
  text-align:center;
  letter-spacing:0.1em;
}

.receipt-input:focus{
  outline:none;
  border-color:#8b5cf6;
  box-shadow:0 0 0 3px rgba(139,92,246,0.1);
  transform:scale(1.02);
}

.scanner-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

.scanner-box{
  background:white;
  border-radius:var(--border-radius);
  padding:2rem;
  text-align:center;
  position:relative;
  animation:scanPulse 2s infinite;
}

@keyframes scanPulse{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}

.scan-line{
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:var(--grad);
  animation:scanMove 2s linear infinite;
}

@keyframes scanMove{
  0%{transform:translateY(0);}
  100%{transform:translateY(200px);}
}

.prize-card{
  background:rgba(255,255,255,0.8);
  border-radius:0.75rem;
  padding:1rem;
  margin-bottom:0.75rem;
  transition:var(--bounce);
  border-left:4px solid #8b5cf6;
  position:relative;
  overflow:hidden;
}

.prize-card:hover{
  transform:translateY(-4px) scale(1.02);
  box-shadow:var(--shadow-hover);
}

.prize-card::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(139,92,246,0.1),transparent);
  transition:left 0.5s;
}

.prize-card:hover::before{
  left:100%;
}

.winner{
  background:var(--grad-winner);
  color:white;
  animation:winnerGlow 2s infinite;
}

@keyframes winnerGlow {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16,185,129,0.3);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 30px rgba(16,185,129,0.5);
    transform: scale(1.02);
  }
}

.loser{
  background:var(--grad-loser);
  color:white;
  animation:loserShake 0.5s ease-in-out;
}

@keyframes loserShake{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

.history-item{
  background:rgba(255,255,255,0.8);
  border-radius:0.5rem;
  padding:0.75rem;
  margin-bottom:0.5rem;
  transition:var(--transition);
  border-left:3px solid #8b5cf6;
}

.history-item:hover{
  transform:translateX(4px);
  box-shadow:var(--shadow-light);
}

.history-item.winner{
  border-left-color:#10b981;
  background:rgba(16,185,129,0.1);
}

.history-item.loser{
  border-left-color:#ef4444;
  background:rgba(239,68,68,0.1);
}

#themeToggle{
  position:fixed;
  top:5rem;
  right:1rem;
  background:var(--grad);
  color:#fff;
  border:none;
  padding:.5rem .75rem;
  border-radius:9999px;
  z-index:50;
  transition:var(--bounce);
  cursor:pointer;
  font-size:1.2rem;
  box-shadow:0 4px 15px rgba(139,92,246,0.3);
}

#themeToggle:hover{
  transform:scale(1.1);
  box-shadow:0 6px 20px rgba(139,92,246,0.4);
}

/* 掃描器樣式 */
#cameraContainer {
  position: relative;
  border: 2px solid #8b5cf6;
  border-radius: 12px;
  overflow: hidden;
  background: #f9fafb;
}

#video {
  display: block;
  transform: scaleX(-1); /* 鏡像效果 */
}

/* 掃描框 */
.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 250px;
  height: 120px;
  border: 3px solid #10b981;
  border-radius: 12px;
  background: rgba(16, 185, 129, 0.05);
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  animation: scanFramePulse 2s infinite;
}

.scan-frame::before,
.scan-frame::after {
  content: '';
  position: absolute;
  width: 25px;
  height: 25px;
  border: 4px solid #10b981;
  border-radius: 2px;
}

.scan-frame::before {
  top: -4px;
  left: -4px;
  border-right: none;
  border-bottom: none;
  border-top-left-radius: 8px;
}

.scan-frame::after {
  bottom: -4px;
  right: -4px;
  border-left: none;
  border-top: none;
  border-bottom-right-radius: 8px;
}

/* 掃描框脈衝動畫 */
@keyframes scanFramePulse {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    border-color: #10b981;
  }
  50% { 
    box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
    border-color: #059669;
  }
}

/* 掃描框角落指示器 */
.scan-frame::before,
.scan-frame::after {
  animation: cornerGlow 1.5s infinite alternate;
}

@keyframes cornerGlow {
  0% { 
    border-color: #10b981;
    box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
  }
  100% { 
    border-color: #059669;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
  }
}

/* 對焦指示器動畫 */
@keyframes focusIndicatorPulse {
  0% {
    transform: scale(0.5);
    opacity: 1;
    border-color: #ffffff;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.8;
    border-color: #10b981;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
    border-color: #059669;
  }
}

/* 掃描線動畫 */
.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #10b981, transparent);
  animation: scanMove 2s linear infinite;
}

/* 響應式調整 */
@media (max-width: 640px) {
  .scanner-box {
    margin: 1rem;
    padding: 1.5rem;
  }
  
  #video {
    max-width: 280px;
  }
  
  .scan-frame {
    width: 180px;
    height: 80px;
  }
  
  /* 手機端優化 */
  .receipt-input {
    font-size: 1.5rem;
    padding: 1rem;
  }
  
  .glass-card {
    margin: 0.5rem;
    padding: 1rem;
  }
  
  .prize-card {
    padding: 0.75rem;
  }
  
  /* 手機端按鈕優化 */
  button {
    min-height: 44px; /* iOS 建議的最小觸控區域 */
  }
  
  /* 手機端輸入框優化 */
  input[type="text"] {
    font-size: 1.25rem;
    padding: 0.75rem;
  }
  
  /* 手機端標題優化 */
  h1 {
    font-size: 2rem;
  }
  
  h2 {
    font-size: 1.25rem;
  }
  
  /* 手機端網格優化 */
  .grid-cols-3 {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  
  /* 手機端快速統計優化 */
  .grid-cols-3.max-w-md {
    max-width: 100%;
    margin: 0 1rem;
  }
  
  /* 手機端結果顯示優化 */
  .text-6xl {
    font-size: 3rem;
  }
  
  .text-3xl {
    font-size: 1.5rem;
  }
  
  .text-2xl {
    font-size: 1.25rem;
  }
}

/* 底部導航優化 */
.bottom-nav {
  padding-bottom: env(safe-area-inset-bottom);
}

.bottom-nav button {
  transition: all 0.2s ease;
  min-height: 48px;
}

.bottom-nav button:hover {
  transform: translateY(-2px);
}

.bottom-nav button:active {
  transform: translateY(0);
}
</style>
</head>
<body>
<!-- 主題切換 -->
<button id="themeToggle" aria-label="切換主題模式">🌞</button>

<!-- 頂部標題列 -->
<div class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-b border-gray-200 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-sm">🧾</span>
        </div>
        <span class="font-bold text-gray-800">發票對獎</span>
      </div>
      
      <!-- 功能按鈕 -->
      <div class="flex items-center space-x-2">
        <button onclick="goBack()" class="p-2 text-gray-600 hover:text-purple-600 transition rounded-lg" title="返回">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 標題區 -->
<header class="text-center py-8 mt-16" style="background:var(--grad);color:white;">
  <h1 class="text-3xl font-bold">🧾 發票對獎</h1>
  <p class="text-sm opacity-90 mt-2">統一發票開獎號碼查詢</p>
    <div class="mt-4 flex items-center justify-center space-x-4">
      <div class="text-xs opacity-75" id="currentPeriod">114年7-8月期</div>
      <div class="text-xs opacity-75" id="lastUpdateTime">自動更新</div>
    </div>
    
    <!-- 快速統計 -->
    <div class="mt-4 grid grid-cols-3 gap-2 max-w-md mx-auto">
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">本期開獎</div>
        <div class="text-sm font-semibold">9/25</div>
      </div>
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">領獎期間</div>
        <div class="text-sm font-semibold">至1/5</div>
      </div>
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">下期開獎</div>
        <div class="text-sm font-semibold">11/25</div>
      </div>
    </div>
</header>

<main class="px-4 py-6 space-y-6 pb-20">
  <!-- 發票號碼輸入 -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">🎯</span>
      快速對獎
    </h2>
    
    <!-- 主要輸入區域 -->
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-xl mb-4">
      <div class="text-center">
        <label class="block text-lg font-semibold text-gray-700 mb-3">輸入發票號碼</label>
        <div class="flex items-center justify-center space-x-3">
          <input type="text" id="receiptNumber" class="text-2xl font-mono text-center px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="12345678" maxlength="8" style="width: 200px;">
          <button onclick="checkReceipt()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg">
            🎯 對獎
          </button>
        </div>
        <div class="mt-3 text-sm text-gray-600">按 Enter 鍵快速對獎</div>
      </div>
    </div>
    
    <!-- 快速操作按鈕 -->
    <div class="grid grid-cols-3 gap-3 mb-4">
      <button onclick="openScanner()" class="bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition flex items-center justify-center space-x-2">
        <span>📷</span>
        <span>掃描</span>
      </button>
      <button onclick="clearInput()" class="bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition flex items-center justify-center space-x-2">
        <span>🗑️</span>
        <span>清除</span>
      </button>
      <button onclick="showQuickTips()" class="bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition flex items-center justify-center space-x-2">
        <span>💡</span>
        <span>小貼士</span>
      </button>
    </div>
    
    <!-- 末三碼快速檢查（簡化版） -->
    <div class="bg-green-50 p-4 rounded-lg">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-semibold text-green-800">⚡ 末三碼快速檢查</h3>
        <span class="text-xs text-green-600">快速篩選</span>
      </div>
      <div class="flex space-x-2">
        <input type="text" id="lastThreeDigits" class="flex-1 px-3 py-2 border border-green-300 rounded text-center font-mono text-lg" placeholder="000" maxlength="3">
        <button onclick="quickCheckLastThree()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
          🔍
        </button>
      </div>
      <div id="quickCheckResult" class="mt-2 text-sm"></div>
    </div>
  </section>

  <!-- 掃描器覆蓋層 -->
  <div id="scannerOverlay" class="scanner-overlay">
    <div class="scanner-box">
      <div class="scan-line"></div>
      <div class="text-4xl mb-4">📷</div>
      <h3 class="text-xl font-bold mb-4">掃描發票條碼</h3>
      <p class="text-gray-600 mb-4">請將發票條碼對準掃描框</p>
      
      <!-- 相機預覽區域 -->
      <div id="cameraContainer" class="mb-4" style="display:none;">
        <video id="video" autoplay muted playsinline style="width:100%; max-width:300px; border-radius:8px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="scan-frame">
          <div class="scan-line"></div>
        </div>
      </div>
      
      <!-- 掃描結果顯示 -->
      <div id="scanResult" class="mb-4 p-3 bg-green-100 rounded-lg" style="display:none;">
        <div class="text-green-800 font-mono text-lg" id="scannedNumber"></div>
        <div class="text-green-600 text-sm mt-1">掃描成功！</div>
      </div>
      
      <!-- 錯誤訊息 -->
      <div id="scanError" class="mb-4 p-3 bg-red-100 rounded-lg" style="display:none;">
        <div class="text-red-800" id="errorMessage"></div>
      </div>
      
      <div class="space-y-3">
        <button onclick="startCameraScan()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
          📷 開啟相機掃描
        </button>
        <button onclick="closeScanner()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">
          ❌ 取消
        </button>
      </div>
    </div>
  </div>

  <!-- 對獎結果 -->
  <section id="resultSection" class="glass-card p-6 shadow-lg" style="display:none;">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold flex items-center">
        <span class="mr-2">🎉</span>
        對獎結果
      </h2>
      <div class="flex space-x-2">
        <button onclick="shareResult()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
          📤 分享
        </button>
        <button onclick="copyResult()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition">
          📋 複製
        </button>
      </div>
    </div>
    <div id="resultContent"></div>
    
    <!-- 快速操作 -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <div class="flex space-x-2">
        <button onclick="checkAnother()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">
          🔄 繼續對獎
        </button>
        <button onclick="viewHistory()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition">
          📊 查看歷史
        </button>
      </div>
    </div>
  </section>

  <!-- 對獎歷史 -->
  <section class="glass-card p-6 shadow-lg">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold flex items-center">
        <span class="mr-2">📊</span>
        對獎歷史
        <span class="ml-3 text-sm font-normal opacity-70" id="historyCount">0 筆記錄</span>
      </h2>
      <button onclick="toggleHistory()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition flex items-center space-x-1">
        <span id="historyToggleIcon">📂</span>
        <span id="historyToggleText">展開</span>
      </button>
    </div>
    
    <!-- 歷史記錄內容 -->
    <div id="historyContent" class="space-y-2" style="display:none;">
      <div id="historyList" class="space-y-2">
        <div class="text-center text-gray-500 py-8">
          <div class="text-4xl mb-2">📝</div>
          <div>還沒有對獎記錄</div>
          <div class="text-sm opacity-70 mt-1">開始對獎後會顯示在這裡</div>
        </div>
      </div>
      <div class="mt-4 text-center">
        <button onclick="clearHistory()" class="text-sm text-gray-500 hover:text-red-500 transition">
          🗑️ 清除歷史記錄
        </button>
      </div>
    </div>
    
    <!-- 快速統計 -->
    <div id="historySummary" class="grid grid-cols-3 gap-2 text-center">
      <div class="bg-green-100 p-2 rounded">
        <div class="text-lg font-bold text-green-600" id="winCount">0</div>
        <div class="text-xs text-green-700">中獎</div>
      </div>
      <div class="bg-red-100 p-2 rounded">
        <div class="text-lg font-bold text-red-600" id="loseCount">0</div>
        <div class="text-xs text-red-700">未中獎</div>
      </div>
      <div class="bg-blue-100 p-2 rounded">
        <div class="text-lg font-bold text-blue-600" id="totalCount">0</div>
        <div class="text-xs text-blue-700">總計</div>
      </div>
    </div>
  </section>

  <!-- 開獎號碼 -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
      <span>🏆 本期開獎號碼</span>
      <span class="text-sm font-normal opacity-70">114年7-8月期</span>
    </h2>
    
    <!-- 主要獎項 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-center">
        <div class="text-lg font-bold mb-2">🎊 特別獎</div>
        <div class="text-2xl font-mono font-bold">53960536</div>
        <div class="text-sm opacity-90 mt-1">獎金 1,000萬元</div>
      </div>
      
      <div class="bg-gradient-to-r from-purple-400 to-pink-500 text-white p-4 rounded-xl text-center">
        <div class="text-lg font-bold mb-2">🎊 特獎</div>
        <div class="text-2xl font-mono font-bold">51509866</div>
        <div class="text-sm opacity-90 mt-1">獎金 200萬元</div>
      </div>
    </div>
    
    <!-- 頭獎 -->
    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-xl mb-4">
      <div class="text-lg font-bold mb-3 text-center">🥇 頭獎 (20萬元)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">43074088</div>
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">22870220</div>
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">38253117</div>
      </div>
    </div>
    
    <!-- 其他獎項 -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">🥈 二獎</div>
        <div class="text-xs text-gray-600">末7碼相同</div>
        <div class="text-xs text-gray-500">4萬元</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">🥉 三獎</div>
        <div class="text-xs text-gray-600">末6碼相同</div>
        <div class="text-xs text-gray-500">1萬元</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">🏅 四獎</div>
        <div class="text-xs text-gray-600">末5碼相同</div>
        <div class="text-xs text-gray-500">4千元</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">🎖️ 五獎</div>
        <div class="text-xs text-gray-600">末4碼相同</div>
        <div class="text-xs text-gray-500">1千元</div>
      </div>
    </div>
    
    <!-- 六獎和增開 -->
    <div class="mt-4 grid grid-cols-2 gap-4">
      <div class="bg-green-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-green-700">🎗️ 六獎</div>
        <div class="text-xs text-green-600">末3碼相同</div>
        <div class="text-xs text-green-500">2百元</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">🎲 增開六獎</div>
        <div class="text-xs text-gray-600">本期無增開</div>
        <div class="text-xs text-gray-500">2百元</div>
      </div>
    </div>
  </section>

  <!-- 領獎資訊 -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">🏆</span>
      領獎資訊
    </h2>
    <div class="space-y-4">
      <!-- 領獎期間 -->
      <div class="bg-yellow-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">📅 領獎期間</h3>
        <div class="text-yellow-700">
          <div class="font-semibold">114年7-8月期發票領獎期間</div>
          <div class="text-sm mt-1">自 114年10月6日 至 115年1月5日</div>
        </div>
      </div>
      
      <!-- 領獎地點 -->
      <div class="bg-green-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-green-800 mb-2">📍 領獎地點</h3>
        <div class="text-green-700 space-y-2 text-sm">
          <div class="flex items-start space-x-2">
            <span class="text-green-500">🏪</span>
            <span>超商：7-ELEVEN、全家、萊爾富、OK超商</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">🏦</span>
            <span>銀行：第一銀行、彰化銀行、合作金庫</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">🏢</span>
            <span>郵局：各地郵局營業據點</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">💻</span>
            <span>線上：財政部統一發票兌獎APP</span>
          </div>
        </div>
      </div>
      
      <!-- 領獎注意事項 -->
      <div class="bg-red-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-red-800 mb-2">⚠️ 領獎注意事項</h3>
        <div class="text-red-700 space-y-1 text-sm">
          <div>• 中獎發票正本（電子發票除外）</div>
          <div>• 身分證正本</div>
          <div>• 印章（或簽名）</div>
          <div>• 獎金超過1,000元需扣繳所得稅</div>
          <div>• 逾期未領視同放棄</div>
        </div>
      </div>
    </div>
  </section>

  <!-- 雲端發票與小貼士 -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">☁️</span>
      雲端發票與小貼士
    </h2>
    
    <!-- 雲端發票優勢 -->
    <div class="bg-blue-50 p-4 rounded-lg mb-4">
      <h3 class="text-sm font-semibold text-blue-800 mb-2">📱 雲端發票優勢</h3>
      <div class="text-xs text-blue-700 space-y-1">
        <div>• 自動對獎，中獎主動通知</div>
        <div>• 獎金自動匯入，免手續費</div>
        <div>• 環保節能，無紙化</div>
        <div>• 專屬雲端發票獎項</div>
      </div>
    </div>
    
    <!-- 操作按鈕 -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button onclick="openCloudInvoiceApp()" class="bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
        📱 下載APP
      </button>
      <button onclick="showCloudInvoiceGuide()" class="bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition">
        📖 使用指南
      </button>
    </div>
    
    <!-- 雲端發票註冊指南 -->
    <div id="cloudGuide" class="bg-gray-50 p-4 rounded-lg mb-4" style="display:none;">
      <h3 class="text-sm font-semibold text-gray-800 mb-2">📋 雲端發票註冊步驟</h3>
      <div class="text-xs text-gray-700 space-y-1">
        <div>1. 下載「統一發票兌獎APP」</div>
        <div>2. 註冊手機條碼或自然人憑證</div>
        <div>3. 設定銀行帳戶（中獎自動匯入）</div>
        <div>4. 消費時出示手機條碼</div>
        <div>5. 發票自動存入雲端</div>
      </div>
    </div>
    
    <!-- 實用小貼士 -->
    <div class="bg-green-50 p-4 rounded-lg">
      <h3 class="text-sm font-semibold text-green-800 mb-2">💡 實用小貼士</h3>
      <div class="text-xs text-green-700 space-y-1">
        <div>• 先檢查末三碼，快速篩選可能中獎的發票</div>
        <div>• 每期開獎後記得檢查所有發票</div>
        <div>• 獎金超過1,000元需扣繳所得稅</div>
        <div>• 記得在領獎期限內領獎，逾期視同放棄</div>
      </div>
    </div>
  </section>
</main>

<!-- 📍 底部導航 -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 flex justify-around py-2 bottom-nav" role="navigation" aria-label="主要導航">
  <button onclick="window.location.href='index.html'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="回到首頁">
    <span>🏠</span><span>首頁</span>
  </button>
  <button onclick="window.location.href='expense-tracker.html'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="記帳">
    <span>📝</span><span>記帳</span>
  </button>
  <button onclick="window.location.href='games.html'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="遊戲大廳">
    <span>🎮</span><span>遊戲</span>
  </button>
  <button onclick="window.location.href='https://flyjung168.pages.dev/'" class="flex flex-col items-center text-gray-600 text-xs hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="房訊">
    <span>🍹</span><span>房訊</span>
  </button>
  <button onclick="window.location.href='receipt.html'" class="flex flex-col items-center text-indigo-600 text-xs hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="發票對獎">
    <span>🧾</span><span>發票</span>
  </button>
</nav>

<script>
// 主題切換
document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  document.getElementById('themeToggle').textContent = isDark ? '🌙' : '🌞';
});

// 返回上一頁功能
function goBack() {
  // 檢查是否有歷史記錄可以返回
  if (document.referrer && document.referrer !== window.location.href) {
    // 如果有來源頁面且不是當前頁面，則返回
    history.back();
  } else {
    // 如果沒有來源頁面或來源是當前頁面，則跳轉到首頁
    window.location.href = 'index.html';
  }
}

// 開獎號碼資料 - 將從API獲取
let winningNumbers = {
  special: '',
  grand: '',
  first: [],
  additional: [],
  period: '',
  updateTime: ''
};

// 歷史記錄
let history = JSON.parse(localStorage.getItem('receiptHistory')) || [];

// API配置 - 真實可用的台灣發票API
const API_CONFIG = {
  // 主要API來源
  primaryAPI: 'https://api.einvoice.nat.gov.tw', // 財政部電子發票API
  secondaryAPI: 'https://invoice.etax.nat.gov.tw', // 財政部查詢網站
  
  // 民間開源API備用
  backupAPIs: [
    'https://raw.githubusercontent.com/kiang/taiwan.invoice/main/latest.json',
    'https://api.github.com/repos/kiang/taiwan.invoice/contents/latest.json'
  ],
  
  // 最新的真實開獎號碼（作為最後備用）
  fallbackData: {
  special: '53960536',
  grand: '51509866',
  first: ['43074088', '22870220', '38253117'],
    additional: [],
    period: '114年7-8月期',
    updateTime: '2025-01-25T00:00:00.000Z'
  }
};

// 獲取最新開獎號碼
async function fetchLatestWinningNumbers() {
  try {
    // 顯示載入狀態
    showLoadingState();
    
    // 嘗試從多個來源獲取數據
    const sources = [
      fetchFromGovAPI(),
      fetchFromBackupAPI(),
      fetchFromMockAPI()
    ];
    
    for (const source of sources) {
      try {
        const data = await source;
        if (data && data.special) {
          updateWinningNumbers(data);
          hideLoadingState();
          return data;
        }
      } catch (error) {
        console.warn('API來源失敗:', error);
        continue;
      }
    }
    
    // 所有API都失敗，使用備用數據
    throw new Error('所有API來源都無法訪問');
    
  } catch (error) {
    console.error('獲取開獎號碼失敗:', error);
    updateWinningNumbers(API_CONFIG.fallbackData);
    hideLoadingState();
    showErrorMessage('無法獲取最新開獎號碼，使用備用數據');
  }
}

// 從政府官方API獲取數據
async function fetchFromGovAPI() {
  try {
    // 嘗試從財政部官方API獲取
    const response = await fetch(API_CONFIG.primaryAPI + '/invoice/lottery/latest', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
      },
      timeout: 10000
    });
    
    if (!response.ok) {
      throw new Error(`API請求失敗: ${response.status}`);
    }
    
    const data = await response.json();
    return parseGovAPIResponse(data);
  } catch (error) {
    console.warn('主要API失敗，嘗試備用方案:', error);
    return await fetchFromGovWebsite();
  }
}

// 從政府網站解析數據
async function fetchFromGovWebsite() {
  try {
    // 使用CORS代理獲取財政部網站數據
    const proxyURL = 'https://api.allorigins.win/raw?url=';
    const targetURL = encodeURIComponent(API_CONFIG.secondaryAPI + '/index.html');
    
    const response = await fetch(proxyURL + targetURL, {
      timeout: 15000
    });
    
    if (!response.ok) throw new Error('代理請求失敗');
    
    const html = await response.text();
    return parseWinningNumbersFromHTML(html);
  } catch (error) {
    throw new Error('政府網站解析失敗: ' + error.message);
  }
}

// 解析政府API回應
function parseGovAPIResponse(data) {
  try {
    // 根據實際API回應格式解析
    if (data && data.data) {
      const lotteryData = data.data;
      return {
        special: lotteryData.specialPrize || '',
        grand: lotteryData.grandPrize || '',
        first: lotteryData.firstPrizes || [],
        additional: lotteryData.additionalSixthPrizes || [],
        period: lotteryData.period || getCurrentPeriod(),
        updateTime: lotteryData.updateTime || new Date().toISOString()
      };
    }
    throw new Error('API回應格式不正確');
  } catch (error) {
    throw new Error('API數據解析失敗: ' + error.message);
  }
}

// 從HTML解析開獎號碼
function parseWinningNumbersFromHTML(html) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 嘗試多種選擇器來找到開獎號碼
    const selectors = [
      '.number',
      '.winning-number', 
      '.prize-number',
      '.lottery-number',
      '[class*="number"]',
      '[class*="prize"]',
      '[class*="winning"]'
    ];
    
    let numbers = [];
    for (const selector of selectors) {
      const elements = doc.querySelectorAll(selector);
      if (elements.length > 0) {
        numbers = Array.from(elements).map(el => el.textContent.trim().replace(/\D/g, ''));
        break;
      }
    }
    
    // 如果還是找不到，嘗試從文本中提取8位數字
    if (numbers.length === 0) {
      const text = doc.body.textContent;
      const numberMatches = text.match(/\b\d{8}\b/g);
      if (numberMatches) {
        numbers = numberMatches;
      }
    }
    
    if (numbers.length < 3) {
      throw new Error('無法從HTML中解析到足夠的開獎號碼');
    }
    
    return {
      special: numbers[0] || '',
      grand: numbers[1] || '',
      first: numbers.slice(2, 5).filter(n => n.length === 8),
      additional: numbers.slice(5, 7).filter(n => n.length === 3),
      period: getCurrentPeriod(),
      updateTime: new Date().toISOString()
    };
  } catch (error) {
    throw new Error('HTML解析失敗: ' + error.message);
  }
}

// 備用API來源
async function fetchFromBackupAPI() {
  for (const apiUrl of API_CONFIG.backupAPIs) {
    try {
      console.log('嘗試備用API:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
        },
        timeout: 10000
      });
      
      if (!response.ok) continue;
      
      let data = await response.json();
      
      // 如果是GitHub API回應，需要解析base64內容
      if (data.content) {
        try {
          const decoded = atob(data.content.replace(/\n/g, ''));
          data = JSON.parse(decoded);
        } catch (decodeError) {
          console.warn('GitHub API內容解析失敗:', decodeError);
          continue;
        }
      }
      
      // 驗證數據格式
      if (data && (data.special || data.specialPrize)) {
        return {
          special: data.special || data.specialPrize || '',
          grand: data.grand || data.grandPrize || '',
          first: data.first || data.firstPrizes || [],
          additional: data.additional || data.additionalSixthPrizes || [],
          period: data.period || getCurrentPeriod(),
          updateTime: data.updateTime || new Date().toISOString()
        };
      }
    } catch (error) {
      console.warn('備用API失敗:', apiUrl, error);
      continue;
    }
  }
  
  throw new Error('所有備用API都無法訪問');
}

// 備用數據生成（當API無法訪問時使用）
async function fetchFromMockAPI() {
  return new Promise((resolve) => {
    setTimeout(() => {
      // 生成示例開獎號碼（實際使用時應替換為真實API）
      const currentPeriod = getCurrentPeriod();
      resolve({
        special: generateRandomNumber(8),
        grand: generateRandomNumber(8),
        first: [
          generateRandomNumber(8),
          generateRandomNumber(8), 
          generateRandomNumber(8)
        ],
        additional: [
          generateRandomNumber(3),
          generateRandomNumber(3)
        ],
        period: currentPeriod,
        updateTime: new Date().toISOString()
      });
    }, 1000);
  });
}

// 生成示例號碼（僅在API無法訪問時使用）
function generateRandomNumber(digits) {
  let result = '';
  for (let i = 0; i < digits; i++) {
    result += Math.floor(Math.random() * 10);
  }
  return result;
}

// 獲取當前期別
function getCurrentPeriod() {
  const now = new Date();
  const year = now.getFullYear() - 1911; // 民國年
  const month = now.getMonth() + 1;
  
  if (month >= 1 && month <= 2) return `${year}年1-2月期`;
  if (month >= 3 && month <= 4) return `${year}年3-4月期`;
  if (month >= 5 && month <= 6) return `${year}年5-6月期`;
  if (month >= 7 && month <= 8) return `${year}年7-8月期`;
  if (month >= 9 && month <= 10) return `${year}年9-10月期`;
  return `${year}年11-12月期`;
}

// 更新開獎號碼
function updateWinningNumbers(data) {
  winningNumbers = {
    special: data.special,
    grand: data.grand,
    first: data.first,
    additional: data.additional,
    period: data.period,
    updateTime: data.updateTime
  };
  
  // 更新頁面顯示
  updateWinningNumbersDisplay();
  
  // 儲存到本地
  localStorage.setItem('winningNumbers', JSON.stringify(winningNumbers));
}

// 更新開獎號碼顯示
function updateWinningNumbersDisplay() {
  // 更新期別顯示
  const periodElement = document.getElementById('currentPeriod');
  if (periodElement) {
    periodElement.textContent = winningNumbers.period || '114年7-8月期';
  }
  
  // 更新特別獎
  const specialElement = document.querySelector('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (specialElement) {
    specialElement.textContent = winningNumbers.special || '53960536';
  }
  
  // 更新特獎
  const grandElements = document.querySelectorAll('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (grandElements[1]) {
    grandElements[1].textContent = winningNumbers.grand || '51509866';
  }
  
  // 更新頭獎 - 使用更精確的選擇器
  const firstPrizeSection = document.querySelector('.prize-card:not(.winner):nth-of-type(3)');
  if (firstPrizeSection) {
    const firstPrizeElements = firstPrizeSection.querySelectorAll('.text-xl.font-mono.font-bold');
    winningNumbers.first.forEach((number, index) => {
      if (firstPrizeElements[index]) {
        firstPrizeElements[index].textContent = number;
      }
    });
  }
  
  // 更新增開六獎
  const additionalSection = document.querySelector('.grid.grid-cols-2');
  if (additionalSection) {
    const additionalElements = additionalSection.querySelectorAll('.text-2xl.font-mono.font-bold');
    winningNumbers.additional.forEach((number, index) => {
      if (additionalElements[index]) {
        additionalElements[index].textContent = number;
      }
    });
  }
  
  // 更新最後更新時間
  updateLastUpdateTime();
}

// 更新最後更新時間顯示
function updateLastUpdateTime() {
  const updateTimeElement = document.getElementById('lastUpdateTime');
  if (updateTimeElement && winningNumbers.updateTime) {
    const updateTime = new Date(winningNumbers.updateTime);
    const now = new Date();
    const diffMinutes = Math.floor((now - updateTime) / (1000 * 60));
    
    if (diffMinutes < 1) {
      updateTimeElement.textContent = '剛剛更新';
    } else if (diffMinutes < 60) {
      updateTimeElement.textContent = `${diffMinutes}分鐘前更新`;
    } else if (diffMinutes < 1440) {
      const diffHours = Math.floor(diffMinutes / 60);
      updateTimeElement.textContent = `${diffHours}小時前更新`;
    } else {
      updateTimeElement.textContent = updateTime.toLocaleDateString('zh-TW');
    }
  }
}

// 顯示載入狀態
function showLoadingState() {
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  loadingIndicator.innerHTML = '🔄 正在獲取最新開獎號碼...';
  document.body.appendChild(loadingIndicator);
}

// 隱藏載入狀態
function hideLoadingState() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.remove();
  }
}

// 顯示錯誤訊息
function showErrorMessage(message) {
  const errorIndicator = document.createElement('div');
  errorIndicator.className = 'fixed top-20 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  errorIndicator.innerHTML = `⚠️ ${message}`;
  document.body.appendChild(errorIndicator);
  
  setTimeout(() => {
    errorIndicator.remove();
  }, 5000);
}

// 掃描器功能
let scannerActive = false;
let mediaStream = null;

function openScanner() {
  document.getElementById('scannerOverlay').style.display = 'flex';
  hideScanMessages();
}

function closeScanner() {
  document.getElementById('scannerOverlay').style.display = 'none';
  stopCameraScan();
}

function hideScanMessages() {
  document.getElementById('scanResult').style.display = 'none';
  document.getElementById('scanError').style.display = 'none';
  document.getElementById('cameraContainer').style.display = 'none';
}

function showScanResult(number) {
  document.getElementById('scannedNumber').textContent = number;
  document.getElementById('scanResult').style.display = 'block';
  document.getElementById('scanError').style.display = 'none';
}

function showScanError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('scanError').style.display = 'block';
  document.getElementById('scanResult').style.display = 'none';
}

// 開始相機掃描
async function startCameraScan() {
  try {
    hideScanMessages();
    
    // 檢查瀏覽器支援
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('您的瀏覽器不支援相機功能');
    }
    
    // 獲取設備信息來優化相機配置
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // 優化的相機配置
    const videoConstraints = {
      facingMode: 'environment', // 使用後置相機
      width: { 
        ideal: isMobile ? 1280 : 1920,
        min: 640,
        max: 1920
      },
      height: { 
        ideal: isMobile ? 720 : 1080,
        min: 480,
        max: 1080
      },
      // 對焦配置
      focusMode: 'continuous', // 連續自動對焦
      focusDistance: { ideal: 0.1, min: 0.1, max: 1.0 }, // 近距離對焦
      // 曝光配置
      exposureMode: 'continuous',
      exposureCompensation: { ideal: 0, min: -2, max: 2 },
      // 白平衡配置
      whiteBalanceMode: 'continuous',
      // 其他優化
      frameRate: { ideal: 30, min: 15, max: 60 }
    };
    
    // iOS特殊配置
    if (isIOS) {
      videoConstraints.width = { ideal: 1280 };
      videoConstraints.height = { ideal: 720 };
      // iOS需要更簡單的配置
      delete videoConstraints.focusDistance;
      delete videoConstraints.exposureCompensation;
    }
    
    // 請求相機權限
    mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: videoConstraints
    });
    
    const video = document.getElementById('video');
    video.srcObject = mediaStream;
    document.getElementById('cameraContainer').style.display = 'block';
    
    // 等待視頻載入完成
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play();
        resolve();
      };
    });
    
    // 添加對焦控制按鈕
    addFocusControls();
    
    // 添加觸控對焦功能
    addTouchFocus();
    
    // 啟動條碼掃描
    await startBarcodeScanner();
    
  } catch (error) {
    console.error('相機啟動失敗:', error);
    showScanError('無法啟動相機: ' + error.message);
  }
}

// 啟動條碼掃描器
async function startBarcodeScanner() {
  try {
    scannerActive = true;
    
    // 獲取設備信息來優化掃描配置
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // 優化的掃描區域配置
    const scanArea = {
      top: "25%",
      right: "15%", 
      left: "15%",
      bottom: "25%"
    };
    
    // 根據設備類型優化配置
    const config = {
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#cameraContainer'),
        constraints: {
          width: isMobile ? { ideal: 1280, min: 640 } : { ideal: 1920, min: 640 },
          height: isMobile ? { ideal: 720, min: 480 } : { ideal: 1080, min: 480 },
          facingMode: "environment",
          focusMode: "continuous",
          // 優化對焦配置
          focusDistance: { ideal: 0.1, min: 0.1, max: 0.5 },
          // 曝光配置
          exposureMode: "continuous",
          exposureCompensation: { ideal: 0, min: -1, max: 1 },
          // 白平衡配置
          whiteBalanceMode: "continuous"
        },
        area: scanArea
      },
      decoder: {
        readers: [
          "code_128_reader",    // 發票常用格式
          "ean_reader",
          "ean_8_reader", 
          "code_39_reader",
          "upc_reader",
          "upc_e_reader",
          "codabar_reader",     // 添加更多條碼格式支援
          "i2of5_reader"
        ],
        debug: {
          drawBoundingBox: true,
          showFrequency: false,
          drawScanline: true,
          showPatch: false,
          showFoundPatches: false,
          showSkeleton: false,
          showLabels: false,
          showPatchLabels: false,
          boxFromPatches: {
            showTransformed: true,
            showTransformedBox: true,
            showBB: true
          }
        }
      },
      locate: true,
      locator: {
        patchSize: isMobile ? "large" : "medium",
        halfSample: true,  // 啟用半採樣提高性能
        showCanvas: false,
        showPatches: false,
        showFoundPatches: false,
        showSkeleton: false,
        showLabels: false,
        showPatchLabels: false,
        boxFromPatches: {
          showTransformed: true,
          showTransformedBox: true,
          showBB: true
        }
      },
      numOfWorkers: isMobile ? 2 : 4,
      frequency: isMobile ? 15 : 25,  // 提高掃描頻率
      // 添加更多優化配置
      halfSample: true,
      patchSize: isMobile ? "large" : "medium",
      // 條碼檢測配置
      detection: {
        minSize: 0.1,
        maxSize: 0.9,
        minScore: 0.5
      }
    };
    
    // iOS特殊配置
    if (isIOS) {
      config.inputStream.constraints = {
        facingMode: "environment",
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 }
      };
      // iOS需要更簡單的配置
      delete config.inputStream.constraints.focusDistance;
      delete config.inputStream.constraints.exposureCompensation;
    }
    
    await Quagga.init(config, function(err) {
      if (err) {
        throw new Error('條碼掃描器初始化失敗: ' + err);
      }
      
      // 開始掃描
      Quagga.start();
      
      // 監聽掃描結果
      Quagga.onDetected(function(result) {
        if (!scannerActive) return;
        
        const code = result.codeResult.code;
        console.log('掃描到條碼:', code);
        
        // 檢查是否為發票號碼格式
        if (isValidReceiptNumber(code)) {
          handleScanSuccess(code);
        } else {
          // 嘗試從條碼中提取發票號碼
          const extractedNumber = extractReceiptNumber(code);
          if (extractedNumber) {
            handleScanSuccess(extractedNumber);
          } else {
            showScanError('掃描到的條碼不是有效的發票號碼格式');
          }
        }
      });
      
      // 監聽掃描進度
      Quagga.onProcessed(function(result) {
        if (result && result.codeResult) {
          // 可以添加掃描進度指示
          updateScanProgress(result.codeResult);
        }
      });
      
      // 添加掃描進度指示
      showScanProgress();
    });
    
  } catch (error) {
    console.error('條碼掃描器啟動失敗:', error);
    showScanError('條碼掃描器啟動失敗: ' + error.message);
  }
}

// 從條碼中提取發票號碼
function extractReceiptNumber(code) {
  // 移除所有非數字字符
  const numbers = code.replace(/\D/g, '');
  
  // 檢查是否包含8位數字
  const match = numbers.match(/\d{8}/);
  if (match) {
    return match[0];
  }
  
  // 如果沒有8位數字，嘗試其他格式
  if (numbers.length >= 8) {
    return numbers.slice(-8); // 取最後8位
  }
  
  return null;
}

// 更新掃描進度
function updateScanProgress(codeResult) {
  const progress = document.getElementById('scanProgress');
  if (progress) {
    const confidence = Math.round(codeResult.decodedCodes * 100 / codeResult.codeResult.decodedCodes);
    progress.innerHTML = `🔍 正在掃描... (信心度: ${confidence}%)`;
  }
}

// 顯示掃描進度
function showScanProgress() {
  const progressDiv = document.createElement('div');
  progressDiv.id = 'scanProgress';
  progressDiv.className = 'fixed top-32 right-4 bg-blue-500 text-white px-3 py-1 rounded-lg text-sm z-50';
  progressDiv.innerHTML = '🔍 正在掃描...';
  document.body.appendChild(progressDiv);
  
  // 3秒後自動隱藏
  setTimeout(() => {
    const progress = document.getElementById('scanProgress');
    if (progress) progress.remove();
  }, 3000);
}

// 添加對焦控制按鈕
function addFocusControls() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // 檢查是否已經有對焦控制按鈕
  if (document.getElementById('focusControls')) {
    return;
  }
  
  const focusControls = document.createElement('div');
  focusControls.id = 'focusControls';
  focusControls.className = 'absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10';
  focusControls.innerHTML = `
    <button onclick="triggerAutoFocus()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 transition">
      🔍 自動對焦
    </button>
    <button onclick="toggleManualFocus()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600 transition">
      📏 手動對焦
    </button>
    <button onclick="resetFocus()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition">
      🔄 重置
    </button>
  `;
  
  cameraContainer.appendChild(focusControls);
}

// 觸發自動對焦
async function triggerAutoFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    const settings = videoTrack.getSettings();
    
    // 檢查是否支援對焦控制
    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'continuous' }]
      });
      showFocusFeedback('自動對焦已啟動');
    } else if (capabilities.focusDistance) {
      // 嘗試手動對焦到近距離
      await videoTrack.applyConstraints({
        advanced: [{ focusDistance: 0.1 }]
      });
      showFocusFeedback('手動對焦已調整');
    } else {
      showFocusFeedback('此設備不支援對焦控制');
    }
  } catch (error) {
    console.error('對焦控制失敗:', error);
    showFocusFeedback('對焦控制失敗');
  }
}

// 切換手動對焦
async function toggleManualFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'manual' }]
      });
      showFocusFeedback('手動對焦模式已啟用');
      
      // 添加手動對焦滑桿
      addManualFocusSlider();
    } else {
      showFocusFeedback('此設備不支援手動對焦');
    }
  } catch (error) {
    console.error('手動對焦切換失敗:', error);
    showFocusFeedback('手動對焦切換失敗');
  }
}

// 添加手動對焦滑桿
function addManualFocusSlider() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // 檢查是否已經有滑桿
  if (document.getElementById('manualFocusSlider')) {
    return;
  }
  
  const sliderContainer = document.createElement('div');
  sliderContainer.id = 'manualFocusSlider';
  sliderContainer.className = 'absolute bottom-16 left-4 right-4 bg-black bg-opacity-50 p-3 rounded-lg';
  sliderContainer.innerHTML = `
    <div class="text-white text-sm mb-2">手動對焦距離</div>
    <input type="range" id="focusDistanceSlider" min="0.1" max="1.0" step="0.1" value="0.3" 
           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
    <div class="flex justify-between text-xs text-white mt-1">
      <span>近</span>
      <span>遠</span>
    </div>
  `;
  
  cameraContainer.appendChild(sliderContainer);
  
  // 綁定滑桿事件
  const slider = document.getElementById('focusDistanceSlider');
  slider.addEventListener('input', async (e) => {
    const focusDistance = parseFloat(e.target.value);
    await setManualFocusDistance(focusDistance);
  });
}

// 設置手動對焦距離
async function setManualFocusDistance(distance) {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    await videoTrack.applyConstraints({
      advanced: [{ focusDistance: distance }]
    });
  } catch (error) {
    console.error('設置對焦距離失敗:', error);
  }
}

// 重置對焦
async function resetFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    // 重置為自動對焦
    await videoTrack.applyConstraints({
      advanced: [{ focusMode: 'continuous' }]
    });
    
    // 移除手動對焦滑桿
    const slider = document.getElementById('manualFocusSlider');
    if (slider) {
      slider.remove();
    }
    
    showFocusFeedback('對焦已重置');
  } catch (error) {
    console.error('重置對焦失敗:', error);
    showFocusFeedback('重置對焦失敗');
  }
}

// 添加觸控對焦功能
function addTouchFocus() {
  const video = document.getElementById('video');
  const cameraContainer = document.getElementById('cameraContainer');
  
  // 添加觸控對焦事件
  cameraContainer.addEventListener('click', async (e) => {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    // 檢查是否支援觸控對焦
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      try {
        // 計算點擊位置相對於視頻的比例
        const rect = video.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        // 設置對焦點
        await videoTrack.applyConstraints({
          advanced: [
            { focusMode: 'manual' },
            { pointsOfInterest: [{ x: x, y: y }] }
          ]
        });
        
        // 顯示對焦指示器
        showFocusIndicator(e.clientX, e.clientY);
        showFocusFeedback('觸控對焦已設置');
        
      } catch (error) {
        console.error('觸控對焦失敗:', error);
        showFocusFeedback('觸控對焦失敗');
      }
    } else {
      showFocusFeedback('此設備不支援觸控對焦');
    }
  });
  
  // 添加雙擊重置對焦
  cameraContainer.addEventListener('dblclick', async () => {
    await resetFocus();
  });
}

// 顯示對焦指示器
function showFocusIndicator(x, y) {
  // 移除現有的指示器
  const existingIndicator = document.getElementById('focusIndicator');
  if (existingIndicator) {
    existingIndicator.remove();
  }
  
  const indicator = document.createElement('div');
  indicator.id = 'focusIndicator';
  indicator.className = 'fixed w-8 h-8 border-2 border-white rounded-full pointer-events-none z-50';
  indicator.style.left = (x - 16) + 'px';
  indicator.style.top = (y - 16) + 'px';
  indicator.style.animation = 'focusIndicatorPulse 1s ease-out forwards';
  
  document.body.appendChild(indicator);
  
  // 1秒後移除指示器
  setTimeout(() => {
    if (indicator.parentNode) {
      indicator.remove();
    }
  }, 1000);
}

// 顯示對焦反饋
function showFocusFeedback(message) {
  const feedback = document.createElement('div');
  feedback.className = 'fixed top-40 right-4 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm z-50';
  feedback.textContent = message;
  document.body.appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 2000);
}

// 停止相機掃描
function stopCameraScan() {
  scannerActive = false;
  
  // 停止Quagga掃描器
  if (typeof Quagga !== 'undefined' && Quagga) {
    Quagga.stop();
  }
  
  // 停止相機流
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  
  // 移除對焦控制按鈕
  const focusControls = document.getElementById('focusControls');
  if (focusControls) {
    focusControls.remove();
  }
  
  // 移除手動對焦滑桿
  const manualSlider = document.getElementById('manualFocusSlider');
  if (manualSlider) {
    manualSlider.remove();
  }
  
  // 移除對焦指示器
  const focusIndicator = document.getElementById('focusIndicator');
  if (focusIndicator) {
    focusIndicator.remove();
  }
  
  // 移除掃描進度指示
  const progress = document.getElementById('scanProgress');
  if (progress) progress.remove();
  
  // 移除觸控對焦事件監聽器
  const cameraContainer = document.getElementById('cameraContainer');
  if (cameraContainer) {
    // 克隆元素來移除所有事件監聽器
    const newContainer = cameraContainer.cloneNode(true);
    cameraContainer.parentNode.replaceChild(newContainer, cameraContainer);
  }
  
  document.getElementById('cameraContainer').style.display = 'none';
}

// 檢查是否為有效的發票號碼
function isValidReceiptNumber(code) {
  // 發票號碼通常是8位數字
  return /^\d{8}$/.test(code);
}

// 處理掃描成功
function handleScanSuccess(number) {
  showScanResult(number);
  stopCameraScan();
  
  // 自動填入發票號碼並對獎
  setTimeout(() => {
    document.getElementById('receiptNumber').value = number;
  closeScanner();
  checkReceipt();
  }, 2000);
}


// 對獎功能
function checkReceipt() {
  const inputNumber = document.getElementById('receiptNumber').value.trim();
  
  if (inputNumber.length !== 8 || !/^\d{8}$/.test(inputNumber)) {
    alert('請輸入8位數的發票號碼');
    return;
  }

  // 檢查開獎號碼是否已載入
  if (!winningNumbers.special || !winningNumbers.grand || winningNumbers.first.length === 0) {
    alert('開獎號碼尚未載入，請稍後再試或點擊刷新按鈕');
    return;
  }

  let result = '';
  let isWinner = false;
  let prize = '';
  let prizeLevel = '';

  // 檢查特別獎
  if (inputNumber === winningNumbers.special) {
    result = '🎊 恭喜！您中了特別獎！';
    prize = '獎金 1,000萬元';
    isWinner = true;
    prizeLevel = '特別獎';
  }
  // 檢查特獎
  else if (inputNumber === winningNumbers.grand) {
    result = '🎊 恭喜！您中了特獎！';
    prize = '獎金 200萬元';
    isWinner = true;
    prizeLevel = '特獎';
  }
  // 檢查頭獎
  else if (winningNumbers.first.some(num => inputNumber === num)) {
    result = '🥇 恭喜！您中了頭獎！';
    prize = '獎金 20萬元';
    isWinner = true;
    prizeLevel = '頭獎';
  }
  // 檢查二獎 (末7碼)
  else if (winningNumbers.first.some(num => inputNumber.slice(1) === num.slice(1))) {
    result = '🥈 恭喜！您中了二獎！';
    prize = '獎金 4萬元';
    isWinner = true;
    prizeLevel = '二獎';
  }
  // 檢查三獎 (末6碼)
  else if (winningNumbers.first.some(num => inputNumber.slice(2) === num.slice(2))) {
    result = '🥉 恭喜！您中了三獎！';
    prize = '獎金 1萬元';
    isWinner = true;
    prizeLevel = '三獎';
  }
  // 檢查四獎 (末5碼)
  else if (winningNumbers.first.some(num => inputNumber.slice(3) === num.slice(3))) {
    result = '🏅 恭喜！您中了四獎！';
    prize = '獎金 4千元';
    isWinner = true;
    prizeLevel = '四獎';
  }
  // 檢查五獎 (末4碼)
  else if (winningNumbers.first.some(num => inputNumber.slice(4) === num.slice(4))) {
    result = '🎖️ 恭喜！您中了五獎！';
    prize = '獎金 1千元';
    isWinner = true;
    prizeLevel = '五獎';
  }
  // 檢查六獎 (末3碼)
  else if (winningNumbers.first.some(num => inputNumber.slice(5) === num.slice(5)) ||
           (winningNumbers.additional && winningNumbers.additional.includes(inputNumber.slice(5)))) {
    result = '🎗️ 恭喜！您中了六獎！';
    prize = '獎金 2百元';
    isWinner = true;
    prizeLevel = '六獎';
  }
  // 未中獎
  else {
    result = '😔 很遺憾，這張發票沒有中獎';
    prize = '再接再厲！';
    prizeLevel = '未中獎';
  }

  // 添加到歷史記錄
  addToHistory(inputNumber, isWinner, prizeLevel, prize);

  // 顯示結果
  const resultSection = document.getElementById('resultSection');
  const resultContent = document.getElementById('resultContent');
  
  // 更清楚的結果顯示
  const resultClass = isWinner ? 'bg-gradient-to-r from-green-400 to-green-600 text-white' : 'bg-gradient-to-r from-gray-400 to-gray-600 text-white';
  const icon = isWinner ? '🎉' : '😔';
  const bgPattern = isWinner ? 'bg-green-50' : 'bg-gray-50';
  
  resultContent.innerHTML = `
    <div class="${bgPattern} p-6 rounded-xl border-2 ${isWinner ? 'border-green-200' : 'border-gray-200'}">
      <div class="text-center">
        <div class="text-6xl mb-4">${icon}</div>
        <div class="text-3xl font-bold mb-3 ${isWinner ? 'text-green-600' : 'text-gray-600'}">${result}</div>
        <div class="text-2xl font-mono font-bold mb-3 bg-white px-4 py-2 rounded-lg shadow-inner">${inputNumber}</div>
        <div class="text-xl font-semibold mb-2 ${isWinner ? 'text-green-700' : 'text-gray-700'}">${prize}</div>
        ${winningNumbers.period ? `<div class="text-sm text-gray-500 mt-2">期別：${winningNumbers.period}</div>` : ''}
        
        ${isWinner ? `
          <div class="mt-4 p-3 bg-yellow-100 rounded-lg">
            <div class="text-sm text-yellow-800 font-semibold">🎁 領獎提醒</div>
            <div class="text-xs text-yellow-700 mt-1">請於 115年1月5日前 至超商或郵局領獎</div>
          </div>
        ` : `
          <div class="mt-4 p-3 bg-blue-100 rounded-lg">
            <div class="text-sm text-blue-800 font-semibold">💡 小貼士</div>
            <div class="text-xs text-blue-700 mt-1">使用雲端發票可自動對獎，中獎會主動通知</div>
          </div>
        `}
      </div>
    </div>
  `;
  
  resultSection.style.display = 'block';
  resultSection.scrollIntoView({ behavior: 'smooth' });
  
  // 添加動畫效果
  setTimeout(() => {
    resultContent.style.transform = 'scale(1.02)';
    setTimeout(() => {
      resultContent.style.transform = 'scale(1)';
    }, 200);
  }, 100);
}

// 添加到歷史記錄
function addToHistory(number, isWinner, level, prize) {
  const historyItem = {
    number: number,
    isWinner: isWinner,
    level: level,
    prize: prize,
    date: new Date().toLocaleString('zh-TW')
  };
  
  history.unshift(historyItem);
  if (history.length > 20) {
    history = history.slice(0, 20); // 只保留最近20筆
  }
  
  localStorage.setItem('receiptHistory', JSON.stringify(history));
  updateHistoryDisplay();
}

// 更新歷史記錄顯示
function updateHistoryDisplay() {
  const historyList = document.getElementById('historyList');
  const historyCount = document.getElementById('historyCount');
  
  historyCount.textContent = `${history.length} 筆記錄`;
  
  if (history.length === 0) {
    historyList.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-2">📝</div>
        <div>還沒有對獎記錄</div>
        <div class="text-sm opacity-70 mt-1">開始對獎後會顯示在這裡</div>
      </div>
    `;
  } else {
    historyList.innerHTML = history.map(item => `
      <div class="history-item ${item.isWinner ? 'winner' : 'loser'}">
        <div class="flex justify-between items-center">
          <div>
            <div class="font-mono font-semibold">${item.number}</div>
            <div class="text-sm text-gray-600">${item.level} - ${item.prize}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">${item.date}</div>
            <div class="text-lg">${item.isWinner ? '🎉' : '😔'}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// 清除歷史記錄
function clearHistory() {
  if (confirm('確定要清除所有對獎歷史記錄嗎？')) {
    history = [];
    localStorage.removeItem('receiptHistory');
    updateHistoryDisplay();
  }
}

// 輸入限制：只允許數字
document.getElementById('receiptNumber').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// 按Enter鍵對獎
document.getElementById('receiptNumber').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkReceipt();
  }
});

// 末三碼快速檢查功能
function quickCheckLastThree() {
  const input = document.getElementById('lastThreeDigits').value.trim();
  const resultDiv = document.getElementById('quickCheckResult');
  
  if (input.length !== 3 || !/^\d{3}$/.test(input)) {
    resultDiv.innerHTML = '<span class="text-red-600">請輸入3位數字</span>';
    return;
  }
  
  // 檢查是否與任何開獎號碼的末三碼匹配
  const lastThree = input;
  let matches = [];
  
  // 檢查特別獎
  if (winningNumbers.special && winningNumbers.special.slice(-3) === lastThree) {
    matches.push('特別獎');
  }
  
  // 檢查特獎
  if (winningNumbers.grand && winningNumbers.grand.slice(-3) === lastThree) {
    matches.push('特獎');
  }
  
  // 檢查頭獎
  if (winningNumbers.first) {
    winningNumbers.first.forEach((num, index) => {
      if (num.slice(-3) === lastThree) {
        matches.push(`頭獎${index + 1}`);
      }
    });
  }
  
  // 檢查增開六獎
  if (winningNumbers.additional && winningNumbers.additional.includes(lastThree)) {
    matches.push('增開六獎');
  }
  
  if (matches.length > 0) {
    resultDiv.innerHTML = `<span class="text-green-600 font-semibold">🎉 可能中獎！匹配：${matches.join('、')}</span>`;
  } else {
    resultDiv.innerHTML = '<span class="text-gray-600">😔 未找到匹配的末三碼</span>';
  }
}

// 分享結果功能
function shareResult() {
  const resultContent = document.getElementById('resultContent');
  const resultText = resultContent.textContent || resultContent.innerText;
  
  if (navigator.share) {
    navigator.share({
      title: '發票對獎結果',
      text: resultText,
      url: window.location.href
    }).catch(err => console.log('分享失敗:', err));
  } else {
    // 複製到剪貼板
    copyToClipboard(resultText);
    showMessage('結果已複製到剪貼板！');
  }
}

// 複製結果功能
function copyResult() {
  const resultContent = document.getElementById('resultContent');
  const resultText = resultContent.textContent || resultContent.innerText;
  copyToClipboard(resultText);
  showMessage('結果已複製到剪貼板！');
}

// 複製到剪貼板
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text);
  } else {
    // 備用方案
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  }
}

// 顯示訊息
function showMessage(message) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  messageDiv.textContent = message;
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    messageDiv.remove();
  }, 3000);
}

// 末三碼輸入限制
document.getElementById('lastThreeDigits').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// 雲端發票APP下載
function openCloudInvoiceApp() {
  const userAgent = navigator.userAgent.toLowerCase();
  let appUrl = '';
  
  if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
    appUrl = 'https://apps.apple.com/tw/app/統一發票兌獎/id1448254128';
  } else if (userAgent.includes('android')) {
    appUrl = 'https://play.google.com/store/apps/details?id=tw.gov.einvoice';
  } else {
    appUrl = 'https://www.einvoice.nat.gov.tw/';
  }
  
  window.open(appUrl, '_blank');
}

// 顯示雲端發票指南
function showCloudInvoiceGuide() {
  const guide = document.getElementById('cloudGuide');
  if (guide.style.display === 'none') {
    guide.style.display = 'block';
    guide.scrollIntoView({ behavior: 'smooth' });
  } else {
    guide.style.display = 'none';
  }
}

// 清除輸入
function clearInput() {
  document.getElementById('receiptNumber').value = '';
  document.getElementById('lastThreeDigits').value = '';
  document.getElementById('quickCheckResult').innerHTML = '';
  document.getElementById('resultSection').style.display = 'none';
  
  // 聚焦到輸入框
  document.getElementById('receiptNumber').focus();
}

// 顯示快速小貼士
function showQuickTips() {
  const tips = [
    '💡 先檢查末三碼，快速篩選可能中獎的發票',
    '📱 使用雲端發票可自動對獎，中獎會主動通知',
    '🎯 每期開獎後記得檢查所有發票',
    '💰 獎金超過1,000元需扣繳所得稅',
    '⏰ 記得在領獎期限內領獎，逾期視同放棄'
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  showMessage(randomTip);
}

// 繼續對獎
function checkAnother() {
  clearInput();
  document.getElementById('receiptNumber').focus();
}

// 查看歷史
function viewHistory() {
  const historySection = document.querySelector('section:has(#historyList)');
  if (historySection) {
    historySection.scrollIntoView({ behavior: 'smooth' });
    // 自動展開歷史記錄
    toggleHistory(true);
  }
}

// 切換歷史記錄顯示
function toggleHistory(forceOpen = false) {
  const historyContent = document.getElementById('historyContent');
  const toggleIcon = document.getElementById('historyToggleIcon');
  const toggleText = document.getElementById('historyToggleText');
  
  const isCurrentlyOpen = historyContent.style.display !== 'none';
  const shouldOpen = forceOpen || !isCurrentlyOpen;
  
  if (shouldOpen) {
    historyContent.style.display = 'block';
    toggleIcon.textContent = '📁';
    toggleText.textContent = '收合';
    
    // 添加展開動畫
    historyContent.style.opacity = '0';
    historyContent.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      historyContent.style.transition = 'all 0.3s ease';
      historyContent.style.opacity = '1';
      historyContent.style.transform = 'translateY(0)';
    }, 10);
  } else {
    // 添加收合動畫
    historyContent.style.transition = 'all 0.3s ease';
    historyContent.style.opacity = '0';
    historyContent.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      historyContent.style.display = 'none';
      historyContent.style.transition = '';
    }, 300);
    
    toggleIcon.textContent = '📂';
    toggleText.textContent = '展開';
  }
}

// 刷新開獎號碼
async function refreshWinningNumbers() {
  await fetchLatestWinningNumbers();
}

// 從本地儲存載入開獎號碼
function loadWinningNumbersFromStorage() {
  const stored = localStorage.getItem('winningNumbers');
  if (stored) {
    try {
      const data = JSON.parse(stored);
      updateWinningNumbers(data);
    } catch (error) {
      console.error('載入本地開獎號碼失敗:', error);
    }
  }
}

// 檢查是否需要更新開獎號碼
function shouldUpdateWinningNumbers() {
  const stored = localStorage.getItem('winningNumbers');
  if (!stored) return true;
  
  try {
    const data = JSON.parse(stored);
    const lastUpdate = new Date(data.updateTime);
    const now = new Date();
    const minutesDiff = (now - lastUpdate) / (1000 * 60);
    
    // 檢查網絡狀態
    if (navigator.onLine === false) {
      console.log('離線模式，使用緩存數據');
      return false;
    }
    
    // 如果超過15分鐘就更新（更頻繁的更新）
    return minutesDiff > 15;
  } catch (error) {
    return true;
  }
}

// 網絡狀態監聽
function setupNetworkMonitoring() {
  window.addEventListener('online', () => {
    console.log('網絡已連接，檢查是否需要更新開獎號碼');
    if (shouldUpdateWinningNumbers()) {
      fetchLatestWinningNumbers();
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('網絡已斷開，使用離線模式');
    showOfflineMessage();
  });
}

// 顯示離線訊息
function showOfflineMessage() {
  const offlineIndicator = document.createElement('div');
  offlineIndicator.id = 'offlineIndicator';
  offlineIndicator.className = 'fixed top-4 left-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  offlineIndicator.innerHTML = '📱 離線模式 - 使用緩存數據';
  document.body.appendChild(offlineIndicator);
  
  // 5秒後自動隱藏
  setTimeout(() => {
    const indicator = document.getElementById('offlineIndicator');
    if (indicator) indicator.remove();
  }, 5000);
}

// 頁面初始化
async function initializePage() {
  try {
    // 設置網絡監聽
    setupNetworkMonitoring();
    
    // 載入本地儲存的開獎號碼
    loadWinningNumbersFromStorage();
    
    // 檢查是否需要更新
    if (shouldUpdateWinningNumbers()) {
      await fetchLatestWinningNumbers();
    }

    // 初始化歷史記錄顯示
    updateHistoryDisplay();
    
    // 設置定時更新
    setupAutoUpdate();
    
    // 顯示成功訊息
    showSuccessMessage('發票對獎系統已準備就緒');
    
  } catch (error) {
    console.error('頁面初始化失敗:', error);
    showErrorMessage('系統初始化失敗，請刷新頁面重試');
  }
}

// 設置自動更新
function setupAutoUpdate() {
  // 每15分鐘檢查一次更新
  setInterval(async () => {
    if (shouldUpdateWinningNumbers()) {
      console.log('定時檢查：嘗試更新開獎號碼');
      await fetchLatestWinningNumbers();
    }
  }, 15 * 60 * 1000); // 15分鐘
  
  // 每分鐘更新時間顯示
  setInterval(() => {
    updateLastUpdateTime();
  }, 60 * 1000); // 1分鐘
}

// 顯示成功訊息
function showSuccessMessage(message) {
  const successIndicator = document.createElement('div');
  successIndicator.className = 'fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  successIndicator.innerHTML = `✅ ${message}`;
  document.body.appendChild(successIndicator);
  
  setTimeout(() => {
    successIndicator.remove();
  }, 3000);
}

// 初始化歷史記錄顯示
updateHistoryDisplay();

// 註冊Service Worker支持離線功能
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', initializePage);

// 添加頁面可見性監聽，當頁面重新可見時檢查更新
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && shouldUpdateWinningNumbers()) {
    fetchLatestWinningNumbers();
  }
});
</script>
</body>
</html>
