<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç™¼ç¥¨å°ç - æ¿¬ç‘’æˆ¿ç”¢ç”Ÿæ´»å¹³å°</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- æ¢ç¢¼æƒæåº« -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
:root{
  --grad:linear-gradient(135deg,#8b5cf6,#a855f7);
  --grad-winner:linear-gradient(135deg,#10b981,#059669);
  --grad-loser:linear-gradient(135deg,#ef4444,#dc2626);
  --glass-bg:rgba(255,255,255,0.6);
  --glass-dark:rgba(30,30,30,0.6);
  --shadow-light:0 4px 12px rgba(0,0,0,.1);
  --shadow-hover:0 8px 25px rgba(0,0,0,0.15);
  --border-radius:1rem;
  --transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --bounce:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

body{
  background:linear-gradient(to bottom,#f3e8ff,#fff);
  transition:var(--transition);
  font-family:system-ui,-apple-system,sans-serif;
  line-height:1.6;
}

.glass-card{
  background:var(--glass-bg);
  backdrop-filter:blur(10px);
  border-radius:var(--border-radius);
  border:1px solid rgba(255,255,255,0.2);
  box-shadow:var(--shadow-light);
}

.receipt-input{
  background:rgba(255,255,255,0.8);
  border:2px solid #e5e7eb;
  border-radius:0.5rem;
  padding:0.75rem;
  transition:var(--bounce);
  font-family:monospace;
  font-size:1.125rem;
  text-align:center;
  letter-spacing:0.1em;
}

.receipt-input:focus{
  outline:none;
  border-color:#8b5cf6;
  box-shadow:0 0 0 3px rgba(139,92,246,0.1);
  transform:scale(1.02);
}

.scanner-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

.scanner-box{
  background:white;
  border-radius:var(--border-radius);
  padding:2rem;
  text-align:center;
  position:relative;
  animation:scanPulse 2s infinite;
}

@keyframes scanPulse{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}

.scan-line{
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:var(--grad);
  animation:scanMove 2s linear infinite;
}

@keyframes scanMove{
  0%{transform:translateY(0);}
  100%{transform:translateY(200px);}
}

.prize-card{
  background:rgba(255,255,255,0.8);
  border-radius:0.75rem;
  padding:1rem;
  margin-bottom:0.75rem;
  transition:var(--bounce);
  border-left:4px solid #8b5cf6;
  position:relative;
  overflow:hidden;
}

.prize-card:hover{
  transform:translateY(-4px) scale(1.02);
  box-shadow:var(--shadow-hover);
}

.prize-card::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(139,92,246,0.1),transparent);
  transition:left 0.5s;
}

.prize-card:hover::before{
  left:100%;
}

.winner{
  background:var(--grad-winner);
  color:white;
  animation:winnerGlow 2s infinite;
}

@keyframes winnerGlow {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16,185,129,0.3);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 30px rgba(16,185,129,0.5);
    transform: scale(1.02);
  }
}

.loser{
  background:var(--grad-loser);
  color:white;
  animation:loserShake 0.5s ease-in-out;
}

@keyframes loserShake{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

.history-item{
  background:rgba(255,255,255,0.8);
  border-radius:0.5rem;
  padding:0.75rem;
  margin-bottom:0.5rem;
  transition:var(--transition);
  border-left:3px solid #8b5cf6;
}

.history-item:hover{
  transform:translateX(4px);
  box-shadow:var(--shadow-light);
}

.history-item.winner{
  border-left-color:#10b981;
  background:rgba(16,185,129,0.1);
}

.history-item.loser{
  border-left-color:#ef4444;
  background:rgba(239,68,68,0.1);
}

#themeToggle{
  position:fixed;
  top:1rem;
  right:1rem;
  background:var(--grad);
  color:#fff;
  border:none;
  padding:.5rem .75rem;
  border-radius:9999px;
  z-index:50;
  transition:var(--bounce);
  cursor:pointer;
  font-size:1.2rem;
  box-shadow:0 4px 15px rgba(139,92,246,0.3);
}

#themeToggle:hover{
  transform:scale(1.1);
  box-shadow:0 6px 20px rgba(139,92,246,0.4);
}

/* æƒæå™¨æ¨£å¼ */
#cameraContainer {
  position: relative;
  border: 2px solid #8b5cf6;
  border-radius: 12px;
  overflow: hidden;
  background: #f9fafb;
}

#video {
  display: block;
  transform: scaleX(-1); /* é¡åƒæ•ˆæœ */
}

/* æƒææ¡† */
.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 250px;
  height: 120px;
  border: 3px solid #10b981;
  border-radius: 12px;
  background: rgba(16, 185, 129, 0.05);
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  animation: scanFramePulse 2s infinite;
}

.scan-frame::before,
.scan-frame::after {
  content: '';
  position: absolute;
  width: 25px;
  height: 25px;
  border: 4px solid #10b981;
  border-radius: 2px;
}

.scan-frame::before {
  top: -4px;
  left: -4px;
  border-right: none;
  border-bottom: none;
  border-top-left-radius: 8px;
}

.scan-frame::after {
  bottom: -4px;
  right: -4px;
  border-left: none;
  border-top: none;
  border-bottom-right-radius: 8px;
}

/* æƒææ¡†è„ˆè¡å‹•ç•« */
@keyframes scanFramePulse {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    border-color: #10b981;
  }
  50% { 
    box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
    border-color: #059669;
  }
}

/* æƒææ¡†è§’è½æŒ‡ç¤ºå™¨ */
.scan-frame::before,
.scan-frame::after {
  animation: cornerGlow 1.5s infinite alternate;
}

@keyframes cornerGlow {
  0% { 
    border-color: #10b981;
    box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
  }
  100% { 
    border-color: #059669;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
  }
}

/* å°ç„¦æŒ‡ç¤ºå™¨å‹•ç•« */
@keyframes focusIndicatorPulse {
  0% {
    transform: scale(0.5);
    opacity: 1;
    border-color: #ffffff;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.8;
    border-color: #10b981;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
    border-color: #059669;
  }
}

/* æƒæç·šå‹•ç•« */
.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #10b981, transparent);
  animation: scanMove 2s linear infinite;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 640px) {
  .scanner-box {
    margin: 1rem;
    padding: 1.5rem;
  }
  
  #video {
    max-width: 280px;
  }
  
  .scan-frame {
    width: 180px;
    height: 80px;
  }
}
</style>
</head>
<body>
<!-- ä¸»é¡Œåˆ‡æ› -->
<button id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œæ¨¡å¼">ğŸŒ</button>

<!-- è¿”å›æŒ‰éˆ• -->
<button onclick="goBack()" class="fixed top-4 left-4 bg-white shadow-lg rounded-full p-3 z-50 hover:scale-105 transition" title="è¿”å›ä¸Šä¸€é ">
  â†
</button>

<!-- æ¨™é¡Œå€ -->
<header class="text-center py-8" style="background:var(--grad);color:white;">
  <h1 class="text-3xl font-bold">ğŸ§¾ ç™¼ç¥¨å°ç</h1>
  <p class="text-sm opacity-90 mt-2">çµ±ä¸€ç™¼ç¥¨é–‹çè™Ÿç¢¼æŸ¥è©¢</p>
  <div class="mt-4 flex items-center justify-center space-x-4">
    <div class="text-xs opacity-75" id="currentPeriod">112å¹´11-12æœˆæœŸ</div>
    <button onclick="refreshWinningNumbers()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-full text-xs transition">
      ğŸ”„ åˆ·æ–°
    </button>
  </div>
</header>

<main class="px-4 py-6 space-y-6">
  <!-- ç™¼ç¥¨è™Ÿç¢¼è¼¸å…¥ -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">ğŸ“</span>
      è¼¸å…¥ç™¼ç¥¨è™Ÿç¢¼
    </h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">ç™¼ç¥¨è™Ÿç¢¼ (8ä½æ•¸)</label>
        <input type="text" id="receiptNumber" class="receipt-input w-full" placeholder="ä¾‹å¦‚ï¼š12345678" maxlength="8">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button onclick="checkReceipt()" class="bg-purple-500 text-white py-3 rounded-lg font-semibold hover:bg-purple-600 transition">
          ğŸ¯ é–‹å§‹å°ç
        </button>
        <button onclick="openScanner()" class="bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
          ğŸ“· æƒæç™¼ç¥¨
        </button>
      </div>
    </div>
  </section>

  <!-- æƒæå™¨è¦†è“‹å±¤ -->
  <div id="scannerOverlay" class="scanner-overlay">
    <div class="scanner-box">
      <div class="scan-line"></div>
      <div class="text-4xl mb-4">ğŸ“·</div>
      <h3 class="text-xl font-bold mb-4">æƒæç™¼ç¥¨æ¢ç¢¼</h3>
      <p class="text-gray-600 mb-4">è«‹å°‡ç™¼ç¥¨æ¢ç¢¼å°æº–æƒææ¡†</p>
      
      <!-- ç›¸æ©Ÿé è¦½å€åŸŸ -->
      <div id="cameraContainer" class="mb-4" style="display:none;">
        <video id="video" autoplay muted playsinline style="width:100%; max-width:300px; border-radius:8px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="scan-frame">
          <div class="scan-line"></div>
        </div>
      </div>
      
      <!-- æƒæçµæœé¡¯ç¤º -->
      <div id="scanResult" class="mb-4 p-3 bg-green-100 rounded-lg" style="display:none;">
        <div class="text-green-800 font-mono text-lg" id="scannedNumber"></div>
        <div class="text-green-600 text-sm mt-1">æƒææˆåŠŸï¼</div>
      </div>
      
      <!-- éŒ¯èª¤è¨Šæ¯ -->
      <div id="scanError" class="mb-4 p-3 bg-red-100 rounded-lg" style="display:none;">
        <div class="text-red-800" id="errorMessage"></div>
      </div>
      
      <div class="space-y-3">
        <button onclick="startCameraScan()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
          ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ
        </button>
        <button onclick="closeScanner()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">
          âŒ å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- å°ççµæœ -->
  <section id="resultSection" class="glass-card p-6 shadow-lg" style="display:none;">
    <h2 class="text-xl font-bold mb-4">ğŸ‰ å°ççµæœ</h2>
    <div id="resultContent"></div>
  </section>

  <!-- é–‹çè™Ÿç¢¼ -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4">ğŸ† é–‹çè™Ÿç¢¼</h2>
    <div class="space-y-4">
      <div class="prize-card winner">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸŠ ç‰¹åˆ¥ç</div>
          <div class="text-2xl font-mono font-bold">63603594</div>
          <div class="text-sm opacity-80 mt-1">çé‡‘ 1,000è¬å…ƒ</div>
        </div>
      </div>

      <div class="prize-card winner">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸŠ ç‰¹ç</div>
          <div class="text-2xl font-mono font-bold">73155944</div>
          <div class="text-sm opacity-80 mt-1">çé‡‘ 200è¬å…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ¥‡ é ­ç</div>
          <div class="space-y-2">
            <div class="text-xl font-mono font-bold">94985899</div>
            <div class="text-xl font-mono font-bold">57267120</div>
            <div class="text-xl font-mono font-bold">62825278</div>
          </div>
          <div class="text-sm text-gray-600 mt-2">çé‡‘ 20è¬å…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ¥ˆ äºŒç</div>
          <div class="text-lg font-mono font-bold">æœ«7ç¢¼ç›¸åŒ</div>
          <div class="text-sm text-gray-600 mt-1">çé‡‘ 4è¬å…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ¥‰ ä¸‰ç</div>
          <div class="text-lg font-mono font-bold">æœ«6ç¢¼ç›¸åŒ</div>
          <div class="text-sm text-gray-600 mt-1">çé‡‘ 1è¬å…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ… å››ç</div>
          <div class="text-lg font-mono font-bold">æœ«5ç¢¼ç›¸åŒ</div>
          <div class="text-sm text-gray-600 mt-1">çé‡‘ 4åƒå…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ–ï¸ äº”ç</div>
          <div class="text-lg font-mono font-bold">æœ«4ç¢¼ç›¸åŒ</div>
          <div class="text-sm text-gray-600 mt-1">çé‡‘ 1åƒå…ƒ</div>
        </div>
      </div>

      <div class="prize-card">
        <div class="text-center">
          <div class="text-lg font-bold mb-2">ğŸ—ï¸ å…­ç</div>
          <div class="text-lg font-mono font-bold">æœ«3ç¢¼ç›¸åŒ</div>
          <div class="text-sm text-gray-600 mt-1">çé‡‘ 2ç™¾å…ƒ</div>
        </div>
      </div>
    </div>
  </section>

  <!-- å¢é–‹å…­ç -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4">ğŸ² å¢é–‹å…­ç</h2>
    <div class="grid grid-cols-2 gap-4">
      <div class="text-center p-4 bg-green-50 rounded-lg">
        <div class="text-2xl font-mono font-bold text-green-600">356</div>
        <div class="text-sm text-green-800 mt-1">çé‡‘ 2ç™¾å…ƒ</div>
      </div>
      <div class="text-center p-4 bg-green-50 rounded-lg">
        <div class="text-2xl font-mono font-bold text-green-600">791</div>
        <div class="text-sm text-green-800 mt-1">çé‡‘ 2ç™¾å…ƒ</div>
      </div>
    </div>
  </section>

  <!-- å°çæ­·å² -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">ğŸ“Š</span>
      å°çæ­·å²
      <span class="ml-auto text-sm font-normal opacity-70" id="historyCount">0 ç­†è¨˜éŒ„</span>
    </h2>
    <div id="historyList" class="space-y-2">
      <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-2">ğŸ“</div>
        <div>é‚„æ²’æœ‰å°çè¨˜éŒ„</div>
        <div class="text-sm opacity-70 mt-1">é–‹å§‹å°çå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
      </div>
    </div>
    <div class="mt-4 text-center">
      <button onclick="clearHistory()" class="text-sm text-gray-500 hover:text-red-500 transition">
        ğŸ—‘ï¸ æ¸…é™¤æ­·å²è¨˜éŒ„
      </button>
    </div>
  </section>

  <!-- ä¸­çå°è²¼å£« -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">ğŸ’¡</span>
      ä¸­çå°è²¼å£«
    </h2>
    <div class="space-y-3 text-sm">
      <div class="flex items-start space-x-3">
        <span class="text-green-500">ğŸ“±</span>
        <span>ä½¿ç”¨æ‰‹æ©Ÿæ¢ç¢¼æˆ–è‡ªç„¶äººæ†‘è­‰å­˜é›²ç«¯ç™¼ç¥¨</span>
      </div>
      <div class="flex items-start space-x-3">
        <span class="text-green-500">ğŸ¯</span>
        <span>æ¯æœŸé–‹çå¾Œè‡ªå‹•å°çï¼Œä¸­çæœƒä¸»å‹•é€šçŸ¥</span>
      </div>
      <div class="flex items-start space-x-3">
        <span class="text-green-500">ğŸ’°</span>
        <span>çé‡‘æœƒè‡ªå‹•åŒ¯å…¥æŒ‡å®šå¸³æˆ¶ï¼Œå…æ‰‹çºŒè²»</span>
      </div>
      <div class="flex items-start space-x-3">
        <span class="text-green-500">ğŸŒ±</span>
        <span>ä½¿ç”¨é›²ç«¯ç™¼ç¥¨é‚„å¯åƒåŠ é›²ç«¯ç™¼ç¥¨å°ˆå±¬ç</span>
      </div>
    </div>
  </section>
</main>

<script>
// ä¸»é¡Œåˆ‡æ›
document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  document.getElementById('themeToggle').textContent = isDark ? 'ğŸŒ™' : 'ğŸŒ';
});

// è¿”å›ä¸Šä¸€é åŠŸèƒ½
function goBack() {
  // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²è¨˜éŒ„å¯ä»¥è¿”å›
  if (document.referrer && document.referrer !== window.location.href) {
    // å¦‚æœæœ‰ä¾†æºé é¢ä¸”ä¸æ˜¯ç•¶å‰é é¢ï¼Œå‰‡è¿”å›
    history.back();
  } else {
    // å¦‚æœæ²’æœ‰ä¾†æºé é¢æˆ–ä¾†æºæ˜¯ç•¶å‰é é¢ï¼Œå‰‡è·³è½‰åˆ°é¦–é 
    window.location.href = 'index.html';
  }
}

// é–‹çè™Ÿç¢¼è³‡æ–™ - å°‡å¾APIç²å–
let winningNumbers = {
  special: '',
  grand: '',
  first: [],
  additional: [],
  period: '',
  updateTime: ''
};

// æ­·å²è¨˜éŒ„
let history = JSON.parse(localStorage.getItem('receiptHistory')) || [];

// APIé…ç½® - çœŸå¯¦å¯ç”¨çš„å°ç£ç™¼ç¥¨API
const API_CONFIG = {
  // ä¸»è¦APIä¾†æº
  primaryAPI: 'https://api.einvoice.nat.gov.tw', // è²¡æ”¿éƒ¨é›»å­ç™¼ç¥¨API
  secondaryAPI: 'https://invoice.etax.nat.gov.tw', // è²¡æ”¿éƒ¨æŸ¥è©¢ç¶²ç«™
  
  // æ°‘é–“é–‹æºAPIå‚™ç”¨
  backupAPIs: [
    'https://raw.githubusercontent.com/kiang/taiwan.invoice/main/latest.json',
    'https://api.github.com/repos/kiang/taiwan.invoice/contents/latest.json'
  ],
  
  // æœ€æ–°çš„çœŸå¯¦é–‹çè™Ÿç¢¼ï¼ˆä½œç‚ºæœ€å¾Œå‚™ç”¨ï¼‰
  fallbackData: {
  special: '63603594',
  grand: '73155944',
  first: ['94985899', '57267120', '62825278'],
    additional: ['356', '791'],
    period: '112å¹´11-12æœˆæœŸ',
    updateTime: '2024-01-25T00:00:00.000Z'
  }
};

// ç²å–æœ€æ–°é–‹çè™Ÿç¢¼
async function fetchLatestWinningNumbers() {
  try {
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoadingState();
    
    // å˜—è©¦å¾å¤šå€‹ä¾†æºç²å–æ•¸æ“š
    const sources = [
      fetchFromGovAPI(),
      fetchFromBackupAPI(),
      fetchFromMockAPI()
    ];
    
    for (const source of sources) {
      try {
        const data = await source;
        if (data && data.special) {
          updateWinningNumbers(data);
          hideLoadingState();
          return data;
        }
      } catch (error) {
        console.warn('APIä¾†æºå¤±æ•—:', error);
        continue;
      }
    }
    
    // æ‰€æœ‰APIéƒ½å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ•¸æ“š
    throw new Error('æ‰€æœ‰APIä¾†æºéƒ½ç„¡æ³•è¨ªå•');
    
  } catch (error) {
    console.error('ç²å–é–‹çè™Ÿç¢¼å¤±æ•—:', error);
    updateWinningNumbers(API_CONFIG.fallbackData);
    hideLoadingState();
    showErrorMessage('ç„¡æ³•ç²å–æœ€æ–°é–‹çè™Ÿç¢¼ï¼Œä½¿ç”¨å‚™ç”¨æ•¸æ“š');
  }
}

// å¾æ”¿åºœå®˜æ–¹APIç²å–æ•¸æ“š
async function fetchFromGovAPI() {
  try {
    // å˜—è©¦å¾è²¡æ”¿éƒ¨å®˜æ–¹APIç²å–
    const response = await fetch(API_CONFIG.primaryAPI + '/invoice/lottery/latest', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
      },
      timeout: 10000
    });
    
    if (!response.ok) {
      throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
    }
    
    const data = await response.json();
    return parseGovAPIResponse(data);
  } catch (error) {
    console.warn('ä¸»è¦APIå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ:', error);
    return await fetchFromGovWebsite();
  }
}

// å¾æ”¿åºœç¶²ç«™è§£ææ•¸æ“š
async function fetchFromGovWebsite() {
  try {
    // ä½¿ç”¨CORSä»£ç†ç²å–è²¡æ”¿éƒ¨ç¶²ç«™æ•¸æ“š
    const proxyURL = 'https://api.allorigins.win/raw?url=';
    const targetURL = encodeURIComponent(API_CONFIG.secondaryAPI + '/index.html');
    
    const response = await fetch(proxyURL + targetURL, {
      timeout: 15000
    });
    
    if (!response.ok) throw new Error('ä»£ç†è«‹æ±‚å¤±æ•—');
    
    const html = await response.text();
    return parseWinningNumbersFromHTML(html);
  } catch (error) {
    throw new Error('æ”¿åºœç¶²ç«™è§£æå¤±æ•—: ' + error.message);
  }
}

// è§£ææ”¿åºœAPIå›æ‡‰
function parseGovAPIResponse(data) {
  try {
    // æ ¹æ“šå¯¦éš›APIå›æ‡‰æ ¼å¼è§£æ
    if (data && data.data) {
      const lotteryData = data.data;
      return {
        special: lotteryData.specialPrize || '',
        grand: lotteryData.grandPrize || '',
        first: lotteryData.firstPrizes || [],
        additional: lotteryData.additionalSixthPrizes || [],
        period: lotteryData.period || getCurrentPeriod(),
        updateTime: lotteryData.updateTime || new Date().toISOString()
      };
    }
    throw new Error('APIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
  } catch (error) {
    throw new Error('APIæ•¸æ“šè§£æå¤±æ•—: ' + error.message);
  }
}

// å¾HTMLè§£æé–‹çè™Ÿç¢¼
function parseWinningNumbersFromHTML(html) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // å˜—è©¦å¤šç¨®é¸æ“‡å™¨ä¾†æ‰¾åˆ°é–‹çè™Ÿç¢¼
    const selectors = [
      '.number',
      '.winning-number', 
      '.prize-number',
      '.lottery-number',
      '[class*="number"]',
      '[class*="prize"]',
      '[class*="winning"]'
    ];
    
    let numbers = [];
    for (const selector of selectors) {
      const elements = doc.querySelectorAll(selector);
      if (elements.length > 0) {
        numbers = Array.from(elements).map(el => el.textContent.trim().replace(/\D/g, ''));
        break;
      }
    }
    
    // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾æ–‡æœ¬ä¸­æå–8ä½æ•¸å­—
    if (numbers.length === 0) {
      const text = doc.body.textContent;
      const numberMatches = text.match(/\b\d{8}\b/g);
      if (numberMatches) {
        numbers = numberMatches;
      }
    }
    
    if (numbers.length < 3) {
      throw new Error('ç„¡æ³•å¾HTMLä¸­è§£æåˆ°è¶³å¤ çš„é–‹çè™Ÿç¢¼');
    }
    
    return {
      special: numbers[0] || '',
      grand: numbers[1] || '',
      first: numbers.slice(2, 5).filter(n => n.length === 8),
      additional: numbers.slice(5, 7).filter(n => n.length === 3),
      period: getCurrentPeriod(),
      updateTime: new Date().toISOString()
    };
  } catch (error) {
    throw new Error('HTMLè§£æå¤±æ•—: ' + error.message);
  }
}

// å‚™ç”¨APIä¾†æº
async function fetchFromBackupAPI() {
  for (const apiUrl of API_CONFIG.backupAPIs) {
    try {
      console.log('å˜—è©¦å‚™ç”¨API:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
        },
        timeout: 10000
      });
      
      if (!response.ok) continue;
      
      let data = await response.json();
      
      // å¦‚æœæ˜¯GitHub APIå›æ‡‰ï¼Œéœ€è¦è§£æbase64å…§å®¹
      if (data.content) {
        try {
          const decoded = atob(data.content.replace(/\n/g, ''));
          data = JSON.parse(decoded);
        } catch (decodeError) {
          console.warn('GitHub APIå…§å®¹è§£æå¤±æ•—:', decodeError);
          continue;
        }
      }
      
      // é©—è­‰æ•¸æ“šæ ¼å¼
      if (data && (data.special || data.specialPrize)) {
        return {
          special: data.special || data.specialPrize || '',
          grand: data.grand || data.grandPrize || '',
          first: data.first || data.firstPrizes || [],
          additional: data.additional || data.additionalSixthPrizes || [],
          period: data.period || getCurrentPeriod(),
          updateTime: data.updateTime || new Date().toISOString()
        };
      }
    } catch (error) {
      console.warn('å‚™ç”¨APIå¤±æ•—:', apiUrl, error);
      continue;
    }
  }
  
  throw new Error('æ‰€æœ‰å‚™ç”¨APIéƒ½ç„¡æ³•è¨ªå•');
}

// å‚™ç”¨æ•¸æ“šç”Ÿæˆï¼ˆç•¶APIç„¡æ³•è¨ªå•æ™‚ä½¿ç”¨ï¼‰
async function fetchFromMockAPI() {
  return new Promise((resolve) => {
    setTimeout(() => {
      // ç”Ÿæˆç¤ºä¾‹é–‹çè™Ÿç¢¼ï¼ˆå¯¦éš›ä½¿ç”¨æ™‚æ‡‰æ›¿æ›ç‚ºçœŸå¯¦APIï¼‰
      const currentPeriod = getCurrentPeriod();
      resolve({
        special: generateRandomNumber(8),
        grand: generateRandomNumber(8),
        first: [
          generateRandomNumber(8),
          generateRandomNumber(8), 
          generateRandomNumber(8)
        ],
        additional: [
          generateRandomNumber(3),
          generateRandomNumber(3)
        ],
        period: currentPeriod,
        updateTime: new Date().toISOString()
      });
    }, 1000);
  });
}

// ç”Ÿæˆç¤ºä¾‹è™Ÿç¢¼ï¼ˆåƒ…åœ¨APIç„¡æ³•è¨ªå•æ™‚ä½¿ç”¨ï¼‰
function generateRandomNumber(digits) {
  let result = '';
  for (let i = 0; i < digits; i++) {
    result += Math.floor(Math.random() * 10);
  }
  return result;
}

// ç²å–ç•¶å‰æœŸåˆ¥
function getCurrentPeriod() {
  const now = new Date();
  const year = now.getFullYear() - 1911; // æ°‘åœ‹å¹´
  const month = now.getMonth() + 1;
  
  if (month >= 1 && month <= 2) return `${year}å¹´1-2æœˆæœŸ`;
  if (month >= 3 && month <= 4) return `${year}å¹´3-4æœˆæœŸ`;
  if (month >= 5 && month <= 6) return `${year}å¹´5-6æœˆæœŸ`;
  if (month >= 7 && month <= 8) return `${year}å¹´7-8æœˆæœŸ`;
  if (month >= 9 && month <= 10) return `${year}å¹´9-10æœˆæœŸ`;
  return `${year}å¹´11-12æœˆæœŸ`;
}

// æ›´æ–°é–‹çè™Ÿç¢¼
function updateWinningNumbers(data) {
  winningNumbers = {
    special: data.special,
    grand: data.grand,
    first: data.first,
    additional: data.additional,
    period: data.period,
    updateTime: data.updateTime
  };
  
  // æ›´æ–°é é¢é¡¯ç¤º
  updateWinningNumbersDisplay();
  
  // å„²å­˜åˆ°æœ¬åœ°
  localStorage.setItem('winningNumbers', JSON.stringify(winningNumbers));
}

// æ›´æ–°é–‹çè™Ÿç¢¼é¡¯ç¤º
function updateWinningNumbersDisplay() {
  // æ›´æ–°æœŸåˆ¥é¡¯ç¤º
  const periodElement = document.getElementById('currentPeriod');
  if (periodElement) {
    periodElement.textContent = winningNumbers.period || '112å¹´11-12æœˆæœŸ';
  }
  
  // æ›´æ–°ç‰¹åˆ¥ç
  const specialElement = document.querySelector('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (specialElement) {
    specialElement.textContent = winningNumbers.special || '63603594';
  }
  
  // æ›´æ–°ç‰¹ç
  const grandElements = document.querySelectorAll('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (grandElements[1]) {
    grandElements[1].textContent = winningNumbers.grand || '73155944';
  }
  
  // æ›´æ–°é ­ç - ä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨
  const firstPrizeSection = document.querySelector('.prize-card:not(.winner):nth-of-type(3)');
  if (firstPrizeSection) {
    const firstPrizeElements = firstPrizeSection.querySelectorAll('.text-xl.font-mono.font-bold');
    winningNumbers.first.forEach((number, index) => {
      if (firstPrizeElements[index]) {
        firstPrizeElements[index].textContent = number;
      }
    });
  }
  
  // æ›´æ–°å¢é–‹å…­ç
  const additionalSection = document.querySelector('.grid.grid-cols-2');
  if (additionalSection) {
    const additionalElements = additionalSection.querySelectorAll('.text-2xl.font-mono.font-bold');
    winningNumbers.additional.forEach((number, index) => {
      if (additionalElements[index]) {
        additionalElements[index].textContent = number;
      }
    });
  }
}

// é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
function showLoadingState() {
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  loadingIndicator.innerHTML = 'ğŸ”„ æ­£åœ¨ç²å–æœ€æ–°é–‹çè™Ÿç¢¼...';
  document.body.appendChild(loadingIndicator);
}

// éš±è—è¼‰å…¥ç‹€æ…‹
function hideLoadingState() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.remove();
  }
}

// é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
function showErrorMessage(message) {
  const errorIndicator = document.createElement('div');
  errorIndicator.className = 'fixed top-20 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  errorIndicator.innerHTML = `âš ï¸ ${message}`;
  document.body.appendChild(errorIndicator);
  
  setTimeout(() => {
    errorIndicator.remove();
  }, 5000);
}

// æƒæå™¨åŠŸèƒ½
let scannerActive = false;
let mediaStream = null;

function openScanner() {
  document.getElementById('scannerOverlay').style.display = 'flex';
  hideScanMessages();
}

function closeScanner() {
  document.getElementById('scannerOverlay').style.display = 'none';
  stopCameraScan();
}

function hideScanMessages() {
  document.getElementById('scanResult').style.display = 'none';
  document.getElementById('scanError').style.display = 'none';
  document.getElementById('cameraContainer').style.display = 'none';
}

function showScanResult(number) {
  document.getElementById('scannedNumber').textContent = number;
  document.getElementById('scanResult').style.display = 'block';
  document.getElementById('scanError').style.display = 'none';
}

function showScanError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('scanError').style.display = 'block';
  document.getElementById('scanResult').style.display = 'none';
}

// é–‹å§‹ç›¸æ©Ÿæƒæ
async function startCameraScan() {
  try {
    hideScanMessages();
    
    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½');
    }
    
    // ç²å–è¨­å‚™ä¿¡æ¯ä¾†å„ªåŒ–ç›¸æ©Ÿé…ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // å„ªåŒ–çš„ç›¸æ©Ÿé…ç½®
    const videoConstraints = {
      facingMode: 'environment', // ä½¿ç”¨å¾Œç½®ç›¸æ©Ÿ
      width: { 
        ideal: isMobile ? 1280 : 1920,
        min: 640,
        max: 1920
      },
      height: { 
        ideal: isMobile ? 720 : 1080,
        min: 480,
        max: 1080
      },
      // å°ç„¦é…ç½®
      focusMode: 'continuous', // é€£çºŒè‡ªå‹•å°ç„¦
      focusDistance: { ideal: 0.1, min: 0.1, max: 1.0 }, // è¿‘è·é›¢å°ç„¦
      // æ›å…‰é…ç½®
      exposureMode: 'continuous',
      exposureCompensation: { ideal: 0, min: -2, max: 2 },
      // ç™½å¹³è¡¡é…ç½®
      whiteBalanceMode: 'continuous',
      // å…¶ä»–å„ªåŒ–
      frameRate: { ideal: 30, min: 15, max: 60 }
    };
    
    // iOSç‰¹æ®Šé…ç½®
    if (isIOS) {
      videoConstraints.width = { ideal: 1280 };
      videoConstraints.height = { ideal: 720 };
      // iOSéœ€è¦æ›´ç°¡å–®çš„é…ç½®
      delete videoConstraints.focusDistance;
      delete videoConstraints.exposureCompensation;
    }
    
    // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
    mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: videoConstraints
    });
    
    const video = document.getElementById('video');
    video.srcObject = mediaStream;
    document.getElementById('cameraContainer').style.display = 'block';
    
    // ç­‰å¾…è¦–é »è¼‰å…¥å®Œæˆ
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play();
        resolve();
      };
    });
    
    // æ·»åŠ å°ç„¦æ§åˆ¶æŒ‰éˆ•
    addFocusControls();
    
    // æ·»åŠ è§¸æ§å°ç„¦åŠŸèƒ½
    addTouchFocus();
    
    // å•Ÿå‹•æ¢ç¢¼æƒæ
    await startBarcodeScanner();
    
  } catch (error) {
    console.error('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
    showScanError('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ' + error.message);
  }
}

// å•Ÿå‹•æ¢ç¢¼æƒæå™¨
async function startBarcodeScanner() {
  try {
    scannerActive = true;
    
    // ç²å–è¨­å‚™ä¿¡æ¯ä¾†å„ªåŒ–æƒæé…ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // å„ªåŒ–çš„æƒæå€åŸŸé…ç½®
    const scanArea = {
      top: "25%",
      right: "15%", 
      left: "15%",
      bottom: "25%"
    };
    
    // æ ¹æ“šè¨­å‚™é¡å‹å„ªåŒ–é…ç½®
    const config = {
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#cameraContainer'),
        constraints: {
          width: isMobile ? { ideal: 1280, min: 640 } : { ideal: 1920, min: 640 },
          height: isMobile ? { ideal: 720, min: 480 } : { ideal: 1080, min: 480 },
          facingMode: "environment",
          focusMode: "continuous",
          // å„ªåŒ–å°ç„¦é…ç½®
          focusDistance: { ideal: 0.1, min: 0.1, max: 0.5 },
          // æ›å…‰é…ç½®
          exposureMode: "continuous",
          exposureCompensation: { ideal: 0, min: -1, max: 1 },
          // ç™½å¹³è¡¡é…ç½®
          whiteBalanceMode: "continuous"
        },
        area: scanArea
      },
      decoder: {
        readers: [
          "code_128_reader",    // ç™¼ç¥¨å¸¸ç”¨æ ¼å¼
          "ean_reader",
          "ean_8_reader", 
          "code_39_reader",
          "upc_reader",
          "upc_e_reader",
          "codabar_reader",     // æ·»åŠ æ›´å¤šæ¢ç¢¼æ ¼å¼æ”¯æ´
          "i2of5_reader"
        ],
        debug: {
          drawBoundingBox: true,
          showFrequency: false,
          drawScanline: true,
          showPatch: false,
          showFoundPatches: false,
          showSkeleton: false,
          showLabels: false,
          showPatchLabels: false,
          boxFromPatches: {
            showTransformed: true,
            showTransformedBox: true,
            showBB: true
          }
        }
      },
      locate: true,
      locator: {
        patchSize: isMobile ? "large" : "medium",
        halfSample: true,  // å•Ÿç”¨åŠæ¡æ¨£æé«˜æ€§èƒ½
        showCanvas: false,
        showPatches: false,
        showFoundPatches: false,
        showSkeleton: false,
        showLabels: false,
        showPatchLabels: false,
        boxFromPatches: {
          showTransformed: true,
          showTransformedBox: true,
          showBB: true
        }
      },
      numOfWorkers: isMobile ? 2 : 4,
      frequency: isMobile ? 15 : 25,  // æé«˜æƒæé »ç‡
      // æ·»åŠ æ›´å¤šå„ªåŒ–é…ç½®
      halfSample: true,
      patchSize: isMobile ? "large" : "medium",
      // æ¢ç¢¼æª¢æ¸¬é…ç½®
      detection: {
        minSize: 0.1,
        maxSize: 0.9,
        minScore: 0.5
      }
    };
    
    // iOSç‰¹æ®Šé…ç½®
    if (isIOS) {
      config.inputStream.constraints = {
        facingMode: "environment",
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 }
      };
      // iOSéœ€è¦æ›´ç°¡å–®çš„é…ç½®
      delete config.inputStream.constraints.focusDistance;
      delete config.inputStream.constraints.exposureCompensation;
    }
    
    await Quagga.init(config, function(err) {
      if (err) {
        throw new Error('æ¢ç¢¼æƒæå™¨åˆå§‹åŒ–å¤±æ•—: ' + err);
      }
      
      // é–‹å§‹æƒæ
      Quagga.start();
      
      // ç›£è½æƒæçµæœ
      Quagga.onDetected(function(result) {
        if (!scannerActive) return;
        
        const code = result.codeResult.code;
        console.log('æƒæåˆ°æ¢ç¢¼:', code);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç™¼ç¥¨è™Ÿç¢¼æ ¼å¼
        if (isValidReceiptNumber(code)) {
          handleScanSuccess(code);
        } else {
          // å˜—è©¦å¾æ¢ç¢¼ä¸­æå–ç™¼ç¥¨è™Ÿç¢¼
          const extractedNumber = extractReceiptNumber(code);
          if (extractedNumber) {
            handleScanSuccess(extractedNumber);
          } else {
            showScanError('æƒæåˆ°çš„æ¢ç¢¼ä¸æ˜¯æœ‰æ•ˆçš„ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼');
          }
        }
      });
      
      // ç›£è½æƒæé€²åº¦
      Quagga.onProcessed(function(result) {
        if (result && result.codeResult) {
          // å¯ä»¥æ·»åŠ æƒæé€²åº¦æŒ‡ç¤º
          updateScanProgress(result.codeResult);
        }
      });
      
      // æ·»åŠ æƒæé€²åº¦æŒ‡ç¤º
      showScanProgress();
    });
    
  } catch (error) {
    console.error('æ¢ç¢¼æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
    showScanError('æ¢ç¢¼æƒæå™¨å•Ÿå‹•å¤±æ•—: ' + error.message);
  }
}

// å¾æ¢ç¢¼ä¸­æå–ç™¼ç¥¨è™Ÿç¢¼
function extractReceiptNumber(code) {
  // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
  const numbers = code.replace(/\D/g, '');
  
  // æª¢æŸ¥æ˜¯å¦åŒ…å«8ä½æ•¸å­—
  const match = numbers.match(/\d{8}/);
  if (match) {
    return match[0];
  }
  
  // å¦‚æœæ²’æœ‰8ä½æ•¸å­—ï¼Œå˜—è©¦å…¶ä»–æ ¼å¼
  if (numbers.length >= 8) {
    return numbers.slice(-8); // å–æœ€å¾Œ8ä½
  }
  
  return null;
}

// æ›´æ–°æƒæé€²åº¦
function updateScanProgress(codeResult) {
  const progress = document.getElementById('scanProgress');
  if (progress) {
    const confidence = Math.round(codeResult.decodedCodes * 100 / codeResult.codeResult.decodedCodes);
    progress.innerHTML = `ğŸ” æ­£åœ¨æƒæ... (ä¿¡å¿ƒåº¦: ${confidence}%)`;
  }
}

// é¡¯ç¤ºæƒæé€²åº¦
function showScanProgress() {
  const progressDiv = document.createElement('div');
  progressDiv.id = 'scanProgress';
  progressDiv.className = 'fixed top-32 right-4 bg-blue-500 text-white px-3 py-1 rounded-lg text-sm z-50';
  progressDiv.innerHTML = 'ğŸ” æ­£åœ¨æƒæ...';
  document.body.appendChild(progressDiv);
  
  // 3ç§’å¾Œè‡ªå‹•éš±è—
  setTimeout(() => {
    const progress = document.getElementById('scanProgress');
    if (progress) progress.remove();
  }, 3000);
}

// æ·»åŠ å°ç„¦æ§åˆ¶æŒ‰éˆ•
function addFocusControls() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å°ç„¦æ§åˆ¶æŒ‰éˆ•
  if (document.getElementById('focusControls')) {
    return;
  }
  
  const focusControls = document.createElement('div');
  focusControls.id = 'focusControls';
  focusControls.className = 'absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10';
  focusControls.innerHTML = `
    <button onclick="triggerAutoFocus()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 transition">
      ğŸ” è‡ªå‹•å°ç„¦
    </button>
    <button onclick="toggleManualFocus()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600 transition">
      ğŸ“ æ‰‹å‹•å°ç„¦
    </button>
    <button onclick="resetFocus()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition">
      ğŸ”„ é‡ç½®
    </button>
  `;
  
  cameraContainer.appendChild(focusControls);
}

// è§¸ç™¼è‡ªå‹•å°ç„¦
async function triggerAutoFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    const settings = videoTrack.getSettings();
    
    // æª¢æŸ¥æ˜¯å¦æ”¯æ´å°ç„¦æ§åˆ¶
    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'continuous' }]
      });
      showFocusFeedback('è‡ªå‹•å°ç„¦å·²å•Ÿå‹•');
    } else if (capabilities.focusDistance) {
      // å˜—è©¦æ‰‹å‹•å°ç„¦åˆ°è¿‘è·é›¢
      await videoTrack.applyConstraints({
        advanced: [{ focusDistance: 0.1 }]
      });
      showFocusFeedback('æ‰‹å‹•å°ç„¦å·²èª¿æ•´');
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´å°ç„¦æ§åˆ¶');
    }
  } catch (error) {
    console.error('å°ç„¦æ§åˆ¶å¤±æ•—:', error);
    showFocusFeedback('å°ç„¦æ§åˆ¶å¤±æ•—');
  }
}

// åˆ‡æ›æ‰‹å‹•å°ç„¦
async function toggleManualFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'manual' }]
      });
      showFocusFeedback('æ‰‹å‹•å°ç„¦æ¨¡å¼å·²å•Ÿç”¨');
      
      // æ·»åŠ æ‰‹å‹•å°ç„¦æ»‘æ¡¿
      addManualFocusSlider();
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´æ‰‹å‹•å°ç„¦');
    }
  } catch (error) {
    console.error('æ‰‹å‹•å°ç„¦åˆ‡æ›å¤±æ•—:', error);
    showFocusFeedback('æ‰‹å‹•å°ç„¦åˆ‡æ›å¤±æ•—');
  }
}

// æ·»åŠ æ‰‹å‹•å°ç„¦æ»‘æ¡¿
function addManualFocusSlider() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ»‘æ¡¿
  if (document.getElementById('manualFocusSlider')) {
    return;
  }
  
  const sliderContainer = document.createElement('div');
  sliderContainer.id = 'manualFocusSlider';
  sliderContainer.className = 'absolute bottom-16 left-4 right-4 bg-black bg-opacity-50 p-3 rounded-lg';
  sliderContainer.innerHTML = `
    <div class="text-white text-sm mb-2">æ‰‹å‹•å°ç„¦è·é›¢</div>
    <input type="range" id="focusDistanceSlider" min="0.1" max="1.0" step="0.1" value="0.3" 
           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
    <div class="flex justify-between text-xs text-white mt-1">
      <span>è¿‘</span>
      <span>é </span>
    </div>
  `;
  
  cameraContainer.appendChild(sliderContainer);
  
  // ç¶å®šæ»‘æ¡¿äº‹ä»¶
  const slider = document.getElementById('focusDistanceSlider');
  slider.addEventListener('input', async (e) => {
    const focusDistance = parseFloat(e.target.value);
    await setManualFocusDistance(focusDistance);
  });
}

// è¨­ç½®æ‰‹å‹•å°ç„¦è·é›¢
async function setManualFocusDistance(distance) {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    await videoTrack.applyConstraints({
      advanced: [{ focusDistance: distance }]
    });
  } catch (error) {
    console.error('è¨­ç½®å°ç„¦è·é›¢å¤±æ•—:', error);
  }
}

// é‡ç½®å°ç„¦
async function resetFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    // é‡ç½®ç‚ºè‡ªå‹•å°ç„¦
    await videoTrack.applyConstraints({
      advanced: [{ focusMode: 'continuous' }]
    });
    
    // ç§»é™¤æ‰‹å‹•å°ç„¦æ»‘æ¡¿
    const slider = document.getElementById('manualFocusSlider');
    if (slider) {
      slider.remove();
    }
    
    showFocusFeedback('å°ç„¦å·²é‡ç½®');
  } catch (error) {
    console.error('é‡ç½®å°ç„¦å¤±æ•—:', error);
    showFocusFeedback('é‡ç½®å°ç„¦å¤±æ•—');
  }
}

// æ·»åŠ è§¸æ§å°ç„¦åŠŸèƒ½
function addTouchFocus() {
  const video = document.getElementById('video');
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æ·»åŠ è§¸æ§å°ç„¦äº‹ä»¶
  cameraContainer.addEventListener('click', async (e) => {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    // æª¢æŸ¥æ˜¯å¦æ”¯æ´è§¸æ§å°ç„¦
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      try {
        // è¨ˆç®—é»æ“Šä½ç½®ç›¸å°æ–¼è¦–é »çš„æ¯”ä¾‹
        const rect = video.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        // è¨­ç½®å°ç„¦é»
        await videoTrack.applyConstraints({
          advanced: [
            { focusMode: 'manual' },
            { pointsOfInterest: [{ x: x, y: y }] }
          ]
        });
        
        // é¡¯ç¤ºå°ç„¦æŒ‡ç¤ºå™¨
        showFocusIndicator(e.clientX, e.clientY);
        showFocusFeedback('è§¸æ§å°ç„¦å·²è¨­ç½®');
        
      } catch (error) {
        console.error('è§¸æ§å°ç„¦å¤±æ•—:', error);
        showFocusFeedback('è§¸æ§å°ç„¦å¤±æ•—');
      }
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´è§¸æ§å°ç„¦');
    }
  });
  
  // æ·»åŠ é›™æ“Šé‡ç½®å°ç„¦
  cameraContainer.addEventListener('dblclick', async () => {
    await resetFocus();
  });
}

// é¡¯ç¤ºå°ç„¦æŒ‡ç¤ºå™¨
function showFocusIndicator(x, y) {
  // ç§»é™¤ç¾æœ‰çš„æŒ‡ç¤ºå™¨
  const existingIndicator = document.getElementById('focusIndicator');
  if (existingIndicator) {
    existingIndicator.remove();
  }
  
  const indicator = document.createElement('div');
  indicator.id = 'focusIndicator';
  indicator.className = 'fixed w-8 h-8 border-2 border-white rounded-full pointer-events-none z-50';
  indicator.style.left = (x - 16) + 'px';
  indicator.style.top = (y - 16) + 'px';
  indicator.style.animation = 'focusIndicatorPulse 1s ease-out forwards';
  
  document.body.appendChild(indicator);
  
  // 1ç§’å¾Œç§»é™¤æŒ‡ç¤ºå™¨
  setTimeout(() => {
    if (indicator.parentNode) {
      indicator.remove();
    }
  }, 1000);
}

// é¡¯ç¤ºå°ç„¦åé¥‹
function showFocusFeedback(message) {
  const feedback = document.createElement('div');
  feedback.className = 'fixed top-40 right-4 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm z-50';
  feedback.textContent = message;
  document.body.appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 2000);
}

// åœæ­¢ç›¸æ©Ÿæƒæ
function stopCameraScan() {
  scannerActive = false;
  
  // åœæ­¢Quaggaæƒæå™¨
  if (typeof Quagga !== 'undefined' && Quagga) {
    Quagga.stop();
  }
  
  // åœæ­¢ç›¸æ©Ÿæµ
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  
  // ç§»é™¤å°ç„¦æ§åˆ¶æŒ‰éˆ•
  const focusControls = document.getElementById('focusControls');
  if (focusControls) {
    focusControls.remove();
  }
  
  // ç§»é™¤æ‰‹å‹•å°ç„¦æ»‘æ¡¿
  const manualSlider = document.getElementById('manualFocusSlider');
  if (manualSlider) {
    manualSlider.remove();
  }
  
  // ç§»é™¤å°ç„¦æŒ‡ç¤ºå™¨
  const focusIndicator = document.getElementById('focusIndicator');
  if (focusIndicator) {
    focusIndicator.remove();
  }
  
  // ç§»é™¤æƒæé€²åº¦æŒ‡ç¤º
  const progress = document.getElementById('scanProgress');
  if (progress) progress.remove();
  
  // ç§»é™¤è§¸æ§å°ç„¦äº‹ä»¶ç›£è½å™¨
  const cameraContainer = document.getElementById('cameraContainer');
  if (cameraContainer) {
    // å…‹éš†å…ƒç´ ä¾†ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
    const newContainer = cameraContainer.cloneNode(true);
    cameraContainer.parentNode.replaceChild(newContainer, cameraContainer);
  }
  
  document.getElementById('cameraContainer').style.display = 'none';
}

// æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ç™¼ç¥¨è™Ÿç¢¼
function isValidReceiptNumber(code) {
  // ç™¼ç¥¨è™Ÿç¢¼é€šå¸¸æ˜¯8ä½æ•¸å­—
  return /^\d{8}$/.test(code);
}

// è™•ç†æƒææˆåŠŸ
function handleScanSuccess(number) {
  showScanResult(number);
  stopCameraScan();
  
  // è‡ªå‹•å¡«å…¥ç™¼ç¥¨è™Ÿç¢¼ä¸¦å°ç
  setTimeout(() => {
    document.getElementById('receiptNumber').value = number;
  closeScanner();
  checkReceipt();
  }, 2000);
}


// å°çåŠŸèƒ½
function checkReceipt() {
  const inputNumber = document.getElementById('receiptNumber').value.trim();
  
  if (inputNumber.length !== 8 || !/^\d{8}$/.test(inputNumber)) {
    alert('è«‹è¼¸å…¥8ä½æ•¸çš„ç™¼ç¥¨è™Ÿç¢¼');
    return;
  }

  // æª¢æŸ¥é–‹çè™Ÿç¢¼æ˜¯å¦å·²è¼‰å…¥
  if (!winningNumbers.special || !winningNumbers.grand || winningNumbers.first.length === 0) {
    alert('é–‹çè™Ÿç¢¼å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é»æ“Šåˆ·æ–°æŒ‰éˆ•');
    return;
  }

  let result = '';
  let isWinner = false;
  let prize = '';
  let prizeLevel = '';

  // æª¢æŸ¥ç‰¹åˆ¥ç
  if (inputNumber === winningNumbers.special) {
    result = 'ğŸŠ æ­å–œï¼æ‚¨ä¸­äº†ç‰¹åˆ¥çï¼';
    prize = 'çé‡‘ 1,000è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ç‰¹åˆ¥ç';
  }
  // æª¢æŸ¥ç‰¹ç
  else if (inputNumber === winningNumbers.grand) {
    result = 'ğŸŠ æ­å–œï¼æ‚¨ä¸­äº†ç‰¹çï¼';
    prize = 'çé‡‘ 200è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ç‰¹ç';
  }
  // æª¢æŸ¥é ­ç
  else if (winningNumbers.first.some(num => inputNumber === num)) {
    result = 'ğŸ¥‡ æ­å–œï¼æ‚¨ä¸­äº†é ­çï¼';
    prize = 'çé‡‘ 20è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'é ­ç';
  }
  // æª¢æŸ¥äºŒç (æœ«7ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(1) === num.slice(1))) {
    result = 'ğŸ¥ˆ æ­å–œï¼æ‚¨ä¸­äº†äºŒçï¼';
    prize = 'çé‡‘ 4è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'äºŒç';
  }
  // æª¢æŸ¥ä¸‰ç (æœ«6ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(2) === num.slice(2))) {
    result = 'ğŸ¥‰ æ­å–œï¼æ‚¨ä¸­äº†ä¸‰çï¼';
    prize = 'çé‡‘ 1è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ä¸‰ç';
  }
  // æª¢æŸ¥å››ç (æœ«5ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(3) === num.slice(3))) {
    result = 'ğŸ… æ­å–œï¼æ‚¨ä¸­äº†å››çï¼';
    prize = 'çé‡‘ 4åƒå…ƒ';
    isWinner = true;
    prizeLevel = 'å››ç';
  }
  // æª¢æŸ¥äº”ç (æœ«4ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(4) === num.slice(4))) {
    result = 'ğŸ–ï¸ æ­å–œï¼æ‚¨ä¸­äº†äº”çï¼';
    prize = 'çé‡‘ 1åƒå…ƒ';
    isWinner = true;
    prizeLevel = 'äº”ç';
  }
  // æª¢æŸ¥å…­ç (æœ«3ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(5) === num.slice(5)) ||
           (winningNumbers.additional && winningNumbers.additional.includes(inputNumber.slice(5)))) {
    result = 'ğŸ—ï¸ æ­å–œï¼æ‚¨ä¸­äº†å…­çï¼';
    prize = 'çé‡‘ 2ç™¾å…ƒ';
    isWinner = true;
    prizeLevel = 'å…­ç';
  }
  // æœªä¸­ç
  else {
    result = 'ğŸ˜” å¾ˆéºæ†¾ï¼Œé€™å¼µç™¼ç¥¨æ²’æœ‰ä¸­ç';
    prize = 'å†æ¥å†å²ï¼';
    prizeLevel = 'æœªä¸­ç';
  }

  // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
  addToHistory(inputNumber, isWinner, prizeLevel, prize);

  // é¡¯ç¤ºçµæœ
  const resultSection = document.getElementById('resultSection');
  const resultContent = document.getElementById('resultContent');
  
  resultContent.innerHTML = `
    <div class="text-center p-6 ${isWinner ? 'winner' : 'loser'} rounded-lg">
      <div class="text-2xl font-bold mb-2">${result}</div>
      <div class="text-lg font-mono font-bold mb-2">${inputNumber}</div>
      <div class="text-sm opacity-80">${prize}</div>
      ${winningNumbers.period ? `<div class="text-xs opacity-60 mt-2">æœŸåˆ¥ï¼š${winningNumbers.period}</div>` : ''}
    </div>
  `;
  
  resultSection.style.display = 'block';
  resultSection.scrollIntoView({ behavior: 'smooth' });
}

// æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
function addToHistory(number, isWinner, level, prize) {
  const historyItem = {
    number: number,
    isWinner: isWinner,
    level: level,
    prize: prize,
    date: new Date().toLocaleString('zh-TW')
  };
  
  history.unshift(historyItem);
  if (history.length > 20) {
    history = history.slice(0, 20); // åªä¿ç•™æœ€è¿‘20ç­†
  }
  
  localStorage.setItem('receiptHistory', JSON.stringify(history));
  updateHistoryDisplay();
}

// æ›´æ–°æ­·å²è¨˜éŒ„é¡¯ç¤º
function updateHistoryDisplay() {
  const historyList = document.getElementById('historyList');
  const historyCount = document.getElementById('historyCount');
  
  historyCount.textContent = `${history.length} ç­†è¨˜éŒ„`;
  
  if (history.length === 0) {
    historyList.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-2">ğŸ“</div>
        <div>é‚„æ²’æœ‰å°çè¨˜éŒ„</div>
        <div class="text-sm opacity-70 mt-1">é–‹å§‹å°çå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
      </div>
    `;
  } else {
    historyList.innerHTML = history.map(item => `
      <div class="history-item ${item.isWinner ? 'winner' : 'loser'}">
        <div class="flex justify-between items-center">
          <div>
            <div class="font-mono font-semibold">${item.number}</div>
            <div class="text-sm text-gray-600">${item.level} - ${item.prize}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">${item.date}</div>
            <div class="text-lg">${item.isWinner ? 'ğŸ‰' : 'ğŸ˜”'}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// æ¸…é™¤æ­·å²è¨˜éŒ„
function clearHistory() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°çæ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
    history = [];
    localStorage.removeItem('receiptHistory');
    updateHistoryDisplay();
  }
}

// è¼¸å…¥é™åˆ¶ï¼šåªå…è¨±æ•¸å­—
document.getElementById('receiptNumber').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// æŒ‰Enteréµå°ç
document.getElementById('receiptNumber').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkReceipt();
  }
});

// åˆ·æ–°é–‹çè™Ÿç¢¼
async function refreshWinningNumbers() {
  await fetchLatestWinningNumbers();
}

// å¾æœ¬åœ°å„²å­˜è¼‰å…¥é–‹çè™Ÿç¢¼
function loadWinningNumbersFromStorage() {
  const stored = localStorage.getItem('winningNumbers');
  if (stored) {
    try {
      const data = JSON.parse(stored);
      updateWinningNumbers(data);
    } catch (error) {
      console.error('è¼‰å…¥æœ¬åœ°é–‹çè™Ÿç¢¼å¤±æ•—:', error);
    }
  }
}

// æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é–‹çè™Ÿç¢¼
function shouldUpdateWinningNumbers() {
  const stored = localStorage.getItem('winningNumbers');
  if (!stored) return true;
  
  try {
    const data = JSON.parse(stored);
    const lastUpdate = new Date(data.updateTime);
    const now = new Date();
    const hoursDiff = (now - lastUpdate) / (1000 * 60 * 60);
    
    // æª¢æŸ¥ç¶²çµ¡ç‹€æ…‹
    if (navigator.onLine === false) {
      console.log('é›¢ç·šæ¨¡å¼ï¼Œä½¿ç”¨ç·©å­˜æ•¸æ“š');
      return false;
    }
    
    // å¦‚æœè¶…é30åˆ†é˜å°±æ›´æ–°ï¼ˆæ›´é »ç¹çš„æ›´æ–°ï¼‰
    return hoursDiff > 0.5;
  } catch (error) {
    return true;
  }
}

// ç¶²çµ¡ç‹€æ…‹ç›£è½
function setupNetworkMonitoring() {
  window.addEventListener('online', () => {
    console.log('ç¶²çµ¡å·²é€£æ¥ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é–‹çè™Ÿç¢¼');
    if (shouldUpdateWinningNumbers()) {
      fetchLatestWinningNumbers();
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('ç¶²çµ¡å·²æ–·é–‹ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼');
    showOfflineMessage();
  });
}

// é¡¯ç¤ºé›¢ç·šè¨Šæ¯
function showOfflineMessage() {
  const offlineIndicator = document.createElement('div');
  offlineIndicator.id = 'offlineIndicator';
  offlineIndicator.className = 'fixed top-4 left-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  offlineIndicator.innerHTML = 'ğŸ“± é›¢ç·šæ¨¡å¼ - ä½¿ç”¨ç·©å­˜æ•¸æ“š';
  document.body.appendChild(offlineIndicator);
  
  // 5ç§’å¾Œè‡ªå‹•éš±è—
  setTimeout(() => {
    const indicator = document.getElementById('offlineIndicator');
    if (indicator) indicator.remove();
  }, 5000);
}

// é é¢åˆå§‹åŒ–
async function initializePage() {
  try {
    // è¨­ç½®ç¶²çµ¡ç›£è½
    setupNetworkMonitoring();
    
    // è¼‰å…¥æœ¬åœ°å„²å­˜çš„é–‹çè™Ÿç¢¼
    loadWinningNumbersFromStorage();
    
    // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
    if (shouldUpdateWinningNumbers()) {
      await fetchLatestWinningNumbers();
    }

// åˆå§‹åŒ–æ­·å²è¨˜éŒ„é¡¯ç¤º
updateHistoryDisplay();
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    showSuccessMessage('ç™¼ç¥¨å°çç³»çµ±å·²æº–å‚™å°±ç·’');
    
  } catch (error) {
    console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
    showErrorMessage('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
  }
}

// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
function showSuccessMessage(message) {
  const successIndicator = document.createElement('div');
  successIndicator.className = 'fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  successIndicator.innerHTML = `âœ… ${message}`;
  document.body.appendChild(successIndicator);
  
  setTimeout(() => {
    successIndicator.remove();
  }, 3000);
}

// åˆå§‹åŒ–æ­·å²è¨˜éŒ„é¡¯ç¤º
updateHistoryDisplay();

// è¨»å†ŠService Workeræ”¯æŒé›¢ç·šåŠŸèƒ½
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializePage);

// æ·»åŠ é é¢å¯è¦‹æ€§ç›£è½ï¼Œç•¶é é¢é‡æ–°å¯è¦‹æ™‚æª¢æŸ¥æ›´æ–°
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && shouldUpdateWinningNumbers()) {
    fetchLatestWinningNumbers();
  }
});
</script>
</body>
</html>
