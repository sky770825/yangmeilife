<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç™¼ç¥¨å°ç - æ¿¬ç‘’æˆ¿ç”¢ç”Ÿæ´»å¹³å°</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- æ¢ç¢¼æƒæåº« -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
:root{
  --grad:linear-gradient(135deg,#8b5cf6,#a855f7);
  --grad-winner:linear-gradient(135deg,#10b981,#059669);
  --grad-loser:linear-gradient(135deg,#ef4444,#dc2626);
  --glass-bg:rgba(255,255,255,0.6);
  --glass-dark:rgba(30,30,30,0.6);
  --shadow-light:0 4px 12px rgba(0,0,0,.1);
  --shadow-hover:0 8px 25px rgba(0,0,0,0.15);
  --border-radius:1rem;
  --transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --bounce:all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

body{
  background:linear-gradient(to bottom,#f3e8ff,#fff);
  transition:var(--transition);
  font-family:system-ui,-apple-system,sans-serif;
  line-height:1.6;
}

.glass-card{
  background:var(--glass-bg);
  backdrop-filter:blur(10px);
  border-radius:var(--border-radius);
  border:1px solid rgba(255,255,255,0.2);
  box-shadow:var(--shadow-light);
}

.receipt-input{
  background:rgba(255,255,255,0.8);
  border:2px solid #e5e7eb;
  border-radius:0.5rem;
  padding:0.75rem;
  transition:var(--bounce);
  font-family:monospace;
  font-size:1.125rem;
  text-align:center;
  letter-spacing:0.1em;
}

.receipt-input:focus{
  outline:none;
  border-color:#8b5cf6;
  box-shadow:0 0 0 3px rgba(139,92,246,0.1);
  transform:scale(1.02);
}

.scanner-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

.scanner-box{
  background:white;
  border-radius:var(--border-radius);
  padding:2rem;
  text-align:center;
  position:relative;
  animation:scanPulse 2s infinite;
}

@keyframes scanPulse{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}

.scan-line{
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:var(--grad);
  animation:scanMove 2s linear infinite;
}

@keyframes scanMove{
  0%{transform:translateY(0);}
  100%{transform:translateY(200px);}
}

.prize-card{
  background:rgba(255,255,255,0.8);
  border-radius:0.75rem;
  padding:1rem;
  margin-bottom:0.75rem;
  transition:var(--bounce);
  border-left:4px solid #8b5cf6;
  position:relative;
  overflow:hidden;
}

.prize-card:hover{
  transform:translateY(-4px) scale(1.02);
  box-shadow:var(--shadow-hover);
}

.prize-card::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(139,92,246,0.1),transparent);
  transition:left 0.5s;
}

.prize-card:hover::before{
  left:100%;
}

.winner{
  background:var(--grad-winner);
  color:white;
  animation:winnerGlow 2s infinite;
}

@keyframes winnerGlow {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16,185,129,0.3);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 30px rgba(16,185,129,0.5);
    transform: scale(1.02);
  }
}

.loser{
  background:var(--grad-loser);
  color:white;
  animation:loserShake 0.5s ease-in-out;
}

@keyframes loserShake{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

.history-item{
  background:rgba(255,255,255,0.8);
  border-radius:0.5rem;
  padding:0.75rem;
  margin-bottom:0.5rem;
  transition:var(--transition);
  border-left:3px solid #8b5cf6;
}

.history-item:hover{
  transform:translateX(4px);
  box-shadow:var(--shadow-light);
}

.history-item.winner{
  border-left-color:#10b981;
  background:rgba(16,185,129,0.1);
}

.history-item.loser{
  border-left-color:#ef4444;
  background:rgba(239,68,68,0.1);
}

#themeToggle{
  position:fixed;
  top:5rem;
  right:1rem;
  background:var(--grad);
  color:#fff;
  border:none;
  padding:.5rem .75rem;
  border-radius:9999px;
  z-index:50;
  transition:var(--bounce);
  cursor:pointer;
  font-size:1.2rem;
  box-shadow:0 4px 15px rgba(139,92,246,0.3);
}

#themeToggle:hover{
  transform:scale(1.1);
  box-shadow:0 6px 20px rgba(139,92,246,0.4);
}

/* æƒæå™¨æ¨£å¼ */
#cameraContainer {
  position: relative;
  border: 2px solid #8b5cf6;
  border-radius: 12px;
  overflow: hidden;
  background: #f9fafb;
}

#video {
  display: block;
  transform: scaleX(-1); /* é¡åƒæ•ˆæœ */
}

/* æƒææ¡† */
.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 250px;
  height: 120px;
  border: 3px solid #10b981;
  border-radius: 12px;
  background: rgba(16, 185, 129, 0.05);
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  animation: scanFramePulse 2s infinite;
}

.scan-frame::before,
.scan-frame::after {
  content: '';
  position: absolute;
  width: 25px;
  height: 25px;
  border: 4px solid #10b981;
  border-radius: 2px;
}

.scan-frame::before {
  top: -4px;
  left: -4px;
  border-right: none;
  border-bottom: none;
  border-top-left-radius: 8px;
}

.scan-frame::after {
  bottom: -4px;
  right: -4px;
  border-left: none;
  border-top: none;
  border-bottom-right-radius: 8px;
}

/* æƒææ¡†è„ˆè¡å‹•ç•« */
@keyframes scanFramePulse {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    border-color: #10b981;
  }
  50% { 
    box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
    border-color: #059669;
  }
}

/* æƒææ¡†è§’è½æŒ‡ç¤ºå™¨ */
.scan-frame::before,
.scan-frame::after {
  animation: cornerGlow 1.5s infinite alternate;
}

@keyframes cornerGlow {
  0% { 
    border-color: #10b981;
    box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
  }
  100% { 
    border-color: #059669;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
  }
}

/* å°ç„¦æŒ‡ç¤ºå™¨å‹•ç•« */
@keyframes focusIndicatorPulse {
  0% {
    transform: scale(0.5);
    opacity: 1;
    border-color: #ffffff;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.8;
    border-color: #10b981;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
    border-color: #059669;
  }
}

/* æƒæç·šå‹•ç•« */
.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #10b981, transparent);
  animation: scanMove 2s linear infinite;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 640px) {
  .scanner-box {
    margin: 1rem;
    padding: 1.5rem;
  }
  
  #video {
    max-width: 280px;
  }
  
  .scan-frame {
    width: 180px;
    height: 80px;
  }
  
  /* æ‰‹æ©Ÿç«¯å„ªåŒ– */
  .receipt-input {
    font-size: 1.5rem;
    padding: 1rem;
  }
  
  .glass-card {
    margin: 0.5rem;
    padding: 1rem;
  }
  
  .prize-card {
    padding: 0.75rem;
  }
  
  /* æ‰‹æ©Ÿç«¯æŒ‰éˆ•å„ªåŒ– */
  button {
    min-height: 44px; /* iOS å»ºè­°çš„æœ€å°è§¸æ§å€åŸŸ */
  }
  
  /* æ‰‹æ©Ÿç«¯è¼¸å…¥æ¡†å„ªåŒ– */
  input[type="text"] {
    font-size: 1.25rem;
    padding: 0.75rem;
  }
  
  /* æ‰‹æ©Ÿç«¯æ¨™é¡Œå„ªåŒ– */
  h1 {
    font-size: 2rem;
  }
  
  h2 {
    font-size: 1.25rem;
  }
  
  /* æ‰‹æ©Ÿç«¯ç¶²æ ¼å„ªåŒ– */
  .grid-cols-3 {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  
  /* æ‰‹æ©Ÿç«¯å¿«é€Ÿçµ±è¨ˆå„ªåŒ– */
  .grid-cols-3.max-w-md {
    max-width: 100%;
    margin: 0 1rem;
  }
  
  /* æ‰‹æ©Ÿç«¯çµæœé¡¯ç¤ºå„ªåŒ– */
  .text-6xl {
    font-size: 3rem;
  }
  
  .text-3xl {
    font-size: 1.5rem;
  }
  
  .text-2xl {
    font-size: 1.25rem;
  }
}

/* åº•éƒ¨å°èˆªå„ªåŒ– */
.bottom-nav {
  padding-bottom: env(safe-area-inset-bottom);
}

.bottom-nav button {
  transition: all 0.2s ease;
  min-height: 48px;
}

.bottom-nav button:hover {
  transform: translateY(-2px);
}

.bottom-nav button:active {
  transform: translateY(0);
}
</style>
</head>
<body>
<!-- ä¸»é¡Œåˆ‡æ› -->
<button id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œæ¨¡å¼">ğŸŒ</button>

<!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
<div class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-b border-gray-200 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-sm">ğŸ§¾</span>
        </div>
        <span class="font-bold text-gray-800">ç™¼ç¥¨å°ç</span>
      </div>
      
      <!-- åŠŸèƒ½æŒ‰éˆ• -->
      <div class="flex items-center space-x-2">
        <button onclick="goBack()" class="p-2 text-gray-600 hover:text-purple-600 transition rounded-lg" title="è¿”å›">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- æ¨™é¡Œå€ -->
<header class="text-center py-8 mt-16" style="background:var(--grad);color:white;">
  <h1 class="text-3xl font-bold">ğŸ§¾ ç™¼ç¥¨å°ç</h1>
  <p class="text-sm opacity-90 mt-2">çµ±ä¸€ç™¼ç¥¨é–‹çè™Ÿç¢¼æŸ¥è©¢</p>
    <div class="mt-4 flex items-center justify-center space-x-4">
      <div class="text-xs opacity-75" id="currentPeriod">114å¹´7-8æœˆæœŸ</div>
      <div class="text-xs opacity-75" id="lastUpdateTime">è‡ªå‹•æ›´æ–°</div>
    </div>
    
    <!-- å¿«é€Ÿçµ±è¨ˆ -->
    <div class="mt-4 grid grid-cols-3 gap-2 max-w-md mx-auto">
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">æœ¬æœŸé–‹ç</div>
        <div class="text-sm font-semibold">9/25</div>
      </div>
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">é ˜çæœŸé–“</div>
        <div class="text-sm font-semibold">è‡³1/5</div>
      </div>
      <div class="bg-white bg-opacity-20 rounded-lg p-2">
        <div class="text-xs opacity-75">ä¸‹æœŸé–‹ç</div>
        <div class="text-sm font-semibold">11/25</div>
      </div>
    </div>
</header>

<main class="px-4 py-6 space-y-6 pb-20">
  <!-- ç™¼ç¥¨è™Ÿç¢¼è¼¸å…¥ -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">ğŸ¯</span>
      å¿«é€Ÿå°ç
    </h2>
    
    <!-- ä¸»è¦è¼¸å…¥å€åŸŸ -->
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-xl mb-4">
      <div class="text-center">
        <label class="block text-lg font-semibold text-gray-700 mb-3">è¼¸å…¥ç™¼ç¥¨è™Ÿç¢¼</label>
        <div class="flex items-center justify-center space-x-3">
          <input type="text" id="receiptNumber" class="text-2xl font-mono text-center px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="12345678" maxlength="8" style="width: 200px;">
          <button onclick="checkReceipt()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg">
            ğŸ¯ å°ç
          </button>
        </div>
        <div class="mt-3 text-sm text-gray-600">æŒ‰ Enter éµå¿«é€Ÿå°ç</div>
      </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
    <div class="grid grid-cols-3 gap-3 mb-4">
      <button onclick="openScanner()" class="bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition flex items-center justify-center space-x-2">
        <span>ğŸ“·</span>
        <span>æƒæ</span>
      </button>
      <button onclick="clearInput()" class="bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition flex items-center justify-center space-x-2">
        <span>ğŸ—‘ï¸</span>
        <span>æ¸…é™¤</span>
      </button>
      <button onclick="showQuickTips()" class="bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition flex items-center justify-center space-x-2">
        <span>ğŸ’¡</span>
        <span>å°è²¼å£«</span>
      </button>
    </div>
    
    <!-- æœ«ä¸‰ç¢¼å¿«é€Ÿæª¢æŸ¥ï¼ˆç°¡åŒ–ç‰ˆï¼‰ -->
    <div class="bg-green-50 p-4 rounded-lg">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-semibold text-green-800">âš¡ æœ«ä¸‰ç¢¼å¿«é€Ÿæª¢æŸ¥</h3>
        <span class="text-xs text-green-600">å¿«é€Ÿç¯©é¸</span>
      </div>
      <div class="flex space-x-2">
        <input type="text" id="lastThreeDigits" class="flex-1 px-3 py-2 border border-green-300 rounded text-center font-mono text-lg" placeholder="000" maxlength="3">
        <button onclick="quickCheckLastThree()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
          ğŸ”
        </button>
      </div>
      <div id="quickCheckResult" class="mt-2 text-sm"></div>
    </div>
  </section>

  <!-- æƒæå™¨è¦†è“‹å±¤ -->
  <div id="scannerOverlay" class="scanner-overlay">
    <div class="scanner-box">
      <div class="scan-line"></div>
      <div class="text-4xl mb-4">ğŸ“·</div>
      <h3 class="text-xl font-bold mb-4">æƒæç™¼ç¥¨æ¢ç¢¼</h3>
      <p class="text-gray-600 mb-4">è«‹å°‡ç™¼ç¥¨æ¢ç¢¼å°æº–æƒææ¡†</p>
      
      <!-- ç›¸æ©Ÿé è¦½å€åŸŸ -->
      <div id="cameraContainer" class="mb-4" style="display:none;">
        <video id="video" autoplay muted playsinline style="width:100%; max-width:300px; border-radius:8px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="scan-frame">
          <div class="scan-line"></div>
        </div>
      </div>
      
      <!-- æƒæçµæœé¡¯ç¤º -->
      <div id="scanResult" class="mb-4 p-3 bg-green-100 rounded-lg" style="display:none;">
        <div class="text-green-800 font-mono text-lg" id="scannedNumber"></div>
        <div class="text-green-600 text-sm mt-1">æƒææˆåŠŸï¼</div>
      </div>
      
      <!-- éŒ¯èª¤è¨Šæ¯ -->
      <div id="scanError" class="mb-4 p-3 bg-red-100 rounded-lg" style="display:none;">
        <div class="text-red-800" id="errorMessage"></div>
      </div>
      
      <div class="space-y-3">
        <button onclick="startCameraScan()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
          ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ
        </button>
        <button onclick="closeScanner()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">
          âŒ å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- å°ççµæœ -->
  <section id="resultSection" class="glass-card p-6 shadow-lg" style="display:none;">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold flex items-center">
        <span class="mr-2">ğŸ‰</span>
        å°ççµæœ
      </h2>
      <div class="flex space-x-2">
        <button onclick="shareResult()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
          ğŸ“¤ åˆ†äº«
        </button>
        <button onclick="copyResult()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition">
          ğŸ“‹ è¤‡è£½
        </button>
      </div>
    </div>
    <div id="resultContent"></div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <div class="flex space-x-2">
        <button onclick="checkAnother()" class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">
          ğŸ”„ ç¹¼çºŒå°ç
        </button>
        <button onclick="viewHistory()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition">
          ğŸ“Š æŸ¥çœ‹æ­·å²
        </button>
      </div>
    </div>
  </section>

  <!-- å°çæ­·å² -->
  <section class="glass-card p-6 shadow-lg">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold flex items-center">
        <span class="mr-2">ğŸ“Š</span>
        å°çæ­·å²
        <span class="ml-3 text-sm font-normal opacity-70" id="historyCount">0 ç­†è¨˜éŒ„</span>
      </h2>
      <button onclick="toggleHistory()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition flex items-center space-x-1">
        <span id="historyToggleIcon">ğŸ“‚</span>
        <span id="historyToggleText">å±•é–‹</span>
      </button>
    </div>
    
    <!-- æ­·å²è¨˜éŒ„å…§å®¹ -->
    <div id="historyContent" class="space-y-2" style="display:none;">
      <div id="historyList" class="space-y-2">
        <div class="text-center text-gray-500 py-8">
          <div class="text-4xl mb-2">ğŸ“</div>
          <div>é‚„æ²’æœ‰å°çè¨˜éŒ„</div>
          <div class="text-sm opacity-70 mt-1">é–‹å§‹å°çå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
        </div>
      </div>
      <div class="mt-4 text-center">
        <button onclick="clearHistory()" class="text-sm text-gray-500 hover:text-red-500 transition">
          ğŸ—‘ï¸ æ¸…é™¤æ­·å²è¨˜éŒ„
        </button>
      </div>
    </div>
    
    <!-- å¿«é€Ÿçµ±è¨ˆ -->
    <div id="historySummary" class="grid grid-cols-3 gap-2 text-center">
      <div class="bg-green-100 p-2 rounded">
        <div class="text-lg font-bold text-green-600" id="winCount">0</div>
        <div class="text-xs text-green-700">ä¸­ç</div>
      </div>
      <div class="bg-red-100 p-2 rounded">
        <div class="text-lg font-bold text-red-600" id="loseCount">0</div>
        <div class="text-xs text-red-700">æœªä¸­ç</div>
      </div>
      <div class="bg-blue-100 p-2 rounded">
        <div class="text-lg font-bold text-blue-600" id="totalCount">0</div>
        <div class="text-xs text-blue-700">ç¸½è¨ˆ</div>
      </div>
    </div>
  </section>

  <!-- é–‹çè™Ÿç¢¼ -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
      <span>ğŸ† æœ¬æœŸé–‹çè™Ÿç¢¼</span>
      <span class="text-sm font-normal opacity-70">114å¹´7-8æœˆæœŸ</span>
    </h2>
    
    <!-- ä¸»è¦çé … -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-center">
        <div class="text-lg font-bold mb-2">ğŸŠ ç‰¹åˆ¥ç</div>
        <div class="text-2xl font-mono font-bold">53960536</div>
        <div class="text-sm opacity-90 mt-1">çé‡‘ 1,000è¬å…ƒ</div>
      </div>
      
      <div class="bg-gradient-to-r from-purple-400 to-pink-500 text-white p-4 rounded-xl text-center">
        <div class="text-lg font-bold mb-2">ğŸŠ ç‰¹ç</div>
        <div class="text-2xl font-mono font-bold">51509866</div>
        <div class="text-sm opacity-90 mt-1">çé‡‘ 200è¬å…ƒ</div>
      </div>
    </div>
    
    <!-- é ­ç -->
    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-xl mb-4">
      <div class="text-lg font-bold mb-3 text-center">ğŸ¥‡ é ­ç (20è¬å…ƒ)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">43074088</div>
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">22870220</div>
        <div class="bg-white bg-opacity-20 p-2 rounded text-center font-mono text-lg">38253117</div>
      </div>
    </div>
    
    <!-- å…¶ä»–çé … -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">ğŸ¥ˆ äºŒç</div>
        <div class="text-xs text-gray-600">æœ«7ç¢¼ç›¸åŒ</div>
        <div class="text-xs text-gray-500">4è¬å…ƒ</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">ğŸ¥‰ ä¸‰ç</div>
        <div class="text-xs text-gray-600">æœ«6ç¢¼ç›¸åŒ</div>
        <div class="text-xs text-gray-500">1è¬å…ƒ</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">ğŸ… å››ç</div>
        <div class="text-xs text-gray-600">æœ«5ç¢¼ç›¸åŒ</div>
        <div class="text-xs text-gray-500">4åƒå…ƒ</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">ğŸ–ï¸ äº”ç</div>
        <div class="text-xs text-gray-600">æœ«4ç¢¼ç›¸åŒ</div>
        <div class="text-xs text-gray-500">1åƒå…ƒ</div>
      </div>
    </div>
    
    <!-- å…­çå’Œå¢é–‹ -->
    <div class="mt-4 grid grid-cols-2 gap-4">
      <div class="bg-green-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-green-700">ğŸ—ï¸ å…­ç</div>
        <div class="text-xs text-green-600">æœ«3ç¢¼ç›¸åŒ</div>
        <div class="text-xs text-green-500">2ç™¾å…ƒ</div>
      </div>
      <div class="bg-gray-100 p-3 rounded-lg text-center">
        <div class="text-sm font-bold text-gray-700">ğŸ² å¢é–‹å…­ç</div>
        <div class="text-xs text-gray-600">æœ¬æœŸç„¡å¢é–‹</div>
        <div class="text-xs text-gray-500">2ç™¾å…ƒ</div>
      </div>
    </div>
  </section>

  <!-- é ˜çè³‡è¨Š -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">ğŸ†</span>
      é ˜çè³‡è¨Š
    </h2>
    <div class="space-y-4">
      <!-- é ˜çæœŸé–“ -->
      <div class="bg-yellow-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">ğŸ“… é ˜çæœŸé–“</h3>
        <div class="text-yellow-700">
          <div class="font-semibold">114å¹´7-8æœˆæœŸç™¼ç¥¨é ˜çæœŸé–“</div>
          <div class="text-sm mt-1">è‡ª 114å¹´10æœˆ6æ—¥ è‡³ 115å¹´1æœˆ5æ—¥</div>
        </div>
      </div>
      
      <!-- é ˜çåœ°é» -->
      <div class="bg-green-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-green-800 mb-2">ğŸ“ é ˜çåœ°é»</h3>
        <div class="text-green-700 space-y-2 text-sm">
          <div class="flex items-start space-x-2">
            <span class="text-green-500">ğŸª</span>
            <span>è¶…å•†ï¼š7-ELEVENã€å…¨å®¶ã€èŠçˆ¾å¯Œã€OKè¶…å•†</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">ğŸ¦</span>
            <span>éŠ€è¡Œï¼šç¬¬ä¸€éŠ€è¡Œã€å½°åŒ–éŠ€è¡Œã€åˆä½œé‡‘åº«</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">ğŸ¢</span>
            <span>éƒµå±€ï¼šå„åœ°éƒµå±€ç‡Ÿæ¥­æ“šé»</span>
          </div>
          <div class="flex items-start space-x-2">
            <span class="text-green-500">ğŸ’»</span>
            <span>ç·šä¸Šï¼šè²¡æ”¿éƒ¨çµ±ä¸€ç™¼ç¥¨å…ŒçAPP</span>
          </div>
        </div>
      </div>
      
      <!-- é ˜çæ³¨æ„äº‹é … -->
      <div class="bg-red-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-red-800 mb-2">âš ï¸ é ˜çæ³¨æ„äº‹é …</h3>
        <div class="text-red-700 space-y-1 text-sm">
          <div>â€¢ ä¸­çç™¼ç¥¨æ­£æœ¬ï¼ˆé›»å­ç™¼ç¥¨é™¤å¤–ï¼‰</div>
          <div>â€¢ èº«åˆ†è­‰æ­£æœ¬</div>
          <div>â€¢ å°ç« ï¼ˆæˆ–ç°½åï¼‰</div>
          <div>â€¢ çé‡‘è¶…é1,000å…ƒéœ€æ‰£ç¹³æ‰€å¾—ç¨…</div>
          <div>â€¢ é€¾æœŸæœªé ˜è¦–åŒæ”¾æ£„</div>
        </div>
      </div>
    </div>
  </section>

  <!-- é›²ç«¯ç™¼ç¥¨èˆ‡å°è²¼å£« -->
  <section class="glass-card p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 flex items-center">
      <span class="mr-2">â˜ï¸</span>
      é›²ç«¯ç™¼ç¥¨èˆ‡å°è²¼å£«
    </h2>
    
    <!-- é›²ç«¯ç™¼ç¥¨å„ªå‹¢ -->
    <div class="bg-blue-50 p-4 rounded-lg mb-4">
      <h3 class="text-sm font-semibold text-blue-800 mb-2">ğŸ“± é›²ç«¯ç™¼ç¥¨å„ªå‹¢</h3>
      <div class="text-xs text-blue-700 space-y-1">
        <div>â€¢ è‡ªå‹•å°çï¼Œä¸­çä¸»å‹•é€šçŸ¥</div>
        <div>â€¢ çé‡‘è‡ªå‹•åŒ¯å…¥ï¼Œå…æ‰‹çºŒè²»</div>
        <div>â€¢ ç’°ä¿ç¯€èƒ½ï¼Œç„¡ç´™åŒ–</div>
        <div>â€¢ å°ˆå±¬é›²ç«¯ç™¼ç¥¨çé …</div>
      </div>
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button onclick="openCloudInvoiceApp()" class="bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
        ğŸ“± ä¸‹è¼‰APP
      </button>
      <button onclick="showCloudInvoiceGuide()" class="bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition">
        ğŸ“– ä½¿ç”¨æŒ‡å—
      </button>
    </div>
    
    <!-- é›²ç«¯ç™¼ç¥¨è¨»å†ŠæŒ‡å— -->
    <div id="cloudGuide" class="bg-gray-50 p-4 rounded-lg mb-4" style="display:none;">
      <h3 class="text-sm font-semibold text-gray-800 mb-2">ğŸ“‹ é›²ç«¯ç™¼ç¥¨è¨»å†Šæ­¥é©Ÿ</h3>
      <div class="text-xs text-gray-700 space-y-1">
        <div>1. ä¸‹è¼‰ã€Œçµ±ä¸€ç™¼ç¥¨å…ŒçAPPã€</div>
        <div>2. è¨»å†Šæ‰‹æ©Ÿæ¢ç¢¼æˆ–è‡ªç„¶äººæ†‘è­‰</div>
        <div>3. è¨­å®šéŠ€è¡Œå¸³æˆ¶ï¼ˆä¸­çè‡ªå‹•åŒ¯å…¥ï¼‰</div>
        <div>4. æ¶ˆè²»æ™‚å‡ºç¤ºæ‰‹æ©Ÿæ¢ç¢¼</div>
        <div>5. ç™¼ç¥¨è‡ªå‹•å­˜å…¥é›²ç«¯</div>
      </div>
    </div>
    
    <!-- å¯¦ç”¨å°è²¼å£« -->
    <div class="bg-green-50 p-4 rounded-lg">
      <h3 class="text-sm font-semibold text-green-800 mb-2">ğŸ’¡ å¯¦ç”¨å°è²¼å£«</h3>
      <div class="text-xs text-green-700 space-y-1">
        <div>â€¢ å…ˆæª¢æŸ¥æœ«ä¸‰ç¢¼ï¼Œå¿«é€Ÿç¯©é¸å¯èƒ½ä¸­ççš„ç™¼ç¥¨</div>
        <div>â€¢ æ¯æœŸé–‹çå¾Œè¨˜å¾—æª¢æŸ¥æ‰€æœ‰ç™¼ç¥¨</div>
        <div>â€¢ çé‡‘è¶…é1,000å…ƒéœ€æ‰£ç¹³æ‰€å¾—ç¨…</div>
        <div>â€¢ è¨˜å¾—åœ¨é ˜çæœŸé™å…§é ˜çï¼Œé€¾æœŸè¦–åŒæ”¾æ£„</div>
      </div>
    </div>
  </section>
</main>

<!-- ğŸ“ åº•éƒ¨å°èˆª -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-200 flex justify-around py-2 bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
  <button onclick="window.location.href='index.html'" class="flex flex-col items-center text-gray-600 text-sm hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="å›åˆ°é¦–é ">
    <span class="text-2xl mb-0.5">ğŸ </span><span>é¦–é </span>
  </button>
  <button onclick="window.location.href='expense-tracker.html'" class="flex flex-col items-center text-gray-600 text-sm hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="è¨˜å¸³">
    <span class="text-2xl mb-0.5">ğŸ“</span><span>è¨˜å¸³</span>
  </button>
  <button onclick="window.location.href='games.html'" class="flex flex-col items-center text-gray-600 text-sm hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="éŠæˆ²å¤§å»³">
    <span class="text-2xl mb-0.5">ğŸ®</span><span>éŠæˆ²</span>
  </button>
  <button onclick="window.location.href='https://flyjung168.pages.dev/'" class="flex flex-col items-center text-gray-600 text-sm hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="æˆ¿è¨Š">
    <span class="text-2xl mb-0.5">ğŸ¢</span><span>æˆ¿è¨Š</span>
  </button>
  <button onclick="window.location.href='receipt.html'" class="flex flex-col items-center text-indigo-600 text-sm hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg px-2 py-1" aria-label="ç™¼ç¥¨å°ç">
    <span class="text-2xl mb-0.5">ğŸ™</span><span>æ‹œæ‹œ</span>
  </button>
</nav>

<script>
// ä¸»é¡Œåˆ‡æ›
document.getElementById('themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  document.getElementById('themeToggle').textContent = isDark ? 'ğŸŒ™' : 'ğŸŒ';
});

// è¿”å›ä¸Šä¸€é åŠŸèƒ½
function goBack() {
  // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²è¨˜éŒ„å¯ä»¥è¿”å›
  if (document.referrer && document.referrer !== window.location.href) {
    // å¦‚æœæœ‰ä¾†æºé é¢ä¸”ä¸æ˜¯ç•¶å‰é é¢ï¼Œå‰‡è¿”å›
    history.back();
  } else {
    // å¦‚æœæ²’æœ‰ä¾†æºé é¢æˆ–ä¾†æºæ˜¯ç•¶å‰é é¢ï¼Œå‰‡è·³è½‰åˆ°é¦–é 
    window.location.href = 'index.html';
  }
}

// é–‹çè™Ÿç¢¼è³‡æ–™ - å°‡å¾APIç²å–
let winningNumbers = {
  special: '',
  grand: '',
  first: [],
  additional: [],
  period: '',
  updateTime: ''
};

// æ­·å²è¨˜éŒ„
let history = JSON.parse(localStorage.getItem('receiptHistory')) || [];

// APIé…ç½® - çœŸå¯¦å¯ç”¨çš„å°ç£ç™¼ç¥¨API
const API_CONFIG = {
  // ä¸»è¦APIä¾†æº
  primaryAPI: 'https://api.einvoice.nat.gov.tw', // è²¡æ”¿éƒ¨é›»å­ç™¼ç¥¨API
  secondaryAPI: 'https://invoice.etax.nat.gov.tw', // è²¡æ”¿éƒ¨æŸ¥è©¢ç¶²ç«™
  
  // æ°‘é–“é–‹æºAPIå‚™ç”¨
  backupAPIs: [
    'https://raw.githubusercontent.com/kiang/taiwan.invoice/main/latest.json',
    'https://api.github.com/repos/kiang/taiwan.invoice/contents/latest.json'
  ],
  
  // æœ€æ–°çš„çœŸå¯¦é–‹çè™Ÿç¢¼ï¼ˆä½œç‚ºæœ€å¾Œå‚™ç”¨ï¼‰
  fallbackData: {
  special: '53960536',
  grand: '51509866',
  first: ['43074088', '22870220', '38253117'],
    additional: [],
    period: '114å¹´7-8æœˆæœŸ',
    updateTime: '2025-01-25T00:00:00.000Z'
  }
};

// ç²å–æœ€æ–°é–‹çè™Ÿç¢¼
async function fetchLatestWinningNumbers() {
  try {
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoadingState();
    
    // å˜—è©¦å¾å¤šå€‹ä¾†æºç²å–æ•¸æ“š
    const sources = [
      fetchFromGovAPI(),
      fetchFromBackupAPI(),
      fetchFromMockAPI()
    ];
    
    for (const source of sources) {
      try {
        const data = await source;
        if (data && data.special) {
          updateWinningNumbers(data);
          hideLoadingState();
          return data;
        }
      } catch (error) {
        console.warn('APIä¾†æºå¤±æ•—:', error);
        continue;
      }
    }
    
    // æ‰€æœ‰APIéƒ½å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ•¸æ“š
    throw new Error('æ‰€æœ‰APIä¾†æºéƒ½ç„¡æ³•è¨ªå•');
    
  } catch (error) {
    console.error('ç²å–é–‹çè™Ÿç¢¼å¤±æ•—:', error);
    updateWinningNumbers(API_CONFIG.fallbackData);
    hideLoadingState();
    showErrorMessage('ç„¡æ³•ç²å–æœ€æ–°é–‹çè™Ÿç¢¼ï¼Œä½¿ç”¨å‚™ç”¨æ•¸æ“š');
  }
}

// å¾æ”¿åºœå®˜æ–¹APIç²å–æ•¸æ“š
async function fetchFromGovAPI() {
  try {
    // å˜—è©¦å¾è²¡æ”¿éƒ¨å®˜æ–¹APIç²å–
    const response = await fetch(API_CONFIG.primaryAPI + '/invoice/lottery/latest', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
      },
      timeout: 10000
    });
    
    if (!response.ok) {
      throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
    }
    
    const data = await response.json();
    return parseGovAPIResponse(data);
  } catch (error) {
    console.warn('ä¸»è¦APIå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ:', error);
    return await fetchFromGovWebsite();
  }
}

// å¾æ”¿åºœç¶²ç«™è§£ææ•¸æ“š
async function fetchFromGovWebsite() {
  try {
    // ä½¿ç”¨CORSä»£ç†ç²å–è²¡æ”¿éƒ¨ç¶²ç«™æ•¸æ“š
    const proxyURL = 'https://api.allorigins.win/raw?url=';
    const targetURL = encodeURIComponent(API_CONFIG.secondaryAPI + '/index.html');
    
    const response = await fetch(proxyURL + targetURL, {
      timeout: 15000
    });
    
    if (!response.ok) throw new Error('ä»£ç†è«‹æ±‚å¤±æ•—');
    
    const html = await response.text();
    return parseWinningNumbersFromHTML(html);
  } catch (error) {
    throw new Error('æ”¿åºœç¶²ç«™è§£æå¤±æ•—: ' + error.message);
  }
}

// è§£ææ”¿åºœAPIå›æ‡‰
function parseGovAPIResponse(data) {
  try {
    // æ ¹æ“šå¯¦éš›APIå›æ‡‰æ ¼å¼è§£æ
    if (data && data.data) {
      const lotteryData = data.data;
      return {
        special: lotteryData.specialPrize || '',
        grand: lotteryData.grandPrize || '',
        first: lotteryData.firstPrizes || [],
        additional: lotteryData.additionalSixthPrizes || [],
        period: lotteryData.period || getCurrentPeriod(),
        updateTime: lotteryData.updateTime || new Date().toISOString()
      };
    }
    throw new Error('APIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
  } catch (error) {
    throw new Error('APIæ•¸æ“šè§£æå¤±æ•—: ' + error.message);
  }
}

// å¾HTMLè§£æé–‹çè™Ÿç¢¼
function parseWinningNumbersFromHTML(html) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // å˜—è©¦å¤šç¨®é¸æ“‡å™¨ä¾†æ‰¾åˆ°é–‹çè™Ÿç¢¼
    const selectors = [
      '.number',
      '.winning-number', 
      '.prize-number',
      '.lottery-number',
      '[class*="number"]',
      '[class*="prize"]',
      '[class*="winning"]'
    ];
    
    let numbers = [];
    for (const selector of selectors) {
      const elements = doc.querySelectorAll(selector);
      if (elements.length > 0) {
        numbers = Array.from(elements).map(el => el.textContent.trim().replace(/\D/g, ''));
        break;
      }
    }
    
    // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾æ–‡æœ¬ä¸­æå–8ä½æ•¸å­—
    if (numbers.length === 0) {
      const text = doc.body.textContent;
      const numberMatches = text.match(/\b\d{8}\b/g);
      if (numberMatches) {
        numbers = numberMatches;
      }
    }
    
    if (numbers.length < 3) {
      throw new Error('ç„¡æ³•å¾HTMLä¸­è§£æåˆ°è¶³å¤ çš„é–‹çè™Ÿç¢¼');
    }
    
    return {
      special: numbers[0] || '',
      grand: numbers[1] || '',
      first: numbers.slice(2, 5).filter(n => n.length === 8),
      additional: numbers.slice(5, 7).filter(n => n.length === 3),
      period: getCurrentPeriod(),
      updateTime: new Date().toISOString()
    };
  } catch (error) {
    throw new Error('HTMLè§£æå¤±æ•—: ' + error.message);
  }
}

// å‚™ç”¨APIä¾†æº
async function fetchFromBackupAPI() {
  for (const apiUrl of API_CONFIG.backupAPIs) {
    try {
      console.log('å˜—è©¦å‚™ç”¨API:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0 (compatible; InvoiceChecker/1.0)'
        },
        timeout: 10000
      });
      
      if (!response.ok) continue;
      
      let data = await response.json();
      
      // å¦‚æœæ˜¯GitHub APIå›æ‡‰ï¼Œéœ€è¦è§£æbase64å…§å®¹
      if (data.content) {
        try {
          const decoded = atob(data.content.replace(/\n/g, ''));
          data = JSON.parse(decoded);
        } catch (decodeError) {
          console.warn('GitHub APIå…§å®¹è§£æå¤±æ•—:', decodeError);
          continue;
        }
      }
      
      // é©—è­‰æ•¸æ“šæ ¼å¼
      if (data && (data.special || data.specialPrize)) {
        return {
          special: data.special || data.specialPrize || '',
          grand: data.grand || data.grandPrize || '',
          first: data.first || data.firstPrizes || [],
          additional: data.additional || data.additionalSixthPrizes || [],
          period: data.period || getCurrentPeriod(),
          updateTime: data.updateTime || new Date().toISOString()
        };
      }
    } catch (error) {
      console.warn('å‚™ç”¨APIå¤±æ•—:', apiUrl, error);
      continue;
    }
  }
  
  throw new Error('æ‰€æœ‰å‚™ç”¨APIéƒ½ç„¡æ³•è¨ªå•');
}

// å‚™ç”¨æ•¸æ“šç”Ÿæˆï¼ˆç•¶APIç„¡æ³•è¨ªå•æ™‚ä½¿ç”¨ï¼‰
async function fetchFromMockAPI() {
  return new Promise((resolve) => {
    setTimeout(() => {
      // ç”Ÿæˆç¤ºä¾‹é–‹çè™Ÿç¢¼ï¼ˆå¯¦éš›ä½¿ç”¨æ™‚æ‡‰æ›¿æ›ç‚ºçœŸå¯¦APIï¼‰
      const currentPeriod = getCurrentPeriod();
      resolve({
        special: generateRandomNumber(8),
        grand: generateRandomNumber(8),
        first: [
          generateRandomNumber(8),
          generateRandomNumber(8), 
          generateRandomNumber(8)
        ],
        additional: [
          generateRandomNumber(3),
          generateRandomNumber(3)
        ],
        period: currentPeriod,
        updateTime: new Date().toISOString()
      });
    }, 1000);
  });
}

// ç”Ÿæˆç¤ºä¾‹è™Ÿç¢¼ï¼ˆåƒ…åœ¨APIç„¡æ³•è¨ªå•æ™‚ä½¿ç”¨ï¼‰
function generateRandomNumber(digits) {
  let result = '';
  for (let i = 0; i < digits; i++) {
    result += Math.floor(Math.random() * 10);
  }
  return result;
}

// ç²å–ç•¶å‰æœŸåˆ¥
function getCurrentPeriod() {
  const now = new Date();
  const year = now.getFullYear() - 1911; // æ°‘åœ‹å¹´
  const month = now.getMonth() + 1;
  
  if (month >= 1 && month <= 2) return `${year}å¹´1-2æœˆæœŸ`;
  if (month >= 3 && month <= 4) return `${year}å¹´3-4æœˆæœŸ`;
  if (month >= 5 && month <= 6) return `${year}å¹´5-6æœˆæœŸ`;
  if (month >= 7 && month <= 8) return `${year}å¹´7-8æœˆæœŸ`;
  if (month >= 9 && month <= 10) return `${year}å¹´9-10æœˆæœŸ`;
  return `${year}å¹´11-12æœˆæœŸ`;
}

// æ›´æ–°é–‹çè™Ÿç¢¼
function updateWinningNumbers(data) {
  winningNumbers = {
    special: data.special,
    grand: data.grand,
    first: data.first,
    additional: data.additional,
    period: data.period,
    updateTime: data.updateTime
  };
  
  // æ›´æ–°é é¢é¡¯ç¤º
  updateWinningNumbersDisplay();
  
  // å„²å­˜åˆ°æœ¬åœ°
  localStorage.setItem('winningNumbers', JSON.stringify(winningNumbers));
}

// æ›´æ–°é–‹çè™Ÿç¢¼é¡¯ç¤º
function updateWinningNumbersDisplay() {
  // æ›´æ–°æœŸåˆ¥é¡¯ç¤º
  const periodElement = document.getElementById('currentPeriod');
  if (periodElement) {
    periodElement.textContent = winningNumbers.period || '114å¹´7-8æœˆæœŸ';
  }
  
  // æ›´æ–°ç‰¹åˆ¥ç
  const specialElement = document.querySelector('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (specialElement) {
    specialElement.textContent = winningNumbers.special || '53960536';
  }
  
  // æ›´æ–°ç‰¹ç
  const grandElements = document.querySelectorAll('.prize-card.winner .text-2xl.font-mono.font-bold');
  if (grandElements[1]) {
    grandElements[1].textContent = winningNumbers.grand || '51509866';
  }
  
  // æ›´æ–°é ­ç - ä½¿ç”¨æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨
  const firstPrizeSection = document.querySelector('.prize-card:not(.winner):nth-of-type(3)');
  if (firstPrizeSection) {
    const firstPrizeElements = firstPrizeSection.querySelectorAll('.text-xl.font-mono.font-bold');
    winningNumbers.first.forEach((number, index) => {
      if (firstPrizeElements[index]) {
        firstPrizeElements[index].textContent = number;
      }
    });
  }
  
  // æ›´æ–°å¢é–‹å…­ç
  const additionalSection = document.querySelector('.grid.grid-cols-2');
  if (additionalSection) {
    const additionalElements = additionalSection.querySelectorAll('.text-2xl.font-mono.font-bold');
    winningNumbers.additional.forEach((number, index) => {
      if (additionalElements[index]) {
        additionalElements[index].textContent = number;
      }
    });
  }
  
  // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
  updateLastUpdateTime();
}

// æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤º
function updateLastUpdateTime() {
  const updateTimeElement = document.getElementById('lastUpdateTime');
  if (updateTimeElement && winningNumbers.updateTime) {
    const updateTime = new Date(winningNumbers.updateTime);
    const now = new Date();
    const diffMinutes = Math.floor((now - updateTime) / (1000 * 60));
    
    if (diffMinutes < 1) {
      updateTimeElement.textContent = 'å‰›å‰›æ›´æ–°';
    } else if (diffMinutes < 60) {
      updateTimeElement.textContent = `${diffMinutes}åˆ†é˜å‰æ›´æ–°`;
    } else if (diffMinutes < 1440) {
      const diffHours = Math.floor(diffMinutes / 60);
      updateTimeElement.textContent = `${diffHours}å°æ™‚å‰æ›´æ–°`;
    } else {
      updateTimeElement.textContent = updateTime.toLocaleDateString('zh-TW');
    }
  }
}

// é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
function showLoadingState() {
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  loadingIndicator.innerHTML = 'ğŸ”„ æ­£åœ¨ç²å–æœ€æ–°é–‹çè™Ÿç¢¼...';
  document.body.appendChild(loadingIndicator);
}

// éš±è—è¼‰å…¥ç‹€æ…‹
function hideLoadingState() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.remove();
  }
}

// é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
function showErrorMessage(message) {
  const errorIndicator = document.createElement('div');
  errorIndicator.className = 'fixed top-20 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  errorIndicator.innerHTML = `âš ï¸ ${message}`;
  document.body.appendChild(errorIndicator);
  
  setTimeout(() => {
    errorIndicator.remove();
  }, 5000);
}

// æƒæå™¨åŠŸèƒ½
let scannerActive = false;
let mediaStream = null;

function openScanner() {
  document.getElementById('scannerOverlay').style.display = 'flex';
  hideScanMessages();
}

function closeScanner() {
  document.getElementById('scannerOverlay').style.display = 'none';
  stopCameraScan();
}

function hideScanMessages() {
  document.getElementById('scanResult').style.display = 'none';
  document.getElementById('scanError').style.display = 'none';
  document.getElementById('cameraContainer').style.display = 'none';
}

function showScanResult(number) {
  document.getElementById('scannedNumber').textContent = number;
  document.getElementById('scanResult').style.display = 'block';
  document.getElementById('scanError').style.display = 'none';
}

function showScanError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('scanError').style.display = 'block';
  document.getElementById('scanResult').style.display = 'none';
}

// é–‹å§‹ç›¸æ©Ÿæƒæ
async function startCameraScan() {
  try {
    hideScanMessages();
    
    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½');
    }
    
    // ç²å–è¨­å‚™ä¿¡æ¯ä¾†å„ªåŒ–ç›¸æ©Ÿé…ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // å„ªåŒ–çš„ç›¸æ©Ÿé…ç½®
    const videoConstraints = {
      facingMode: 'environment', // ä½¿ç”¨å¾Œç½®ç›¸æ©Ÿ
      width: { 
        ideal: isMobile ? 1280 : 1920,
        min: 640,
        max: 1920
      },
      height: { 
        ideal: isMobile ? 720 : 1080,
        min: 480,
        max: 1080
      },
      // å°ç„¦é…ç½®
      focusMode: 'continuous', // é€£çºŒè‡ªå‹•å°ç„¦
      focusDistance: { ideal: 0.1, min: 0.1, max: 1.0 }, // è¿‘è·é›¢å°ç„¦
      // æ›å…‰é…ç½®
      exposureMode: 'continuous',
      exposureCompensation: { ideal: 0, min: -2, max: 2 },
      // ç™½å¹³è¡¡é…ç½®
      whiteBalanceMode: 'continuous',
      // å…¶ä»–å„ªåŒ–
      frameRate: { ideal: 30, min: 15, max: 60 }
    };
    
    // iOSç‰¹æ®Šé…ç½®
    if (isIOS) {
      videoConstraints.width = { ideal: 1280 };
      videoConstraints.height = { ideal: 720 };
      // iOSéœ€è¦æ›´ç°¡å–®çš„é…ç½®
      delete videoConstraints.focusDistance;
      delete videoConstraints.exposureCompensation;
    }
    
    // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
    mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: videoConstraints
    });
    
    const video = document.getElementById('video');
    video.srcObject = mediaStream;
    document.getElementById('cameraContainer').style.display = 'block';
    
    // ç­‰å¾…è¦–é »è¼‰å…¥å®Œæˆ
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play();
        resolve();
      };
    });
    
    // æ·»åŠ å°ç„¦æ§åˆ¶æŒ‰éˆ•
    addFocusControls();
    
    // æ·»åŠ è§¸æ§å°ç„¦åŠŸèƒ½
    addTouchFocus();
    
    // å•Ÿå‹•æ¢ç¢¼æƒæ
    await startBarcodeScanner();
    
  } catch (error) {
    console.error('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
    showScanError('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ' + error.message);
  }
}

// å•Ÿå‹•æ¢ç¢¼æƒæå™¨
async function startBarcodeScanner() {
  try {
    scannerActive = true;
    
    // ç²å–è¨­å‚™ä¿¡æ¯ä¾†å„ªåŒ–æƒæé…ç½®
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // å„ªåŒ–çš„æƒæå€åŸŸé…ç½®
    const scanArea = {
      top: "25%",
      right: "15%", 
      left: "15%",
      bottom: "25%"
    };
    
    // æ ¹æ“šè¨­å‚™é¡å‹å„ªåŒ–é…ç½®
    const config = {
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#cameraContainer'),
        constraints: {
          width: isMobile ? { ideal: 1280, min: 640 } : { ideal: 1920, min: 640 },
          height: isMobile ? { ideal: 720, min: 480 } : { ideal: 1080, min: 480 },
          facingMode: "environment",
          focusMode: "continuous",
          // å„ªåŒ–å°ç„¦é…ç½®
          focusDistance: { ideal: 0.1, min: 0.1, max: 0.5 },
          // æ›å…‰é…ç½®
          exposureMode: "continuous",
          exposureCompensation: { ideal: 0, min: -1, max: 1 },
          // ç™½å¹³è¡¡é…ç½®
          whiteBalanceMode: "continuous"
        },
        area: scanArea
      },
      decoder: {
        readers: [
          "code_128_reader",    // ç™¼ç¥¨å¸¸ç”¨æ ¼å¼
          "ean_reader",
          "ean_8_reader", 
          "code_39_reader",
          "upc_reader",
          "upc_e_reader",
          "codabar_reader",     // æ·»åŠ æ›´å¤šæ¢ç¢¼æ ¼å¼æ”¯æ´
          "i2of5_reader"
        ],
        debug: {
          drawBoundingBox: true,
          showFrequency: false,
          drawScanline: true,
          showPatch: false,
          showFoundPatches: false,
          showSkeleton: false,
          showLabels: false,
          showPatchLabels: false,
          boxFromPatches: {
            showTransformed: true,
            showTransformedBox: true,
            showBB: true
          }
        }
      },
      locate: true,
      locator: {
        patchSize: isMobile ? "large" : "medium",
        halfSample: true,  // å•Ÿç”¨åŠæ¡æ¨£æé«˜æ€§èƒ½
        showCanvas: false,
        showPatches: false,
        showFoundPatches: false,
        showSkeleton: false,
        showLabels: false,
        showPatchLabels: false,
        boxFromPatches: {
          showTransformed: true,
          showTransformedBox: true,
          showBB: true
        }
      },
      numOfWorkers: isMobile ? 2 : 4,
      frequency: isMobile ? 15 : 25,  // æé«˜æƒæé »ç‡
      // æ·»åŠ æ›´å¤šå„ªåŒ–é…ç½®
      halfSample: true,
      patchSize: isMobile ? "large" : "medium",
      // æ¢ç¢¼æª¢æ¸¬é…ç½®
      detection: {
        minSize: 0.1,
        maxSize: 0.9,
        minScore: 0.5
      }
    };
    
    // iOSç‰¹æ®Šé…ç½®
    if (isIOS) {
      config.inputStream.constraints = {
        facingMode: "environment",
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 }
      };
      // iOSéœ€è¦æ›´ç°¡å–®çš„é…ç½®
      delete config.inputStream.constraints.focusDistance;
      delete config.inputStream.constraints.exposureCompensation;
    }
    
    await Quagga.init(config, function(err) {
      if (err) {
        throw new Error('æ¢ç¢¼æƒæå™¨åˆå§‹åŒ–å¤±æ•—: ' + err);
      }
      
      // é–‹å§‹æƒæ
      Quagga.start();
      
      // ç›£è½æƒæçµæœ
      Quagga.onDetected(function(result) {
        if (!scannerActive) return;
        
        const code = result.codeResult.code;
        console.log('æƒæåˆ°æ¢ç¢¼:', code);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç™¼ç¥¨è™Ÿç¢¼æ ¼å¼
        if (isValidReceiptNumber(code)) {
          handleScanSuccess(code);
        } else {
          // å˜—è©¦å¾æ¢ç¢¼ä¸­æå–ç™¼ç¥¨è™Ÿç¢¼
          const extractedNumber = extractReceiptNumber(code);
          if (extractedNumber) {
            handleScanSuccess(extractedNumber);
          } else {
            showScanError('æƒæåˆ°çš„æ¢ç¢¼ä¸æ˜¯æœ‰æ•ˆçš„ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼');
          }
        }
      });
      
      // ç›£è½æƒæé€²åº¦
      Quagga.onProcessed(function(result) {
        if (result && result.codeResult) {
          // å¯ä»¥æ·»åŠ æƒæé€²åº¦æŒ‡ç¤º
          updateScanProgress(result.codeResult);
        }
      });
      
      // æ·»åŠ æƒæé€²åº¦æŒ‡ç¤º
      showScanProgress();
    });
    
  } catch (error) {
    console.error('æ¢ç¢¼æƒæå™¨å•Ÿå‹•å¤±æ•—:', error);
    showScanError('æ¢ç¢¼æƒæå™¨å•Ÿå‹•å¤±æ•—: ' + error.message);
  }
}

// å¾æ¢ç¢¼ä¸­æå–ç™¼ç¥¨è™Ÿç¢¼
function extractReceiptNumber(code) {
  // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
  const numbers = code.replace(/\D/g, '');
  
  // æª¢æŸ¥æ˜¯å¦åŒ…å«8ä½æ•¸å­—
  const match = numbers.match(/\d{8}/);
  if (match) {
    return match[0];
  }
  
  // å¦‚æœæ²’æœ‰8ä½æ•¸å­—ï¼Œå˜—è©¦å…¶ä»–æ ¼å¼
  if (numbers.length >= 8) {
    return numbers.slice(-8); // å–æœ€å¾Œ8ä½
  }
  
  return null;
}

// æ›´æ–°æƒæé€²åº¦
function updateScanProgress(codeResult) {
  const progress = document.getElementById('scanProgress');
  if (progress) {
    const confidence = Math.round(codeResult.decodedCodes * 100 / codeResult.codeResult.decodedCodes);
    progress.innerHTML = `ğŸ” æ­£åœ¨æƒæ... (ä¿¡å¿ƒåº¦: ${confidence}%)`;
  }
}

// é¡¯ç¤ºæƒæé€²åº¦
function showScanProgress() {
  const progressDiv = document.createElement('div');
  progressDiv.id = 'scanProgress';
  progressDiv.className = 'fixed top-32 right-4 bg-blue-500 text-white px-3 py-1 rounded-lg text-sm z-50';
  progressDiv.innerHTML = 'ğŸ” æ­£åœ¨æƒæ...';
  document.body.appendChild(progressDiv);
  
  // 3ç§’å¾Œè‡ªå‹•éš±è—
  setTimeout(() => {
    const progress = document.getElementById('scanProgress');
    if (progress) progress.remove();
  }, 3000);
}

// æ·»åŠ å°ç„¦æ§åˆ¶æŒ‰éˆ•
function addFocusControls() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å°ç„¦æ§åˆ¶æŒ‰éˆ•
  if (document.getElementById('focusControls')) {
    return;
  }
  
  const focusControls = document.createElement('div');
  focusControls.id = 'focusControls';
  focusControls.className = 'absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10';
  focusControls.innerHTML = `
    <button onclick="triggerAutoFocus()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 transition">
      ğŸ” è‡ªå‹•å°ç„¦
    </button>
    <button onclick="toggleManualFocus()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600 transition">
      ğŸ“ æ‰‹å‹•å°ç„¦
    </button>
    <button onclick="resetFocus()" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition">
      ğŸ”„ é‡ç½®
    </button>
  `;
  
  cameraContainer.appendChild(focusControls);
}

// è§¸ç™¼è‡ªå‹•å°ç„¦
async function triggerAutoFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    const settings = videoTrack.getSettings();
    
    // æª¢æŸ¥æ˜¯å¦æ”¯æ´å°ç„¦æ§åˆ¶
    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'continuous' }]
      });
      showFocusFeedback('è‡ªå‹•å°ç„¦å·²å•Ÿå‹•');
    } else if (capabilities.focusDistance) {
      // å˜—è©¦æ‰‹å‹•å°ç„¦åˆ°è¿‘è·é›¢
      await videoTrack.applyConstraints({
        advanced: [{ focusDistance: 0.1 }]
      });
      showFocusFeedback('æ‰‹å‹•å°ç„¦å·²èª¿æ•´');
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´å°ç„¦æ§åˆ¶');
    }
  } catch (error) {
    console.error('å°ç„¦æ§åˆ¶å¤±æ•—:', error);
    showFocusFeedback('å°ç„¦æ§åˆ¶å¤±æ•—');
  }
}

// åˆ‡æ›æ‰‹å‹•å°ç„¦
async function toggleManualFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: 'manual' }]
      });
      showFocusFeedback('æ‰‹å‹•å°ç„¦æ¨¡å¼å·²å•Ÿç”¨');
      
      // æ·»åŠ æ‰‹å‹•å°ç„¦æ»‘æ¡¿
      addManualFocusSlider();
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´æ‰‹å‹•å°ç„¦');
    }
  } catch (error) {
    console.error('æ‰‹å‹•å°ç„¦åˆ‡æ›å¤±æ•—:', error);
    showFocusFeedback('æ‰‹å‹•å°ç„¦åˆ‡æ›å¤±æ•—');
  }
}

// æ·»åŠ æ‰‹å‹•å°ç„¦æ»‘æ¡¿
function addManualFocusSlider() {
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ»‘æ¡¿
  if (document.getElementById('manualFocusSlider')) {
    return;
  }
  
  const sliderContainer = document.createElement('div');
  sliderContainer.id = 'manualFocusSlider';
  sliderContainer.className = 'absolute bottom-16 left-4 right-4 bg-black bg-opacity-50 p-3 rounded-lg';
  sliderContainer.innerHTML = `
    <div class="text-white text-sm mb-2">æ‰‹å‹•å°ç„¦è·é›¢</div>
    <input type="range" id="focusDistanceSlider" min="0.1" max="1.0" step="0.1" value="0.3" 
           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
    <div class="flex justify-between text-xs text-white mt-1">
      <span>è¿‘</span>
      <span>é </span>
    </div>
  `;
  
  cameraContainer.appendChild(sliderContainer);
  
  // ç¶å®šæ»‘æ¡¿äº‹ä»¶
  const slider = document.getElementById('focusDistanceSlider');
  slider.addEventListener('input', async (e) => {
    const focusDistance = parseFloat(e.target.value);
    await setManualFocusDistance(focusDistance);
  });
}

// è¨­ç½®æ‰‹å‹•å°ç„¦è·é›¢
async function setManualFocusDistance(distance) {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    await videoTrack.applyConstraints({
      advanced: [{ focusDistance: distance }]
    });
  } catch (error) {
    console.error('è¨­ç½®å°ç„¦è·é›¢å¤±æ•—:', error);
  }
}

// é‡ç½®å°ç„¦
async function resetFocus() {
  try {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    // é‡ç½®ç‚ºè‡ªå‹•å°ç„¦
    await videoTrack.applyConstraints({
      advanced: [{ focusMode: 'continuous' }]
    });
    
    // ç§»é™¤æ‰‹å‹•å°ç„¦æ»‘æ¡¿
    const slider = document.getElementById('manualFocusSlider');
    if (slider) {
      slider.remove();
    }
    
    showFocusFeedback('å°ç„¦å·²é‡ç½®');
  } catch (error) {
    console.error('é‡ç½®å°ç„¦å¤±æ•—:', error);
    showFocusFeedback('é‡ç½®å°ç„¦å¤±æ•—');
  }
}

// æ·»åŠ è§¸æ§å°ç„¦åŠŸèƒ½
function addTouchFocus() {
  const video = document.getElementById('video');
  const cameraContainer = document.getElementById('cameraContainer');
  
  // æ·»åŠ è§¸æ§å°ç„¦äº‹ä»¶
  cameraContainer.addEventListener('click', async (e) => {
    if (!mediaStream) return;
    
    const videoTrack = mediaStream.getVideoTracks()[0];
    if (!videoTrack) return;
    
    const capabilities = videoTrack.getCapabilities();
    
    // æª¢æŸ¥æ˜¯å¦æ”¯æ´è§¸æ§å°ç„¦
    if (capabilities.focusMode && capabilities.focusMode.includes('manual')) {
      try {
        // è¨ˆç®—é»æ“Šä½ç½®ç›¸å°æ–¼è¦–é »çš„æ¯”ä¾‹
        const rect = video.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        // è¨­ç½®å°ç„¦é»
        await videoTrack.applyConstraints({
          advanced: [
            { focusMode: 'manual' },
            { pointsOfInterest: [{ x: x, y: y }] }
          ]
        });
        
        // é¡¯ç¤ºå°ç„¦æŒ‡ç¤ºå™¨
        showFocusIndicator(e.clientX, e.clientY);
        showFocusFeedback('è§¸æ§å°ç„¦å·²è¨­ç½®');
        
      } catch (error) {
        console.error('è§¸æ§å°ç„¦å¤±æ•—:', error);
        showFocusFeedback('è§¸æ§å°ç„¦å¤±æ•—');
      }
    } else {
      showFocusFeedback('æ­¤è¨­å‚™ä¸æ”¯æ´è§¸æ§å°ç„¦');
    }
  });
  
  // æ·»åŠ é›™æ“Šé‡ç½®å°ç„¦
  cameraContainer.addEventListener('dblclick', async () => {
    await resetFocus();
  });
}

// é¡¯ç¤ºå°ç„¦æŒ‡ç¤ºå™¨
function showFocusIndicator(x, y) {
  // ç§»é™¤ç¾æœ‰çš„æŒ‡ç¤ºå™¨
  const existingIndicator = document.getElementById('focusIndicator');
  if (existingIndicator) {
    existingIndicator.remove();
  }
  
  const indicator = document.createElement('div');
  indicator.id = 'focusIndicator';
  indicator.className = 'fixed w-8 h-8 border-2 border-white rounded-full pointer-events-none z-50';
  indicator.style.left = (x - 16) + 'px';
  indicator.style.top = (y - 16) + 'px';
  indicator.style.animation = 'focusIndicatorPulse 1s ease-out forwards';
  
  document.body.appendChild(indicator);
  
  // 1ç§’å¾Œç§»é™¤æŒ‡ç¤ºå™¨
  setTimeout(() => {
    if (indicator.parentNode) {
      indicator.remove();
    }
  }, 1000);
}

// é¡¯ç¤ºå°ç„¦åé¥‹
function showFocusFeedback(message) {
  const feedback = document.createElement('div');
  feedback.className = 'fixed top-40 right-4 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm z-50';
  feedback.textContent = message;
  document.body.appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 2000);
}

// åœæ­¢ç›¸æ©Ÿæƒæ
function stopCameraScan() {
  scannerActive = false;
  
  // åœæ­¢Quaggaæƒæå™¨
  if (typeof Quagga !== 'undefined' && Quagga) {
    Quagga.stop();
  }
  
  // åœæ­¢ç›¸æ©Ÿæµ
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  
  // ç§»é™¤å°ç„¦æ§åˆ¶æŒ‰éˆ•
  const focusControls = document.getElementById('focusControls');
  if (focusControls) {
    focusControls.remove();
  }
  
  // ç§»é™¤æ‰‹å‹•å°ç„¦æ»‘æ¡¿
  const manualSlider = document.getElementById('manualFocusSlider');
  if (manualSlider) {
    manualSlider.remove();
  }
  
  // ç§»é™¤å°ç„¦æŒ‡ç¤ºå™¨
  const focusIndicator = document.getElementById('focusIndicator');
  if (focusIndicator) {
    focusIndicator.remove();
  }
  
  // ç§»é™¤æƒæé€²åº¦æŒ‡ç¤º
  const progress = document.getElementById('scanProgress');
  if (progress) progress.remove();
  
  // ç§»é™¤è§¸æ§å°ç„¦äº‹ä»¶ç›£è½å™¨
  const cameraContainer = document.getElementById('cameraContainer');
  if (cameraContainer) {
    // å…‹éš†å…ƒç´ ä¾†ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
    const newContainer = cameraContainer.cloneNode(true);
    cameraContainer.parentNode.replaceChild(newContainer, cameraContainer);
  }
  
  document.getElementById('cameraContainer').style.display = 'none';
}

// æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ç™¼ç¥¨è™Ÿç¢¼
function isValidReceiptNumber(code) {
  // ç™¼ç¥¨è™Ÿç¢¼é€šå¸¸æ˜¯8ä½æ•¸å­—
  return /^\d{8}$/.test(code);
}

// è™•ç†æƒææˆåŠŸ
function handleScanSuccess(number) {
  showScanResult(number);
  stopCameraScan();
  
  // è‡ªå‹•å¡«å…¥ç™¼ç¥¨è™Ÿç¢¼ä¸¦å°ç
  setTimeout(() => {
    document.getElementById('receiptNumber').value = number;
  closeScanner();
  checkReceipt();
  }, 2000);
}


// å°çåŠŸèƒ½
function checkReceipt() {
  const inputNumber = document.getElementById('receiptNumber').value.trim();
  
  if (inputNumber.length !== 8 || !/^\d{8}$/.test(inputNumber)) {
    alert('è«‹è¼¸å…¥8ä½æ•¸çš„ç™¼ç¥¨è™Ÿç¢¼');
    return;
  }

  // æª¢æŸ¥é–‹çè™Ÿç¢¼æ˜¯å¦å·²è¼‰å…¥
  if (!winningNumbers.special || !winningNumbers.grand || winningNumbers.first.length === 0) {
    alert('é–‹çè™Ÿç¢¼å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é»æ“Šåˆ·æ–°æŒ‰éˆ•');
    return;
  }

  let result = '';
  let isWinner = false;
  let prize = '';
  let prizeLevel = '';

  // æª¢æŸ¥ç‰¹åˆ¥ç
  if (inputNumber === winningNumbers.special) {
    result = 'ğŸŠ æ­å–œï¼æ‚¨ä¸­äº†ç‰¹åˆ¥çï¼';
    prize = 'çé‡‘ 1,000è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ç‰¹åˆ¥ç';
  }
  // æª¢æŸ¥ç‰¹ç
  else if (inputNumber === winningNumbers.grand) {
    result = 'ğŸŠ æ­å–œï¼æ‚¨ä¸­äº†ç‰¹çï¼';
    prize = 'çé‡‘ 200è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ç‰¹ç';
  }
  // æª¢æŸ¥é ­ç
  else if (winningNumbers.first.some(num => inputNumber === num)) {
    result = 'ğŸ¥‡ æ­å–œï¼æ‚¨ä¸­äº†é ­çï¼';
    prize = 'çé‡‘ 20è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'é ­ç';
  }
  // æª¢æŸ¥äºŒç (æœ«7ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(1) === num.slice(1))) {
    result = 'ğŸ¥ˆ æ­å–œï¼æ‚¨ä¸­äº†äºŒçï¼';
    prize = 'çé‡‘ 4è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'äºŒç';
  }
  // æª¢æŸ¥ä¸‰ç (æœ«6ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(2) === num.slice(2))) {
    result = 'ğŸ¥‰ æ­å–œï¼æ‚¨ä¸­äº†ä¸‰çï¼';
    prize = 'çé‡‘ 1è¬å…ƒ';
    isWinner = true;
    prizeLevel = 'ä¸‰ç';
  }
  // æª¢æŸ¥å››ç (æœ«5ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(3) === num.slice(3))) {
    result = 'ğŸ… æ­å–œï¼æ‚¨ä¸­äº†å››çï¼';
    prize = 'çé‡‘ 4åƒå…ƒ';
    isWinner = true;
    prizeLevel = 'å››ç';
  }
  // æª¢æŸ¥äº”ç (æœ«4ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(4) === num.slice(4))) {
    result = 'ğŸ–ï¸ æ­å–œï¼æ‚¨ä¸­äº†äº”çï¼';
    prize = 'çé‡‘ 1åƒå…ƒ';
    isWinner = true;
    prizeLevel = 'äº”ç';
  }
  // æª¢æŸ¥å…­ç (æœ«3ç¢¼)
  else if (winningNumbers.first.some(num => inputNumber.slice(5) === num.slice(5)) ||
           (winningNumbers.additional && winningNumbers.additional.includes(inputNumber.slice(5)))) {
    result = 'ğŸ—ï¸ æ­å–œï¼æ‚¨ä¸­äº†å…­çï¼';
    prize = 'çé‡‘ 2ç™¾å…ƒ';
    isWinner = true;
    prizeLevel = 'å…­ç';
  }
  // æœªä¸­ç
  else {
    result = 'ğŸ˜” å¾ˆéºæ†¾ï¼Œé€™å¼µç™¼ç¥¨æ²’æœ‰ä¸­ç';
    prize = 'å†æ¥å†å²ï¼';
    prizeLevel = 'æœªä¸­ç';
  }

  // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
  addToHistory(inputNumber, isWinner, prizeLevel, prize);

  // é¡¯ç¤ºçµæœ
  const resultSection = document.getElementById('resultSection');
  const resultContent = document.getElementById('resultContent');
  
  // æ›´æ¸…æ¥šçš„çµæœé¡¯ç¤º
  const resultClass = isWinner ? 'bg-gradient-to-r from-green-400 to-green-600 text-white' : 'bg-gradient-to-r from-gray-400 to-gray-600 text-white';
  const icon = isWinner ? 'ğŸ‰' : 'ğŸ˜”';
  const bgPattern = isWinner ? 'bg-green-50' : 'bg-gray-50';
  
  resultContent.innerHTML = `
    <div class="${bgPattern} p-6 rounded-xl border-2 ${isWinner ? 'border-green-200' : 'border-gray-200'}">
      <div class="text-center">
        <div class="text-6xl mb-4">${icon}</div>
        <div class="text-3xl font-bold mb-3 ${isWinner ? 'text-green-600' : 'text-gray-600'}">${result}</div>
        <div class="text-2xl font-mono font-bold mb-3 bg-white px-4 py-2 rounded-lg shadow-inner">${inputNumber}</div>
        <div class="text-xl font-semibold mb-2 ${isWinner ? 'text-green-700' : 'text-gray-700'}">${prize}</div>
        ${winningNumbers.period ? `<div class="text-sm text-gray-500 mt-2">æœŸåˆ¥ï¼š${winningNumbers.period}</div>` : ''}
        
        ${isWinner ? `
          <div class="mt-4 p-3 bg-yellow-100 rounded-lg">
            <div class="text-sm text-yellow-800 font-semibold">ğŸ é ˜çæé†’</div>
            <div class="text-xs text-yellow-700 mt-1">è«‹æ–¼ 115å¹´1æœˆ5æ—¥å‰ è‡³è¶…å•†æˆ–éƒµå±€é ˜ç</div>
          </div>
        ` : `
          <div class="mt-4 p-3 bg-blue-100 rounded-lg">
            <div class="text-sm text-blue-800 font-semibold">ğŸ’¡ å°è²¼å£«</div>
            <div class="text-xs text-blue-700 mt-1">ä½¿ç”¨é›²ç«¯ç™¼ç¥¨å¯è‡ªå‹•å°çï¼Œä¸­çæœƒä¸»å‹•é€šçŸ¥</div>
          </div>
        `}
      </div>
    </div>
  `;
  
  resultSection.style.display = 'block';
  resultSection.scrollIntoView({ behavior: 'smooth' });
  
  // æ·»åŠ å‹•ç•«æ•ˆæœ
  setTimeout(() => {
    resultContent.style.transform = 'scale(1.02)';
    setTimeout(() => {
      resultContent.style.transform = 'scale(1)';
    }, 200);
  }, 100);
}

// æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
function addToHistory(number, isWinner, level, prize) {
  const historyItem = {
    number: number,
    isWinner: isWinner,
    level: level,
    prize: prize,
    date: new Date().toLocaleString('zh-TW')
  };
  
  history.unshift(historyItem);
  if (history.length > 20) {
    history = history.slice(0, 20); // åªä¿ç•™æœ€è¿‘20ç­†
  }
  
  localStorage.setItem('receiptHistory', JSON.stringify(history));
  updateHistoryDisplay();
}

// æ›´æ–°æ­·å²è¨˜éŒ„é¡¯ç¤º
function updateHistoryDisplay() {
  const historyList = document.getElementById('historyList');
  const historyCount = document.getElementById('historyCount');
  
  historyCount.textContent = `${history.length} ç­†è¨˜éŒ„`;
  
  if (history.length === 0) {
    historyList.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-2">ğŸ“</div>
        <div>é‚„æ²’æœ‰å°çè¨˜éŒ„</div>
        <div class="text-sm opacity-70 mt-1">é–‹å§‹å°çå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
      </div>
    `;
  } else {
    historyList.innerHTML = history.map(item => `
      <div class="history-item ${item.isWinner ? 'winner' : 'loser'}">
        <div class="flex justify-between items-center">
          <div>
            <div class="font-mono font-semibold">${item.number}</div>
            <div class="text-sm text-gray-600">${item.level} - ${item.prize}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">${item.date}</div>
            <div class="text-lg">${item.isWinner ? 'ğŸ‰' : 'ğŸ˜”'}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// æ¸…é™¤æ­·å²è¨˜éŒ„
function clearHistory() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°çæ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
    history = [];
    localStorage.removeItem('receiptHistory');
    updateHistoryDisplay();
  }
}

// è¼¸å…¥é™åˆ¶ï¼šåªå…è¨±æ•¸å­—
document.getElementById('receiptNumber').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// æŒ‰Enteréµå°ç
document.getElementById('receiptNumber').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkReceipt();
  }
});

// æœ«ä¸‰ç¢¼å¿«é€Ÿæª¢æŸ¥åŠŸèƒ½
function quickCheckLastThree() {
  const input = document.getElementById('lastThreeDigits').value.trim();
  const resultDiv = document.getElementById('quickCheckResult');
  
  if (input.length !== 3 || !/^\d{3}$/.test(input)) {
    resultDiv.innerHTML = '<span class="text-red-600">è«‹è¼¸å…¥3ä½æ•¸å­—</span>';
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦èˆ‡ä»»ä½•é–‹çè™Ÿç¢¼çš„æœ«ä¸‰ç¢¼åŒ¹é…
  const lastThree = input;
  let matches = [];
  
  // æª¢æŸ¥ç‰¹åˆ¥ç
  if (winningNumbers.special && winningNumbers.special.slice(-3) === lastThree) {
    matches.push('ç‰¹åˆ¥ç');
  }
  
  // æª¢æŸ¥ç‰¹ç
  if (winningNumbers.grand && winningNumbers.grand.slice(-3) === lastThree) {
    matches.push('ç‰¹ç');
  }
  
  // æª¢æŸ¥é ­ç
  if (winningNumbers.first) {
    winningNumbers.first.forEach((num, index) => {
      if (num.slice(-3) === lastThree) {
        matches.push(`é ­ç${index + 1}`);
      }
    });
  }
  
  // æª¢æŸ¥å¢é–‹å…­ç
  if (winningNumbers.additional && winningNumbers.additional.includes(lastThree)) {
    matches.push('å¢é–‹å…­ç');
  }
  
  if (matches.length > 0) {
    resultDiv.innerHTML = `<span class="text-green-600 font-semibold">ğŸ‰ å¯èƒ½ä¸­çï¼åŒ¹é…ï¼š${matches.join('ã€')}</span>`;
  } else {
    resultDiv.innerHTML = '<span class="text-gray-600">ğŸ˜” æœªæ‰¾åˆ°åŒ¹é…çš„æœ«ä¸‰ç¢¼</span>';
  }
}

// åˆ†äº«çµæœåŠŸèƒ½
function shareResult() {
  const resultContent = document.getElementById('resultContent');
  const resultText = resultContent.textContent || resultContent.innerText;
  
  if (navigator.share) {
    navigator.share({
      title: 'ç™¼ç¥¨å°ççµæœ',
      text: resultText,
      url: window.location.href
    }).catch(err => console.log('åˆ†äº«å¤±æ•—:', err));
  } else {
    // è¤‡è£½åˆ°å‰ªè²¼æ¿
    copyToClipboard(resultText);
    showMessage('çµæœå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
  }
}

// è¤‡è£½çµæœåŠŸèƒ½
function copyResult() {
  const resultContent = document.getElementById('resultContent');
  const resultText = resultContent.textContent || resultContent.innerText;
  copyToClipboard(resultText);
  showMessage('çµæœå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
}

// è¤‡è£½åˆ°å‰ªè²¼æ¿
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text);
  } else {
    // å‚™ç”¨æ–¹æ¡ˆ
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  }
}

// é¡¯ç¤ºè¨Šæ¯
function showMessage(message) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  messageDiv.textContent = message;
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    messageDiv.remove();
  }, 3000);
}

// æœ«ä¸‰ç¢¼è¼¸å…¥é™åˆ¶
document.getElementById('lastThreeDigits').addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// é›²ç«¯ç™¼ç¥¨APPä¸‹è¼‰
function openCloudInvoiceApp() {
  const userAgent = navigator.userAgent.toLowerCase();
  let appUrl = '';
  
  if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
    appUrl = 'https://apps.apple.com/tw/app/çµ±ä¸€ç™¼ç¥¨å…Œç/id1448254128';
  } else if (userAgent.includes('android')) {
    appUrl = 'https://play.google.com/store/apps/details?id=tw.gov.einvoice';
  } else {
    appUrl = 'https://www.einvoice.nat.gov.tw/';
  }
  
  window.open(appUrl, '_blank');
}

// é¡¯ç¤ºé›²ç«¯ç™¼ç¥¨æŒ‡å—
function showCloudInvoiceGuide() {
  const guide = document.getElementById('cloudGuide');
  if (guide.style.display === 'none') {
    guide.style.display = 'block';
    guide.scrollIntoView({ behavior: 'smooth' });
  } else {
    guide.style.display = 'none';
  }
}

// æ¸…é™¤è¼¸å…¥
function clearInput() {
  document.getElementById('receiptNumber').value = '';
  document.getElementById('lastThreeDigits').value = '';
  document.getElementById('quickCheckResult').innerHTML = '';
  document.getElementById('resultSection').style.display = 'none';
  
  // èšç„¦åˆ°è¼¸å…¥æ¡†
  document.getElementById('receiptNumber').focus();
}

// é¡¯ç¤ºå¿«é€Ÿå°è²¼å£«
function showQuickTips() {
  const tips = [
    'ğŸ’¡ å…ˆæª¢æŸ¥æœ«ä¸‰ç¢¼ï¼Œå¿«é€Ÿç¯©é¸å¯èƒ½ä¸­ççš„ç™¼ç¥¨',
    'ğŸ“± ä½¿ç”¨é›²ç«¯ç™¼ç¥¨å¯è‡ªå‹•å°çï¼Œä¸­çæœƒä¸»å‹•é€šçŸ¥',
    'ğŸ¯ æ¯æœŸé–‹çå¾Œè¨˜å¾—æª¢æŸ¥æ‰€æœ‰ç™¼ç¥¨',
    'ğŸ’° çé‡‘è¶…é1,000å…ƒéœ€æ‰£ç¹³æ‰€å¾—ç¨…',
    'â° è¨˜å¾—åœ¨é ˜çæœŸé™å…§é ˜çï¼Œé€¾æœŸè¦–åŒæ”¾æ£„'
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  showMessage(randomTip);
}

// ç¹¼çºŒå°ç
function checkAnother() {
  clearInput();
  document.getElementById('receiptNumber').focus();
}

// æŸ¥çœ‹æ­·å²
function viewHistory() {
  const historySection = document.querySelector('section:has(#historyList)');
  if (historySection) {
    historySection.scrollIntoView({ behavior: 'smooth' });
    // è‡ªå‹•å±•é–‹æ­·å²è¨˜éŒ„
    toggleHistory(true);
  }
}

// åˆ‡æ›æ­·å²è¨˜éŒ„é¡¯ç¤º
function toggleHistory(forceOpen = false) {
  const historyContent = document.getElementById('historyContent');
  const toggleIcon = document.getElementById('historyToggleIcon');
  const toggleText = document.getElementById('historyToggleText');
  
  const isCurrentlyOpen = historyContent.style.display !== 'none';
  const shouldOpen = forceOpen || !isCurrentlyOpen;
  
  if (shouldOpen) {
    historyContent.style.display = 'block';
    toggleIcon.textContent = 'ğŸ“';
    toggleText.textContent = 'æ”¶åˆ';
    
    // æ·»åŠ å±•é–‹å‹•ç•«
    historyContent.style.opacity = '0';
    historyContent.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      historyContent.style.transition = 'all 0.3s ease';
      historyContent.style.opacity = '1';
      historyContent.style.transform = 'translateY(0)';
    }, 10);
  } else {
    // æ·»åŠ æ”¶åˆå‹•ç•«
    historyContent.style.transition = 'all 0.3s ease';
    historyContent.style.opacity = '0';
    historyContent.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      historyContent.style.display = 'none';
      historyContent.style.transition = '';
    }, 300);
    
    toggleIcon.textContent = 'ğŸ“‚';
    toggleText.textContent = 'å±•é–‹';
  }
}

// åˆ·æ–°é–‹çè™Ÿç¢¼
async function refreshWinningNumbers() {
  await fetchLatestWinningNumbers();
}

// å¾æœ¬åœ°å„²å­˜è¼‰å…¥é–‹çè™Ÿç¢¼
function loadWinningNumbersFromStorage() {
  const stored = localStorage.getItem('winningNumbers');
  if (stored) {
    try {
      const data = JSON.parse(stored);
      updateWinningNumbers(data);
    } catch (error) {
      console.error('è¼‰å…¥æœ¬åœ°é–‹çè™Ÿç¢¼å¤±æ•—:', error);
    }
  }
}

// æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é–‹çè™Ÿç¢¼
function shouldUpdateWinningNumbers() {
  const stored = localStorage.getItem('winningNumbers');
  if (!stored) return true;
  
  try {
    const data = JSON.parse(stored);
    const lastUpdate = new Date(data.updateTime);
    const now = new Date();
    const minutesDiff = (now - lastUpdate) / (1000 * 60);
    
    // æª¢æŸ¥ç¶²çµ¡ç‹€æ…‹
    if (navigator.onLine === false) {
      console.log('é›¢ç·šæ¨¡å¼ï¼Œä½¿ç”¨ç·©å­˜æ•¸æ“š');
      return false;
    }
    
    // å¦‚æœè¶…é15åˆ†é˜å°±æ›´æ–°ï¼ˆæ›´é »ç¹çš„æ›´æ–°ï¼‰
    return minutesDiff > 15;
  } catch (error) {
    return true;
  }
}

// ç¶²çµ¡ç‹€æ…‹ç›£è½
function setupNetworkMonitoring() {
  window.addEventListener('online', () => {
    console.log('ç¶²çµ¡å·²é€£æ¥ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é–‹çè™Ÿç¢¼');
    if (shouldUpdateWinningNumbers()) {
      fetchLatestWinningNumbers();
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('ç¶²çµ¡å·²æ–·é–‹ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼');
    showOfflineMessage();
  });
}

// é¡¯ç¤ºé›¢ç·šè¨Šæ¯
function showOfflineMessage() {
  const offlineIndicator = document.createElement('div');
  offlineIndicator.id = 'offlineIndicator';
  offlineIndicator.className = 'fixed top-4 left-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  offlineIndicator.innerHTML = 'ğŸ“± é›¢ç·šæ¨¡å¼ - ä½¿ç”¨ç·©å­˜æ•¸æ“š';
  document.body.appendChild(offlineIndicator);
  
  // 5ç§’å¾Œè‡ªå‹•éš±è—
  setTimeout(() => {
    const indicator = document.getElementById('offlineIndicator');
    if (indicator) indicator.remove();
  }, 5000);
}

// é é¢åˆå§‹åŒ–
async function initializePage() {
  try {
    // è¨­ç½®ç¶²çµ¡ç›£è½
    setupNetworkMonitoring();
    
    // è¼‰å…¥æœ¬åœ°å„²å­˜çš„é–‹çè™Ÿç¢¼
    loadWinningNumbersFromStorage();
    
    // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
    if (shouldUpdateWinningNumbers()) {
      await fetchLatestWinningNumbers();
    }

    // åˆå§‹åŒ–æ­·å²è¨˜éŒ„é¡¯ç¤º
    updateHistoryDisplay();
    
    // è¨­ç½®å®šæ™‚æ›´æ–°
    setupAutoUpdate();
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    showSuccessMessage('ç™¼ç¥¨å°çç³»çµ±å·²æº–å‚™å°±ç·’');
    
  } catch (error) {
    console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
    showErrorMessage('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
  }
}

// è¨­ç½®è‡ªå‹•æ›´æ–°
function setupAutoUpdate() {
  // æ¯15åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ›´æ–°
  setInterval(async () => {
    if (shouldUpdateWinningNumbers()) {
      console.log('å®šæ™‚æª¢æŸ¥ï¼šå˜—è©¦æ›´æ–°é–‹çè™Ÿç¢¼');
      await fetchLatestWinningNumbers();
    }
  }, 15 * 60 * 1000); // 15åˆ†é˜
  
  // æ¯åˆ†é˜æ›´æ–°æ™‚é–“é¡¯ç¤º
  setInterval(() => {
    updateLastUpdateTime();
  }, 60 * 1000); // 1åˆ†é˜
}

// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
function showSuccessMessage(message) {
  const successIndicator = document.createElement('div');
  successIndicator.className = 'fixed top-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  successIndicator.innerHTML = `âœ… ${message}`;
  document.body.appendChild(successIndicator);
  
  setTimeout(() => {
    successIndicator.remove();
  }, 3000);
}

// åˆå§‹åŒ–æ­·å²è¨˜éŒ„é¡¯ç¤º
updateHistoryDisplay();

// è¨»å†ŠService Workeræ”¯æŒé›¢ç·šåŠŸèƒ½
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializePage);

// æ·»åŠ é é¢å¯è¦‹æ€§ç›£è½ï¼Œç•¶é é¢é‡æ–°å¯è¦‹æ™‚æª¢æŸ¥æ›´æ–°
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && shouldUpdateWinningNumbers()) {
    fetchLatestWinningNumbers();
  }
});
</script>
</body>
</html>
